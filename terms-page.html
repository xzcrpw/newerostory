<!DOCTYPE html>
<!-- Додано x-data та :lang -->
<html lang="uk" x-data :lang="$store.i18n.selectedLang">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Title використовує i18n -->
  <title x-text="`${$store.i18n.t('policyPages.termsTitle')} — ${$store.i18n.t('general.copyright')}`"></title>

  <!-- Оновлені мета-теги з обробкою помилок -->
  <meta name="description" :content="
    (() => {
      try {
        return $store.i18n.t('policyPages.termsMetaDescription') || 'Правила та умови використання сайту Таємний Світ. Ознайомтеся з вимогами до контенту, правами та обов\'язками користувачів нашої платформи.';
      } catch (e) {
        return 'Правила та умови використання сайту Таємний Світ. Ознайомтеся з вимогами до контенту, правами та обов\'язками користувачів нашої платформи.';
      }
    })()
  ">
  <meta property="og:title" :content="`${$store.i18n.t('policyPages.termsTitle')} — ${$store.i18n.t('general.copyright')}`">
  <meta property="og:description" :content="$store.i18n.t('policyPages.termsMetaDescription') || 'Правила та умови використання сайту Таємний Світ.'">
  <meta property="og:type" content="website">

  <!-- Стилі -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/terms-page.css"> <!-- Використовуємо ці стилі -->

  <!-- API Config & Utils -->
  <script src="js/api-config.js" defer></script>
  <script src="js/api-utils.js" defer></script>

  <!-- Internationalization -->
  <script type="module" src="js/i18n.js" defer></script> <!-- Важливо: type="module" -->

  <!-- Шрифти -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Стилі для кнопки нагору -->
  <style>
    .back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--accent);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .back-to-top.visible {
      opacity: 0.7;
      visibility: visible;
    }
    
    .back-to-top:hover {
      opacity: 1;
      background-color: var(--accent-hover);
    }
    
    @media (max-width: 768px) {
      .back-to-top {
        bottom: 15px;
        right: 15px;
        width: 35px;
        height: 35px;
      }
    }
  </style>

  <!-- Стилі для пропуску до вмісту -->
  <style>
    .skip-to-content {
      position: absolute;
      top: -40px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 1001;
      transition: top 0.3s;
    }
    
    .skip-to-content:focus-within {
      top: 0;
    }
    
    .skip-to-content a {
      background: var(--accent);
      color: white;
      padding: 10px 20px;
      display: inline-block;
      text-decoration: none;
      border-radius: 0 0 5px 5px;
    }
  </style>
</head>
<!-- Додаємо безпечну функцію доступу до перекладів -->
<body x-data="{ 
  isLoggedIn: false,
  isPremiumUser: false,
  
  // Допоміжна функція для безпечного доступу до i18n
  safeT(key, params = {}, fallback = '') {
    try {
      if ($store && $store.i18n && typeof $store.i18n.t === 'function') {
        const translation = $store.i18n.t(key, params);
        return (translation && translation !== key) ? translation : fallback;
      }
      return fallback;
    } catch (e) {
      console.warn(`Translation error for key: ${key}`, e);
      return fallback;
    }
  },
  
  // Додаємо функцію плавного скролу до розділів
  scrollToSection(id) {
    const element = document.getElementById(id);
    if (element) {
      element.scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    }
  }
}" x-init="
  try {
    isLoggedIn = api.utils.isAuthenticated();
    isPremiumUser = api.utils.isPremium();
  } catch (error) {
    console.error('Auth check error:', error);
    isLoggedIn = false;
    isPremiumUser = false;
  }
  
  // Функція для налаштування доступності
  $nextTick(() => {
    try {
      // Додаємо атрибути ARIA до розділів для кращої доступності
      const sections = document.querySelectorAll('.section');
      sections.forEach(section => {
        const titleElement = section.querySelector('.section-title');
        if (titleElement && !section.getAttribute('aria-labelledby') && titleElement.id) {
          section.setAttribute('aria-labelledby', titleElement.id);
        }
      });
    } catch (error) {
      console.warn('Accessibility setup error:', error);
    }
  });
">

<!-- Покращення доступності -->
<div id="skipToContent" class="skip-to-content">
  <a href="#general" @click.prevent="scrollToSection('general')" x-text="safeT('general.skipToContent', {}, 'Перейти до вмісту')"></a>
</div>

<!-- Хедер -->
<header>
  <div class="container">
    <nav class="navbar">
      <a href="index.html" class="logo">Таємний<span>Світ</span></a>
      <!-- Навігація з i18n -->
      <ul class="nav-links">
        <li><a href="index.html" x-text="$store.i18n.t('general.home')"></a></li>
        <li><a href="new-stories.html" x-text="$store.i18n.t('general.newStories')"></a></li>
        <li><a href="top-stories.html" x-text="$store.i18n.t('general.topStories')"></a></li>
        <li><a href="categories.html" x-text="$store.i18n.t('general.categories')"></a></li>
        <li><a href="authors.html" x-text="$store.i18n.t('general.authors')"></a></li>
      </ul>
      <div class="auth-buttons">
        <!-- Покращений мовний перемикач з обробкою помилок -->
        <div class="lang-dropdown-container" x-data="{ open: false }" @click.away="open = false">
          <div class="lang-dropdown-button" @click="open = !open">
            <span x-text="$store.i18n?.selectedLang?.toUpperCase() || 'UK'"></span>
            <i class="fas fa-chevron-down" :class="{ 'rotate-180': open }"></i>
          </div>
          <div class="lang-dropdown-menu" x-show="open" x-transition>
            <template x-for="lang in $store.i18n?.available || []" :key="lang.code">
              <div class="lang-dropdown-item"
                   :class="{ 'active': lang.code === $store.i18n?.selectedLang }"
                   @click="try { $store.i18n.setLanguage(lang.code); open = false; } catch(e) { console.error('Language switch error:', e); open = false; }">
                <span x-text="lang.name"></span>
                <i x-show="lang.code === $store.i18n?.selectedLang" class="fas fa-check"></i>
              </div>
            </template>
          </div>
        </div>
        <!-- Кнопки авторизації -->
        <template x-if="!isLoggedIn">
          <div>
            <a href="login.html" class="btn btn-outline"> <i class="fas fa-sign-in-alt"></i> <span x-text="$store.i18n.t('general.login')"></span> </a>
            <a href="register-page.html" class="btn btn-primary"> <i class="fas fa-user-plus"></i> <span x-text="$store.i18n.t('general.register')"></span> </a>
          </div>
        </template>
        <template x-if="isLoggedIn">
          <div>
            <a href="profile.html" class="btn btn-outline"> <i class="fas fa-user"></i> <span x-text="$store.i18n.t('general.profile')"></span> </a>
            <!-- Безпечний обробник виходу з системи -->
            <a href="#" @click.prevent="
              try { 
                api.auth.logout(); 
                window.location.reload(); 
              } catch (e) { 
                console.error('Logout error:', e);
                alert(safeT('general.logoutError', {}, 'Помилка при виході з системи'));
              }
            " class="btn btn-primary">
              <i class="fas fa-sign-out-alt"></i> <span x-text="safeT('general.logout', {}, 'Вийти')"></span>
            </a>
          </div>
        </template>
      </div>
    </nav>
  </div>
</header>

<!-- Основний контент -->
<main>
  <div class="container">
    <!-- Хлібні крихти з безпечним доступом до перекладів -->
    <div class="breadcrumbs">
      <a href="index.html" x-text="safeT('general.home', {}, 'Головна')"></a>
      <span class="separator">/</span>
      <span class="current" x-text="safeT('policyPages.termsTitle', {}, 'Правила та умови використання')"></span>
    </div>

    <div class="terms-container">
      <!-- Заголовок -->
      <div class="terms-header">
        <h1 class="terms-title" x-text="$store.i18n.t('policyPages.termsTitle')"></h1>
        <p class="terms-description" x-text="$store.i18n.t('policyPages.termsDescription')"></p>
        <!-- Дата оновлення може бути статичною або динамічною -->
        <span class="last-updated" x-text="`${$store.i18n.t('policyPages.lastUpdated')}: 12 березня 2025 р.`"></span>
      </div>

      <!-- Оновлена навігація з плавним скролом -->
      <nav class="terms-navigation">
        <a href="#general" @click.prevent="scrollToSection('general')" x-text="safeT('policyPages.termsNavGeneral', {}, 'Загальні положення')"></a>
        <a href="#content" @click.prevent="scrollToSection('content')" x-text="safeT('policyPages.termsNavContent', {}, 'Контент')"></a>
        <a href="#restrictions" @click.prevent="scrollToSection('restrictions')" x-text="safeT('policyPages.termsNavRestrictions', {}, 'Обмеження')"></a>
        <a href="#premium" @click.prevent="scrollToSection('premium')" x-text="safeT('policyPages.termsNavPremium', {}, 'Преміум')"></a>
        <a href="#account" @click.prevent="scrollToSection('account')" x-text="safeT('policyPages.termsNavAccount', {}, 'Обліковий запис')"></a>
        <a href="#disclaimer" @click.prevent="scrollToSection('disclaimer')" x-text="safeT('policyPages.termsNavDisclaimer', {}, 'Відмова від відповідальності')"></a>
        <a href="#changes" @click.prevent="scrollToSection('changes')" x-text="safeT('policyPages.termsNavChanges', {}, 'Зміни')"></a>
        <a href="#contact" @click.prevent="scrollToSection('contact')" x-text="safeT('policyPages.termsNavContact', {}, 'Зв\'язок')"></a>
      </nav>

      <!-- Зміст правил (використовуємо ключі i18n для кожного параграфа/пункту) -->
      <div class="terms-content">
        <section id="general" class="section" aria-labelledby="general-title">
          <h2 id="general-title" class="section-title" x-text="safeT('policyPages.termsSection1Title', {}, 'Загальні положення')"></h2>
          <div class="subsection" x-data="{ expanded: true }">
            <h3 class="subsection-title" @click="expanded = !expanded" :class="{ 'collapsed': !expanded }">
              <span x-text="safeT('policyPages.termsSection1_1Title', {}, 'Прийняття умов')"></span>
              <span class="toggle-icon"><i :class="expanded ? 'fas fa-minus' : 'fas fa-plus'"></i></span>
            </h3>
            <div x-show="expanded" x-transition>
              <p x-text="safeT('policyPages.termsSection1_1Text', {}, 'Використовуючи цей веб-сайт, ви погоджуєтесь дотримуватися цих умов. Якщо ви не згодні з будь-якою частиною цих умов, будь ласка, не використовуйте наш веб-сайт.')"></p>
            </div>
          </div>
          <div class="subsection">
            <h3 class="subsection-title" x-text="$store.i18n.t('policyPages.termsSection1_2Title')"></h3>
            <p x-text="$store.i18n.t('policyPages.termsSection1_2Text')"></p>
          </div>
          <div class="subsection">
            <h3 class="subsection-title" x-text="$store.i18n.t('policyPages.termsSection1_3Title')"></h3>
            <p x-text="$store.i18n.t('policyPages.termsSection1_3Text')"></p>
          </div>
        </section>

        <section id="content" class="section">
          <h2 class="section-title" x-text="$store.i18n.t('policyPages.termsSection2Title')"></h2>
          <div class="subsection">
            <h3 class="subsection-title" x-text="$store.i18n.t('policyPages.termsSection2_1Title')"></h3>
            <p x-text="$store.i18n.t('policyPages.termsSection2_1Text')"></p>
          </div>
          <div class="subsection">
            <h3 class="subsection-title" x-text="$store.i18n.t('policyPages.termsSection2_2Title')"></h3>
            <p x-text="$store.i18n.t('policyPages.termsSection2_2Text')"></p>
          </div>
        </section>

        <section id="restrictions" class="section">
          <h2 class="section-title" x-text="$store.i18n.t('policyPages.termsSection3Title')"></h2>
          <p x-text="$store.i18n.t('policyPages.termsSection3Intro')"></p>
          <ul>
            <li x-text="$store.i18n.t('policyPages.termsRestriction1')"></li>
            <li x-text="$store.i18n.t('policyPages.termsRestriction2')"></li>
            <li x-text="$store.i18n.t('policyPages.termsRestriction3')"></li>
            <li x-text="$store.i18n.t('policyPages.termsRestriction4')"></li>
            <li x-text="$store.i18n.t('policyPages.termsRestriction5')"></li>
          </ul>
          <div class="warning-box">
            <div class="warning-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="warning-content">
              <p x-text="$store.i18n.t('policyPages.termsRestrictionWarning')"></p>
            </div>
          </div>
        </section>

        <section id="premium" class="section">
          <h2 class="section-title" x-text="$store.i18n.t('policyPages.termsSection4Title')"></h2>
          <p x-text="$store.i18n.t('policyPages.termsSection4Text1')"></p>
          <p x-html="$store.i18n.t('policyPages.termsSection4Text2', { link: `<a href='premium.html'>${$store.i18n.t('general.premium')}</a>` })"></p>
          <p x-text="$store.i18n.t('policyPages.termsSection4Text3')"></p>
        </section>

        <section id="account" class="section">
          <h2 class="section-title" x-text="$store.i18n.t('policyPages.termsSection5Title')"></h2>
          <p x-text="$store.i18n.t('policyPages.termsSection5Text1')"></p>
          <p x-text="$store.i18n.t('policyPages.termsSection5Text2')"></p>
        </section>

        <section id="disclaimer" class="section">
          <h2 class="section-title" x-text="$store.i18n.t('policyPages.termsSection6Title')"></h2>
          <p x-text="$store.i18n.t('policyPages.termsSection6Text')"></p>
        </section>

        <section id="changes" class="section">
          <h2 class="section-title" x-text="$store.i18n.t('policyPages.termsSection7Title')"></h2>
          <p x-text="$store.i18n.t('policyPages.termsSection7Text')"></p>
        </section>

        <section id="contact" class="section">
          <h2 class="section-title" x-text="$store.i18n.t('policyPages.termsSection8Title')"></h2>
          <p x-html="$store.i18n.t('policyPages.termsSection8Text', { link: `<a href='contact.html'>${$store.i18n.t('contact.title')}</a>` })"></p>
        </section>
      </div>

      <!-- Додаємо кнопку для збереження PDF -->
      <div class="terms-actions">
        <button onclick="alert('Функція завантаження PDF буде доступна незабаром. Наразі ви можете використати функцію друку браузера (Ctrl+P / Cmd+P)')" class="btn btn-outline">
          <i class="fas fa-file-pdf"></i> <span x-text="safeT('policyPages.downloadPdf', {}, 'Завантажити PDF')"></span>
        </button>
        <button @click="window.print()" class="btn btn-outline">
          <i class="fas fa-print"></i> <span x-text="safeT('policyPages.printPage', {}, 'Надрукувати')"></span>
        </button>
      </div>

      <!-- Стилі для контейнера з кнопками -->
      <style>
        .terms-actions {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 2rem;
          margin-bottom: 1rem;
        }
        
        /* Стилі для друку */
        @media print {
          header, footer, .breadcrumbs, .terms-actions, .terms-navigation, #back-to-top {
            display: none !important;
          }
          
          .terms-content {
            font-size: 12pt;
          }
          
          .terms-title {
            font-size: 18pt;
          }
          
          .section-title {
            font-size: 14pt;
          }
        }
      </style>

      <!-- Стилі для згортання/розгортання -->
      <style>
        .subsection-title {
          position: relative;
          cursor: pointer;
          padding-right: 30px;
        }
        
        .toggle-icon {
          position: absolute;
          right: 0;
          top: 50%;
          transform: translateY(-50%);
        }
        
        @media (min-width: 768px) {
          .subsection-title {
            cursor: default;
          }
          
          .toggle-icon {
            display: none;
          }
        }
      </style>

      <!-- Футер сторінки -->
      <div class="terms-footer">
        <p x-text="$store.i18n.t('policyPages.footerText')"></p>
        <a href="index.html" class="btn btn-outline" x-text="$store.i18n.t('policyPages.backToHomeButton')"></a>
      </div>
    </div>
  </div>
</main>

<!-- Додаємо кнопку для прокрутки нагору -->
<button id="back-to-top" 
        @click="window.scrollTo({ top: 0, behavior: 'smooth' })"
        x-data 
        x-init="
          window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
              $el.classList.add('visible');
            } else {
              $el.classList.remove('visible');
            }
          })
        "
        aria-label="На початок сторінки"
        title="На початок сторінки"
        class="back-to-top">
  <i class="fas fa-arrow-up"></i>
</button>

<!-- Додаємо скрипт для відстеження активного розділу -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Отримуємо всі розділи
  const sections = document.querySelectorAll('.section');
  const navLinks = document.querySelectorAll('.terms-navigation a');
  
  // Функція для підсвічування активного пункту навігації
  function highlightActiveSection() {
    // Відступ для раннього підсвічування
    const scrollPosition = window.scrollY + 100;
    
    // Перевіряємо кожен розділ
    sections.forEach(section => {
      const sectionTop = section.offsetTop;
      const sectionHeight = section.offsetHeight;
      const sectionId = section.getAttribute('id');
      
      // Якщо поточна позиція скролу знаходиться в межах розділу
      if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
        // Знімаємо активний клас з усіх посилань
        navLinks.forEach(link => link.classList.remove('active'));
        
        // Додаємо активний клас відповідному посиланню
        const activeLink = document.querySelector(`.terms-navigation a[href="#${sectionId}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }
    });
  }
  
  // Додаємо стилі для активного пункту навігації
  const style = document.createElement('style');
  style.textContent = `
    .terms-navigation a.active {
      color: var(--accent);
      font-weight: 600;
      position: relative;
    }
    
    .terms-navigation a.active::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: var(--accent);
    }
  `;
  document.head.appendChild(style);
  
  // Слухаємо подію скролу
  window.addEventListener('scroll', highlightActiveSection);
  
  // Запускаємо один раз для ініціалізації
  highlightActiveSection();
});
</script>

<!-- Footer -->
<footer>
  <div class="container">
    <!-- Код футера з i18n, як в index.html -->
    <div class="footer-content">
      <div class="footer-section footer-about">
        <h4 x-text="$store.i18n.t('general.about')"></h4>
        <p x-text="$store.i18n.t('general.aboutText')"></p>
        <!-- Виправлені посилання соціальних мереж -->
        <div class="social-links">
          <a href="#" class="social-link" 
             :title="safeT('general.shareFacebook', {}, 'Поділитися у Facebook')" 
             @click.prevent="
               try {
                 window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, 'facebook-share', 'width=580,height=520');
                 return false;
               } catch (e) {
                 console.error('Share error:', e);
               }
             ">
            <i class="fab fa-facebook-f"></i>
          </a>
          <a href="#" class="social-link" 
             :title="safeT('general.shareTelegram', {}, 'Поділитися у Telegram')"
             @click.prevent="
               try {
                 window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(document.title)}`, 'telegram-share', 'width=580,height=520');
                 return false;
               } catch (e) {
                 console.error('Share error:', e);
               }
             ">
            <i class="fab fa-telegram-plane"></i>
          </a>
          <a href="#" class="social-link" 
             title="Instagram"
             @click.prevent="alert('Instagram sharing coming soon')">
            <i class="fab fa-instagram"></i>
          </a>
        </div>
      </div>
      <div class="footer-section">
        <h4 x-text="$store.i18n.t('general.navigation')"></h4>
        <ul>
          <li><a href="index.html" x-text="$store.i18n.t('general.home')"></a></li>
          <li><a href="categories.html" x-text="$store.i18n.t('general.categories')"></a></li>
          <li><a href="new-stories.html" x-text="$store.i18n.t('general.newStories')"></a></li>
          <li><a href="top-stories.html" x-text="$store.i18n.t('general.topStories')"></a></li>
          <li><a href="authors.html" x-text="$store.i18n.t('general.authors')"></a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4 x-text="$store.i18n.t('general.support')"></h4>
        <ul>
          <li><a href="faq.html" x-text="$store.i18n.t('faq.title')"></a></li>
          <li><a href="contact.html" x-text="$store.i18n.t('contact.title')"></a></li>
          <li><a href="terms-page.html" x-text="$store.i18n.t('general.terms')"></a></li>
          <li><a href="privacy-policy.html" x-text="$store.i18n.t('general.privacy')"></a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4 x-text="$store.i18n.t('general.join')"></h4>
        <ul>
          <li><a href="login.html" x-text="safeT('general.login', {}, 'Увійти')"></a></li>
          <li><a href="login.html?tab=register" x-text="safeT('general.register', {}, 'Зареєструватися')"></a></li>
          <li><a href="premium.html" x-text="safeT('general.premium', {}, 'Преміум')"></a></li>
          <li><a href="create_story.html" x-text="safeT('createStory.title', {}, 'Створити історію')"></a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      © <span x-text="new Date().getFullYear()"></span> <span x-text="$store.i18n.t('general.copyright')"></span>. <span x-text="$store.i18n.t('general.allRightsReserved')"></span>. 18+ <br>
      <a href="terms-page.html" x-text="$store.i18n.t('general.terms')"></a> | <a href="privacy-policy.html" x-text="$store.i18n.t('general.privacy')"></a>
    </div>
  </div>
</footer>

</body>
</html>