<!DOCTYPE html>
<html lang="uk" x-data="{
    // --- Стани UI ---
    isLoggedIn: false,
    isPremiumUser: false,
    isLoadingCategory: true,
    isLoadingStories: true,
    categoryError: null,
    storiesError: null,
    currentFilter: 'all', // 'all', 'premium', 'free'
    currentSort: 'newest', // 'newest', 'popular', 'rated', 'commented'
    showFilters: false,
    currentPage: 1,
    totalPages: 1,
    totalStories: 0,
    notificationVisible: false,
    notificationMessage: '',
    notificationType: 'success', // 'success' or 'error'
    notificationTimeout: null,
    processingFavorite: false, // Індикатор для кнопки Favorite
    processingSubscribe: false, // Індикатор для кнопки Subscribe

    // --- Дані ---
    categorySlug: null,
    category: null, // { _id, name, slug, description, imageUrl, stats: { storyCount, views, likes } }
    stories: [], // { _id, title, imageUrl, isPremium, ageRestriction, averageRating, createdAt, content(excerpt), views, commentsCount, readingTime, author: { _id, name, avatarUrl }, category: { name, slug } }
    isFavoriteCategory: false,
    isSubscribedCategory: false,

    // --- Мапа сортувань ---
    sortOptionsMap: {
        newest: '-createdAt',
        popular: '-views',
        rated: '-averageRating',
        commented: '-commentsCount'
    },

    // --- Обчислювані властивості ---
    get pageTitle() {
         if (this.isLoadingCategory) return `${this.safeT('general.loading', {}, 'Завантаження...')} — ${this.safeT('general.copyright', {}, 'Таємний Світ')}`;
         if (this.categoryError) return `${this.safeT('general.error', {}, 'Помилка')} — ${this.safeT('general.copyright', {}, 'Таємний Світ')}`;
         return `${this.category?.name || this.safeT('categoryPage.unknownCategory', {}, 'Невідома категорія')} — ${this.safeT('general.copyright', {}, 'Таємний Світ')}`;
    },
    get pageDescription() {
         if (this.category) return `${this.safeT('categoryPage.metaDescription', { categoryName: this.category.name }, '')} ${this.category.description || ''}`.substring(0, 160);
         return this.safeT('general.loading', {}, 'Завантаження...');
    },

    // --- Безпечний доступ до i18n ---
    safeT(key, params = {}, fallback = '') {
        try {
            if (typeof $store !== 'undefined' && $store.i18n?.initialized) {
                const translation = $store.i18n.t(key, params);
                return (translation && translation !== key && translation.trim() !== '') ? translation : fallback;
            }
            if (Object.keys(params).length > 0 && typeof fallback === 'string') {
                return Object.keys(params).reduce((str, pKey) => str.replace(new RegExp(`\\{${pKey}\\}`, 'g'), params[pKey]), fallback);
            }
            return fallback;
        } catch (error) { console.warn(`safeT error for key: ${key}`, error); return fallback; }
    },

    // --- Сповіщення ---
    showNotification(message, isSuccess = true) {
        this.notificationMessage = message;
        this.notificationType = isSuccess ? 'success' : 'error';
        const notificationElement = document.getElementById('global-notification');
        if (notificationElement) {
            notificationElement.classList.remove('success', 'error');
            notificationElement.classList.add(this.notificationType);
            notificationElement.classList.add('show');
        }
        this.notificationVisible = true;
        if (this.notificationTimeout) clearTimeout(this.notificationTimeout);
        this.notificationTimeout = setTimeout(() => {
            this.notificationVisible = false;
            const el = document.getElementById('global-notification');
            if (el) el.classList.remove('show');
        }, 4000);
    },

    // --- Завантаження даних ---
    async fetchCategoryData() {
        this.isLoadingCategory = true; this.categoryError = null;
        this.categorySlug = new URLSearchParams(window.location.search).get('slug');
        if (!this.categorySlug) {
            this.categoryError = this.safeT('categoryPage.slugNotFound', 'Slug категорії не знайдено в URL.');
            this.isLoadingCategory = false; return;
        }
        try {
            console.log(`API CALL: api.categories.getCategoryBySlug(${this.categorySlug}, { lang: $store.i18n.selectedLang })`);
            const response = await api.categories.getCategoryBySlug(this.categorySlug, { lang: $store.i18n.selectedLang || 'uk' });
            if (!response?.data) throw new Error(this.safeT('categoryPage.categoryNotFound'));
            this.category = response.data;
            this.updateMetaTags(); // Оновлюємо мета-теги
            if (this.isLoggedIn) await this.fetchCategoryStatus();
        } catch (error) {
            this.categoryError = error.message || this.safeT('categoryPage.errorLoadingCategory');
            console.error('Category fetch error:', error);
        } finally { this.isLoadingCategory = false; }
    },
    async fetchCategoryStatus() {
         if (!this.isLoggedIn || !this.categorySlug) return;
         try {
              console.log(`API CALL: api.categories.getCategoryStatus(${this.categorySlug})`);
              const response = await api.categories.getCategoryStatus(this.categorySlug);
              this.isFavoriteCategory = response.data?.isFavorite || false;
              this.isSubscribedCategory = response.data?.isSubscribed || false;
         } catch (error) { console.warn('Failed to fetch category status:', error); }
    },
    async fetchStories() {
        if (this.isLoadingCategory || this.categoryError || !this.categorySlug) { this.isLoadingStories = false; return; }
        this.isLoadingStories = true; this.storiesError = null;
        try {
            const params = {
                page: this.currentPage, limit: 6,
                sort: this.sortOptionsMap[this.currentSort] || '-createdAt',
                lang: $store.i18n.selectedLang || 'uk'
            };
            if (this.currentFilter === 'premium') params.isPremium = true;
            else if (this.currentFilter === 'free') params.isPremium = false;

            console.log(`API CALL: api.stories.getStories for category ${this.categorySlug}`, params);
            const response = await api.stories.getStories({ ...params, category: this.categorySlug });

            this.stories = (response.data || []).map(story => ({
                ...story,
                excerpt: (story.excerpt || story.content || '').replace(/<[^>]*>?/gm, '').substring(0, 120),
                authorName: story.author?.name || this.safeT('general.anonymous'),
                authorAvatar: story.author?.avatarUrl || 'https://source.unsplash.com/random/50x50/?profile,placeholder',
                imageUrlSafe: story.imageUrl || `https://source.unsplash.com/random/300x400/?story,${story._id || story.id}`
                // categoryName та categorySlug тепер мають бути вже в об'єкті story завдяки populate на бекенді
            }));
            this.currentPage = response.pagination?.currentPage || 1;
            this.totalPages = response.pagination?.totalPages || 1;
            this.totalStories = response.pagination?.totalResults || 0;

            if (this.currentPage > this.totalPages && this.totalPages > 0) { this.currentPage = this.totalPages; setTimeout(() => this.fetchStories(), 50); return; }
            this.$nextTick(() => this.initCardAnimation());

        } catch (error) {
            this.storiesError = error.message || this.safeT('categoryPage.errorLoadingStories');
            console.error('Stories fetch error:', error);
            if (this.stories.length === 0 && this.currentPage > 1) { this.currentPage--; this.storiesError = null; await this.fetchStories(); }
        } finally { this.isLoadingStories = false; }
    },

    // --- Оновлення мета-тегів ---
    updateMetaTags() {
        if (!this.category) return;
        const title = `${this.category.name} — ${this.safeT('general.copyright')}`;
        const description = `${this.safeT('categoryPage.metaDescription', { categoryName: this.category.name })} ${this.category.description || ''}`.substring(0, 160);
        document.title = title;
        document.querySelector('meta[name=\'description\']')?.setAttribute('content', description);
        document.querySelector('meta[property=\'og:title\']')?.setAttribute('content', title);
        document.querySelector('meta[property=\'og:description\']')?.setAttribute('content', description);
        document.querySelector('meta[property=\'og:image\']')?.setAttribute('content', this.category.imageUrl || 'https://source.unsplash.com/random/1200x630/?abstract');
    },

    // --- Керування фільтрами/сортуванням/пагінацією ---
    toggleFilters() { this.showFilters = !this.showFilters; },
    setFilter(filter) { if (this.isLoadingStories || this.currentFilter === filter) return; this.currentFilter = filter; this.currentPage = 1; this.fetchStories(); },
    setSort(sort) { if (this.isLoadingStories || this.currentSort === sort) { this.showFilters = false; return; } this.currentSort = sort; this.showFilters = false; this.currentPage = 1; this.fetchStories(); },
    nextPage() { if (this.isLoadingStories || this.currentPage >= this.totalPages) return; this.currentPage++; this.fetchStories(); this.$nextTick(() => { document.getElementById('stories-list-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }); },
    prevPage() { if (this.isLoadingStories || this.currentPage <= 1) return; this.currentPage--; this.fetchStories(); this.$nextTick(() => { document.getElementById('stories-list-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }); },

    // --- Дії з категорією ---
    async toggleFavoriteCategory(event) {
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        if (!this.categorySlug || !this.category || this.processingFavorite) return;
        this.processingFavorite = true; const button = event?.currentTarget;
        const originalState = this.isFavoriteCategory;
        const originalLikes = this.category.stats?.likes || 0; // Припускаємо, що це лічильник обраного
this.isFavoriteCategory = !this.isFavoriteCategory;
// Оновлюємо лічильник оптимістично (якщо він є)
if (this.category.stats && typeof this.category.stats.likes === 'number') {
this.category.stats.likes += this.isFavoriteCategory ? 1 : -1;
this.category.stats.likes = Math.max(0, this.category.stats.likes); // Не може бути менше 0
}

try {
console.log('API CALL: api.categories.toggleFavorite', this.categorySlug);
await api.categories.toggleFavorite(this.categorySlug);
this.showNotification(this.isFavoriteCategory ? this.safeT('notifications.categoryAddedToFavorites') : this.safeT('notifications.categoryRemovedFromFavorites'), true);
} catch (error) {
this.isFavoriteCategory = originalState; // Відкат UI
if (this.category.stats && typeof this.category.stats.likes === 'number') this.category.stats.likes = originalLikes; // Відкат лічильника
this.showNotification(this.safeT('categoryPage.errorToggleFavorite') + ': ' + (error.message || this.safeT('general.unknownError')), false);
console.error('Toggle favorite category error:', error);
} finally { this.processingFavorite = false; }
},
async toggleSubscribeCategory(event) {
if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
if (!this.categorySlug || this.processingSubscribe) return;
this.processingSubscribe = true; const button = event?.currentTarget;
const originalState = this.isSubscribedCategory;
this.isSubscribedCategory = !this.isSubscribedCategory;
try {
console.log('API CALL: api.categories.subscribeCategory', this.categorySlug);
await api.categories.subscribeCategory(this.categorySlug);
this.showNotification(this.isSubscribedCategory ? this.safeT('notifications.subscribedToCategory') : this.safeT('notifications.unsubscribedFromCategory'), true);
} catch (error) {
this.isSubscribedCategory = originalState; // Відкат UI
this.showNotification(this.safeT('categoryPage.errorToggleSubscription') + ': ' + (error.message || this.safeT('general.unknownError')), false);
console.error('Toggle subscribe category error:', error);
} finally { this.processingSubscribe = false; }
},

// --- Анімація ---
initCardAnimation() {
try {
if (!('IntersectionObserver' in window)) { this.$el.querySelectorAll('.story-item').forEach(card => card.classList.add('visible')); return; }
// Використовуємо різні обсервери, щоб не змішувати
if (this.storyCardObserver) this.storyCardObserver.disconnect();
this.storyCardObserver = new IntersectionObserver((entries) => {
entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); this.storyCardObserver.unobserve(entry.target); } });
}, { threshold: 0.1 });
this.$nextTick(() => { this.$el.querySelectorAll('.story-item:not(.visible)').forEach(card => this.storyCardObserver.observe(card)); });
} catch(e) { console.warn('Intersection Observer error:', e); document.querySelectorAll('.story-item').forEach(card => card.classList.add('visible')); }
},

// --- Форматування зірок ---
formatStars(rating) {
if (!rating || isNaN(rating)) return '';
const full = Math.floor(rating); const half = rating % 1 >= 0.5; const empty = 5 - full - (half ? 1 : 0);
return '<i class=\'fas fa-star\'></i>'.repeat(full) + (half ? '<i class=\'fas fa-star-half-alt\'></i>' : '') + '<i class=\'far fa-star\'></i>'.repeat(empty);
},
// --- Метод для виходу ---
async logoutUser() {
try {
console.log('Attempting logout...');
if (typeof api !== 'undefined' && api.auth && typeof api.auth.logout === 'function') {
api.auth.logout();
this.isLoggedIn = false; this.isPremiumUser = false;
this.isFavoriteCategory = false; this.isSubscribedCategory = false; // Скидаємо статуси категорії
this.showNotification(this.safeT('notifications.logoutSuccess', {}, 'Вихід успішний!'), true);
// Оновлюємо історії, бо преміум-статус міг змінитися
this.fetchStories();
} else { throw new Error('API logout function is not available.'); }
} catch (error) {
console.error('Logout error:', error);
this.showNotification(this.safeT('auth.logoutError', {}, 'Помилка при виході з системи.'), false);
}
},
// --- Ініціалізація ---
async initializePage() {
let waitCount = 0;
while ((typeof api === 'undefined' || typeof $store === 'undefined' || !$store.i18n?.initialized) && waitCount < 50) {
await new Promise(resolve => setTimeout(resolve, 100)); waitCount++;
}
if (typeof api === 'undefined' || typeof $store === 'undefined' || !$store.i18n?.initialized) {
console.error('API or i18n failed to initialize!');
this.categoryError = 'Помилка завантаження сторінки. Спробуйте оновити.';
this.isLoadingCategory = false; this.isLoadingStories = false; return;
}
try {
this.isLoggedIn = api.utils.isAuthenticated();
this.isPremiumUser = api.utils.isPremium();
} catch(e) { console.error('Auth check error:', e); this.isLoggedIn = false; this.isPremiumUser = false; }

await this.fetchCategoryData();
if (!this.categoryError) {
await this.fetchStories();
} else {
this.isLoadingStories = false; // Не завантажуємо історії, якщо помилка категорії
}
// Відслідковуємо зміни мови
$watch('$store.i18n.selectedLang', (newLang, oldLang) => {
if (newLang !== oldLang) {
console.log(`Language changed to ${newLang}. Refetching data for category page.`);
this.fetchCategoryData().then(() => {
if (!this.categoryError) this.fetchStories();
});
}
});
}

}" x-init="initializePage()" :lang="$store.i18n.selectedLang">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title x-text="pageTitle"></title>
  <meta name="description" :content="pageDescription">
  <meta property="og:title" :content="pageTitle">
  <meta property="og:description" :content="pageDescription">
  <meta property="og:image" :content="category?.imageUrl || 'https://source.unsplash.com/random/1200x630/?abstract'">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <script type="module" src="js/i18n.js" defer></script>
  <script src="js/api-config.js" defer></script>
  <script src="js/api-utils.js" defer></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/category-page.css">
  <style>
    .loading-indicator { text-align: center; padding: 2rem; color: var(--secondary-text); }
    .error-message { background-color: rgba(255, 50, 50, 0.1); border: 1px solid rgba(255, 50, 50, 0.3); border-radius: var(--border-radius); padding: 1rem; margin: 1.5rem 0; color: #ff6b6b; font-size: 0.9rem; display: flex; align-items: center; }
    .error-message i { margin-right: 8px; }
    .error-message button { margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem; }
    .empty-state { text-align: center; padding: 3rem; background-color: var(--card-color); border-radius: var(--border-radius); margin: 2rem 0; color: var(--secondary-text); }
    .story-item { opacity: 0; transform: translateY(20px); transition: opacity 0.5s, transform 0.5s; }
    .story-item.visible { opacity: 1; transform: translateY(0); }
    .notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%) translateY(150%); background-color: var(--card-color); color: var(--text-color); padding: 1rem 1.5rem; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); z-index: 1050; opacity: 0; transition: opacity 0.3s ease-out, transform 0.4s ease-out; min-width: 250px; max-width: 90%; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); border-left-width: 4px; pointer-events: none; }
    .notification.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
    .notification.success { border-left-color: #4cd964; }
    .notification.error { border-left-color: #ff6b6b; }
    button.removing { opacity: 0.7; pointer-events: none; position: relative; }
    button.removing > span { visibility: hidden; }
    button.removing::after { content: '\f110'; font-family: 'Font Awesome 6 Free'; font-weight: 900; display: inline-block; animation: spin 1s linear infinite; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 1em; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .filters-loading-indicator { display: flex; align-items: center; justify-content: center; padding: 1rem; color: var(--secondary-text); font-style: italic; font-size: 0.9rem; }
    .filters-loading-indicator i { margin-right: 8px; }
    .filter-btn.active, .sort-option.active { background-color: rgba(153, 0, 0, 0.2); border-color: rgba(153, 0, 0, 0.3); color: var(--text-color); font-weight: 500; }
    .premium-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(10, 5, 7, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .story-item:hover .premium-overlay { opacity: 1; pointer-events: auto; }
    .premium-content { text-align: center; padding: 2rem; }
    .premium-content i.fa-crown { font-size: 2.5rem; color: var(--premium-gold); margin-bottom: 1rem; }
    .premium-text { font-size: 1.5rem; font-family: 'Cormorant Garamond', serif; margin-bottom: 1.5rem; color: var(--premium-gold); }
    .btn-premium { display: inline-flex; align-items: center; justify-content: center; padding: 0.8rem 1.5rem; border-radius: var(--button-radius); text-decoration: none; font-weight: 600; background: linear-gradient(135deg, var(--premium-gold) 0%, var(--premium-gold-dark) 100%); color: #000; transition: transform 0.3s, box-shadow 0.3s; border: none; }
    .btn-premium:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(var(--accent-gold-rgb), 0.3); text-decoration: none; }
    .btn-premium:focus-visible { outline: 2px solid var(--premium-gold-light); outline-offset: 2px; box-shadow: 0 0 0 3px rgba(var(--accent-gold-rgb), 0.4); }
    .back-to-top { position: fixed; bottom: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background-color: var(--accent-red); color: white; border: none; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.3s ease; cursor: pointer; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .back-to-top.visible { opacity: 0.8; visibility: visible; }
    .back-to-top:hover { opacity: 1; background-color: var(--accent-burgundy); }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body x-cloak> <!-- Додано x-cloak -->

<!-- Хедер -->
<header>
  <div class="container">
    <nav class="navbar">
      <a href="index.html" class="logo" aria-label="На головну">
        <span x-text="safeT('general.siteNamePart1', 'Таємний')"></span><span style="color: var(--accent-red);" x-text="safeT('general.siteNamePart2', 'Світ')"></span>
      </a>
      <ul class="nav-links">
        <li><a href="index.html" x-text="safeT('general.home', 'Головна')"></a></li>
        <li><a href="new-stories.html" x-text="safeT('general.newStories', 'Нові історії')"></a></li>
        <li><a href="top-stories.html" x-text="safeT('general.topStories', 'Топ рейтинг')"></a></li>
        <li><a href="categories.html" x-text="safeT('general.categories', 'Категорії')"></a></li>
        <li><a href="authors.html" x-text="safeT('general.authors', 'Автори')"></a></li>
      </ul>
      <div class="auth-buttons">
        <!-- Мовний перемикач -->
        <div class="lang-dropdown-container" x-data="{ open: false }" @click.away="open = false">
          <div class="lang-dropdown-button" @click="open = !open" role="button" aria-haspopup="true" :aria-expanded="open">
            <span x-text="$store?.i18n?.selectedLang?.toUpperCase() || 'UK'"></span>
            <i class="fas fa-chevron-down" :class="{ 'rotate-180': open }" aria-hidden="true"></i>
          </div>
          <template x-if="$store?.i18n">
            <div class="lang-dropdown-menu" x-show="open" x-transition role="menu" aria-orientation="vertical">
              <template x-for="lang in $store.i18n.available || []" :key="lang.code">
                <div class="lang-dropdown-item"
                     :class="{ 'active': lang.code === $store.i18n.selectedLang }"
                     @click="const newLang=lang.code; open=false; try{ $store.i18n.setLanguage(newLang); }catch(e){console.error('Lang switch error',e);}"
                     role="menuitemradio" :aria-checked="lang.code === $store.i18n.selectedLang" tabindex="0"
                     @keydown.enter.space.prevent="const newLang=lang.code; open=false; try{ $store.i18n.setLanguage(newLang); }catch(e){console.error('Lang switch error',e);}">
                  <span x-text="lang.name"></span>
                  <i x-show="lang.code === $store.i18n.selectedLang" class="fas fa-check" aria-hidden="true"></i>
                </div>
              </template>
            </div>
          </template>
        </div>
        <!-- Кнопки авторизації -->
        <template x-if="!isLoggedIn">
          <div>
            <a href="login.html" class="btn btn-outline"> <i class="fas fa-sign-in-alt"></i> <span x-text="safeT('general.login', 'Увійти')"></span> </a>
            <a href="login.html?tab=register" class="btn btn-primary"> <i class="fas fa-user-plus"></i> <span x-text="safeT('general.register', 'Реєстрація')"></span> </a>
          </div>
        </template>
        <template x-if="isLoggedIn">
          <div>
            <a href="profile.html" class="btn btn-outline"> <i class="fas fa-user"></i> <span x-text="safeT('general.profile', 'Профіль')"></span> </a>
            <a href="#" @click.prevent="logoutUser()" class="btn btn-primary">
              <i class="fas fa-sign-out-alt"></i> <span x-text="safeT('general.logout', 'Вийти')"></span>
            </a>
          </div>
        </template>
      </div>
    </nav>
  </div>
</header>

<!-- Основний контент -->
<main class="container">
  <!-- Хлібні крихти -->
  <div class="breadcrumbs">
    <a href="index.html" x-text="safeT('general.home', 'Головна')"></a>
    <span class="separator">/</span>
    <a href="categories.html" x-text="safeT('general.categories', 'Категорії')"></a>
    <span class="separator">/</span>
    <span class="current" x-text="isLoadingCategory ? safeT('general.loading') : (category?.name || safeT('categoryPage.unknownCategory'))"></span>
  </div>

  <!-- Індикатор завантаження категорії -->
  <div x-show="isLoadingCategory" class="loading-indicator" x-text="safeT('categoryPage.loadingCategoryData', 'Завантаження...')"></div>
  <!-- Помилка завантаження категорії -->
  <div x-show="categoryError" class="error-message">
    <i class="fas fa-exclamation-circle"></i> <span x-text="categoryError"></span>
    <button @click="fetchCategoryData()" class="btn btn-outline" x-text="safeT('general.retryButton')"></button>
  </div>

  <!-- Заголовок категорії (якщо завантажено) -->
  <template x-if="category && !isLoadingCategory && !categoryError">
    <div class="category-header">
      <div class="category-background" :style="`background-image: url('${category.imageUrl || 'https://source.unsplash.com/random/1200x400/?abstract'}')`">
        <div class="category-overlay"></div>
      </div>
      <div class="category-content">
        <h1 class="category-title" x-text="category.name"></h1>
        <div class="category-description" x-text="category.description || safeT('general.descriptionMissing')"></div>
        <div class="category-meta">
          <div class="category-stats">
            <div class="category-stat"><i class="fas fa-book"></i> <span x-text="totalStories || category.stats?.storyCount || 0"></span> <span x-text="safeT('general.storiesSuffix')"></span></div>
            <div class="category-stat"><i class="far fa-eye"></i> <span x-text="category.stats?.views || 0"></span> <span x-text="safeT('general.viewsSuffix')"></span></div>
            <div class="category-stat"><i class="far fa-heart"></i> <span x-text="category.stats?.likes || 0"></span> <span x-text="safeT('general.likesSuffix')"></span></div>
          </div>
          <div class="category-actions">
            <button type="button" class="btn btn-outline btn-favorite" @click="toggleFavoriteCategory($event)" :class="{ 'removing': processingFavorite }" :aria-pressed="isFavoriteCategory" :disabled="processingFavorite || !isLoggedIn" :title="!isLoggedIn ? safeT('general.login') : ''">
                             <span x-show="!processingFavorite">
                                <i :class="isFavoriteCategory ? 'fas fa-bookmark' : 'far fa-bookmark'" aria-hidden="true"></i>
                                <span x-text="isFavoriteCategory ? safeT('categoryPage.inFavorites') : safeT('categoryPage.addToFavorites')"></span>
                             </span>
            </button>
            <button type="button" class="btn btn-primary" @click="toggleSubscribeCategory($event)" :class="{ 'removing': processingSubscribe }" :aria-pressed="isSubscribedCategory" :disabled="processingSubscribe || !isLoggedIn" :title="!isLoggedIn ? safeT('general.login') : ''">
                              <span x-show="!processingSubscribe">
                                 <i class="fas fa-rss" aria-hidden="true"></i>
                                 <span x-text="isSubscribedCategory ? safeT('categoryPage.subscribedButton') : safeT('categoryPage.subscribeButton')"></span>
                              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Фільтри і сортування (якщо категорія завантажена) -->
  <div class="filters-section" x-show="category && !isLoadingCategory && !categoryError">
    <div class="filters-container">
      <div class="filters-header" @click="toggleFilters()" role="button" :aria-expanded="showFilters" aria-controls="filter-body">
        <div class="filter-summary">
          <span x-text="safeT('storyLists.showing')"></span>: <span x-text="safeT('categoryPage.filtersTitle.' + currentFilter, {}, currentFilter === 'all' ? 'Всі' : (currentFilter === 'premium' ? 'Преміум' : 'Безкоштовні'))"></span>
          <span class="filter-count" x-text="`(${safeT('general.total')}: ${totalStories} ${safeT('general.storiesSuffix')})`"></span>
        </div>
        <button type="button" class="btn-filter-toggle" :aria-expanded="showFilters" aria-controls="filter-body">
          <i class="fas fa-sliders-h"></i> <span x-text="safeT('categoryPage.filtersToggle')"></span>
          <i :class="showFilters ? 'fa-chevron-up' : 'fa-chevron-down'" class="fas"></i>
        </button>
      </div>
      <div id="filter-body" x-show="showFilters" class="filters-body" x-collapse>
        <div class="filter-group">
          <div class="filter-label" id="filter-type-label" x-text="safeT('categoryPage.filterTypeLabel')"></div>
          <div class="filter-options" role="radiogroup" aria-labelledby="filter-type-label">
            <button type="button" @click="setFilter('all')" :class="{ 'active': currentFilter === 'all' }" class="filter-btn" role="radio" :aria-checked="currentFilter === 'all'" x-text="safeT('categoryPage.filterAll')"></button>
            <button type="button" @click="setFilter('premium')" :class="{ 'active': currentFilter === 'premium' }" class="filter-btn" role="radio" :aria-checked="currentFilter === 'premium'" x-text="safeT('categoryPage.filterPremium')"></button>
            <button type="button" @click="setFilter('free')" :class="{ 'active': currentFilter === 'free' }" class="filter-btn" role="radio" :aria-checked="currentFilter === 'free'" x-text="safeT('categoryPage.filterFree')"></button>
          </div>
        </div>
        <div class="filter-group">
          <div class="filter-label" id="filter-sort-label" x-text="safeT('categoryPage.filterSortLabel')"></div>
          <div class="filter-options" role="radiogroup" aria-labelledby="filter-sort-label">
            <button type="button" @click="setSort('newest')" :class="{ 'active': currentSort === 'newest' }" class="filter-btn" role="radio" :aria-checked="currentSort === 'newest'" x-text="safeT('categoryPage.sortNewest')"></button>
            <button type="button" @click="setSort('popular')" :class="{ 'active': currentSort === 'popular' }" class="filter-btn" role="radio" :aria-checked="currentSort === 'popular'" x-text="safeT('categoryPage.sortPopular')"></button>
            <button type="button" @click="setSort('rated')" :class="{ 'active': currentSort === 'rated' }" class="filter-btn" role="radio" :aria-checked="currentSort === 'rated'" x-text="safeT('categoryPage.sortRating')"></button>
            <button type="button" @click="setSort('commented')" :class="{ 'active': currentSort === 'commented' }" class="filter-btn" role="radio" :aria-checked="currentSort === 'commented'" x-text="safeT('categoryPage.sortCommented')"></button>
          </div>
        </div>
        <div x-show="isLoadingStories" class="filters-loading-indicator">
          <i class="fas fa-spinner fa-spin"></i> <span x-text="safeT('general.loading')"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Секція історій (якщо категорія завантажена) -->
  <section id="stories-list-section" class="stories-list-section" x-show="category && !isLoadingCategory && !categoryError">
    <!-- Початкове завантаження -->
    <div x-show="isLoadingStories && stories.length === 0" class="loading-indicator" x-text="safeT('categoryPage.loadingStories')"></div>
    <div x-show="storiesError && stories.length === 0" class="error-message">
      <i class="fas fa-exclamation-circle"></i> <span x-text="storiesError"></span>
      <button @click="fetchStories()" class="btn btn-outline" x-text="safeT('general.retryButton')"></button>
    </div>

    <!-- Список історій -->
    <div class="stories-list" x-show="!isLoadingStories || stories.length > 0">
      <template x-for="story in stories" :key="story._id || story.id">
        <div class="story-item">
          <a :href="`story-detailed.html?id=${story._id || story.id}`" style="display: contents;" :aria-label="story.title">
            <div class="story-preview">
              <img :src="story.imageUrlSafe" :alt="safeT('storyLists.coverImageAlt', { title: story.title }, `Обкладинка історії ${story.title}`)" loading="lazy">
              <div :class="story.isPremium ? 'story-badge premium-badge' : 'story-badge'" x-text="story.ageRestriction || (story.isPremium ? '21+' : '18+')"></div>
              <div class="story-rating" :aria-label="`${safeT('general.ratingLabel')}: ${(story.averageRating || 0).toFixed(1)}`">
                <i class="fas fa-star"></i> <span x-text="(story.averageRating || 0).toFixed(1)"></span>
              </div>
            </div>
          </a>
          <div class="story-details">
            <div class="story-meta">
              <div class="story-category"><a :href="`category-page.html?slug=${category.slug}`" x-text="category.name || safeT('general.defaultCategory')"></a></div>
              <div class="story-date" x-text="new Date(story.createdAt).toLocaleDateString(safeT('localeCode', 'uk-UA'), { day: 'numeric', month: 'short', year: 'numeric' })"></div>
            </div>
            <h3 class="story-title"> <a :href="`story-detailed.html?id=${story._id || story.id}`" x-text="story.title"></a> </h3>
            <div class="story-excerpt" x-text="story.excerpt + '...'"></div>
            <div class="story-footer">
              <div class="story-stats">
                <div class="story-stat"><i class="far fa-eye"></i> <span x-text="story.views || 0"></span></div>
                <div class="story-stat"><i class="far fa-comment"></i> <span x-text="story.commentsCount || 0"></span></div>
                <div class="story-stat"><i class="far fa-clock"></i> <span x-text="story.readingTime || '?'"></span> <span x-text="safeT('general.readingTimeSuffix')"></span></div>
              </div>
              <div class="story-author">
                <a :href="story.author?._id ? `author-profile.html?id=${story.author._id}` : '#'" style="display: contents;" :aria-label="`${safeT('general.authorLabel')}: ${story.authorName}`">
                  <div class="author-avatar" :style="{ backgroundImage: `url(${story.authorAvatar})` }"></div>
                  <div class="author-name" x-text="story.authorName"></div>
                </a>
              </div>
            </div>
          </div>
          <!-- Преміум оверлей -->
          <template x-if="story.isPremium && !isPremiumUser">
            <div class="premium-overlay">
              <div class="premium-content">
                <i class="fas fa-crown"></i>
                <div class="premium-text" x-text="safeT('general.premium')"></div>
                <a href="premium.html" class="btn btn-premium" x-text="safeT('premium.getPremiumButton')"></a>
              </div>
            </div>
          </template>
        </div>
      </template>
      <!-- Індикатор завантаження в кінці списку -->
      <div x-show="isLoadingStories && stories.length > 0" class="loading-indicator" style="padding: 1rem 0;">
        <i class="fas fa-spinner fa-spin"></i> <span x-text="safeT('general.loading')"></span>
      </div>
    </div>

    <div x-show="!isLoadingStories && stories.length === 0 && !storiesError" class="empty-state">
      <p x-text="safeT('categoryPage.noStoriesFound')"></p>
      <button @click="currentFilter = 'all'; currentSort = 'newest'; currentPage = 1; fetchStories(); showFilters = false;"
              class="btn btn-outline"
              style="margin-top: 1rem;"
              x-show="currentFilter !== 'all' || currentSort !== 'newest'"
              x-text="safeT('storyLists.resetFilters', {}, 'Скинути фільтри')"></button>
    </div>

    <!-- Пагінація -->
    <div class="pagination" x-show="totalPages > 1">
      <button @click="prevPage()" :disabled="currentPage === 1 || isLoadingStories" class="pagination-button prev-button"> <i class="fas fa-chevron-left"></i> <span x-text="safeT('general.previous')"></span> </button>
      <div class="pagination-info" x-html="safeT('storyLists.pageInfo', { currentPage: `<span class='current-page'>${currentPage}</span>`, totalPages: `<span class='total-pages'>${totalPages}</span>`, totalStories: totalStories })"></div>
      <button @click="nextPage()" :disabled="currentPage === totalPages || isLoadingStories" class="pagination-button next-button"> <span x-text="safeT('general.next')"></span> <i class="fas fa-chevron-right"></i> </button>
    </div>
  </section>

</main>

<!-- Footer -->
<footer>
  <div class="container">
    <!-- Код футера з i18n -->
    <div class="footer-content">
      <div class="footer-section footer-about"> <h4 x-text="safeT('general.about')"></h4> <p x-text="safeT('general.aboutText')"></p> <div class="social-links"> <a href="#" class="social-link" :title="safeT('general.shareFacebook')"><i class="fab fa-facebook-f"></i></a> <a href="#" class="social-link" :title="safeT('general.shareTelegram')"><i class="fab fa-telegram-plane"></i></a> <a href="#" class="social-link" title="Instagram"><i class="fab fa-instagram"></i></a> </div> </div>
      <div class="footer-section"> <h4 x-text="safeT('general.navigation')"></h4> <ul> <li><a href="index.html" x-text="safeT('general.home')"></a></li> <li><a href="categories.html" x-text="safeT('general.categories')"></a></li> <li><a href="new-stories.html" x-text="safeT('general.newStories')"></a></li> <li><a href="top-stories.html" x-text="safeT('general.topStories')"></a></li> <li><a href="authors.html" x-text="safeT('general.authors')"></a></li> </ul> </div>
      <div class="footer-section"> <h4 x-text="safeT('general.support')"></h4> <ul> <li><a href="faq.html" x-text="safeT('faq.title')"></a></li> <li><a href="contact.html" x-text="safeT('contact.title')"></a></li> <li><a href="terms-page.html" x-text="safeT('general.terms')"></a></li> <li><a href="privacy-policy.html" x-text="safeT('general.privacy')"></a></li> </ul> </div>
      <div class="footer-section"> <h4 x-text="safeT('general.join')"></h4> <ul> <li><a href="login.html" x-text="safeT('general.login')"></a></li> <li><a href="login.html?tab=register" x-text="safeT('general.register')"></a></li> <li><a href="premium.html" x-text="safeT('general.premium')"></a></li> <li><a href="create_story.html" x-text="safeT('createStory.title')"></a></li> </ul> </div>
    </div>
    <div class="footer-bottom"> © <span x-text="new Date().getFullYear()"></span> <span x-text="safeT('general.copyright')"></span>. <span x-text="safeT('general.allRightsReserved')"></span>. 18+ <br> <a href="terms-page.html" x-text="safeT('general.terms')"></a> | <a href="privacy-policy.html" x-text="safeT('general.privacy')"></a> </div>
  </div>
</footer>

<!-- Елемент сповіщення -->
<div x-show="notificationVisible"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 translate-y-2"
     x-transition:enter-end="opacity-100 translate-y-0"
     x-transition:leave="transition ease-in duration-300"
     x-transition:leave-start="opacity-100 translate-y-0"
     x-transition:leave-end="opacity-0 -translate-y-full"
     class="notification"
     :class="{ 'show': notificationVisible, 'success': notificationType === 'success', 'error': notificationType === 'error' }"
     style="display: none;"
     id="global-notification"
     role="alert"
     aria-live="assertive">
  <span x-text="notificationMessage"></span>
</div>

<!-- Кнопка Нагору -->
<button id="back-to-top"
        @click="window.scrollTo({ top: 0, behavior: 'smooth' })"
        x-data="{ isVisible: false }"
        x-init="window.addEventListener('scroll', () => { isVisible = window.scrollY > 300 })"
        x-show="isVisible"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-80 transform translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-80 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        :aria-label="safeT('general.backToTop', {}, 'На початок сторінки')"
        :title="safeT('general.backToTop', {}, 'На початок сторінки')"
        class="back-to-top">
  <i class="fas fa-arrow-up"></i>
</button>

</body>
</html>