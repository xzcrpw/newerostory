<!DOCTYPE html>
<!-- Додано x-data та :lang -->
<html lang="uk" x-data :lang="$store.i18n.selectedLang">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Title використовує i18n -->
  <title x-text="`${$store.i18n.t('contact.title')} — ${$store.i18n.t('general.copyright')}`"></title>

  <!-- Мета-теги використовують i18n -->
  <meta name="description" :content="$store.i18n.t('contact.metaDescription')">
  <meta property="og:title" :content="`${$store.i18n.t('contact.title')} — ${$store.i18n.t('general.copyright')}`">
  <meta property="og:description" :content="$store.i18n.t('contact.metaOgDescription')">
  <meta property="og:type" content="website">
  <!-- Можна додати OG image, якщо потрібно -->
  <!-- <meta property="og:image" content="URL_зображення"> -->

  <!-- Шрифти -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- API Config & Utils -->
  <script src="js/api-config.js" defer></script>
  <script src="js/api-utils.js" defer></script>

  <!-- Internationalization -->
  <script type="module" src="js/i18n.js" defer></script> <!-- Важливо: type="module" -->

  <!-- CSS -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/contact.css"> <!-- CSS файл для контактної сторінки -->

</head>
<body x-data="{
    isLoggedIn: false,
    contactName: '',
    contactEmail: '',
    contactSubject: '',
    contactMessage: '',
    isSubmitting: false,
    successMessage: '',
    errorMessage: '',

    // --- Допоміжні функції ---
    validateEmail(email) {
        if (!email) return false;
        // Більш надійний regex для перевірки email
        const emailRegex = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return emailRegex.test(String(email).toLowerCase());
    },
    clearMessages() {
        this.errorMessage = '';
        this.successMessage = '';
    },

    // --- Валідація форми (з i18n) ---
    validateForm() {
        this.clearMessages();
        
        // Додаємо обробку помилок для випадків, коли $store.i18n не доступний
        try {
            if (!this.contactName.trim()) {
                this.errorMessage = $store.i18n?.t('contact.errorNameRequired') || 'Будь ласка, введіть ваше ім\'я.';
                return false;
            }
            if (!this.contactEmail) {
                this.errorMessage = $store.i18n?.t('contact.errorEmailRequired') || 'Будь ласка, введіть ваш email.';
                return false;
            }
            if (!this.validateEmail(this.contactEmail)) {
                this.errorMessage = $store.i18n?.t('contact.errorEmailInvalid') || 'Будь ласка, введіть коректний email.';
                return false;
            }
            if (!this.contactSubject.trim()) {
                this.errorMessage = $store.i18n?.t('contact.errorSubjectRequired') || 'Будь ласка, введіть тему повідомлення.';
                return false;
            }
            if (!this.contactMessage.trim()) {
                this.errorMessage = $store.i18n?.t('contact.errorMessageRequired') || 'Будь ласка, введіть текст повідомлення.';
                return false;
            }
            return true;
        } catch (error) {
            console.error('Error during form validation:', error);
            this.errorMessage = 'Виникла помилка при валідації форми. Будь ласка, перевірте введені дані.';
            return false;
        }
    },

    // --- Відправка форми (з i18n) ---
    async submitForm() {
        if (!this.validateForm()) {
            // Плавний скрол до повідомлення про помилку з перевіркою наявності елемента
            this.$nextTick(() => { 
                const errorElement = document.querySelector('.error-message');
                if (errorElement) {
                    errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                }
            });
            return;
        }

        this.isSubmitting = true;

        try {
            const formData = {
                name: this.contactName.trim(),
                email: this.contactEmail.trim(),
                subject: this.contactSubject.trim(),
                message: this.contactMessage.trim()
            };

            // Санітація даних перед надсиланням
            Object.keys(formData).forEach(key => {
                // Перевірка, що це рядок
                if (typeof formData[key] === 'string') {
                    // Заміна потенційно небезпечних символів на HTML-сутності
                    formData[key] = formData[key]
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                }
            });

            console.log('Simulating API call: contact.sendMessage', formData);
            await new Promise(resolve => setTimeout(resolve, 1000)); // Симуляція запиту
            // await api.contact.sendMessage(formData); // Реальний виклик API

            this.successMessage = $store.i18n.t('contact.successMessage'); // i18n
            // Очищаємо форму
            this.contactName = ''; this.contactEmail = ''; this.contactSubject = ''; this.contactMessage = '';
            // Плавний скрол до повідомлення про успіх з перевіркою наявності елемента
            this.$nextTick(() => { 
                const successElement = document.querySelector('.success-message');
                if (successElement) {
                    successElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                }
            });

        } catch (error) {
            this.errorMessage = error.message || $store.i18n.t('contact.errorGeneral'); // i18n
            console.error('Contact form error:', error);
            // Плавний скрол до повідомлення про помилку з перевіркою наявності елемента
            this.$nextTick(() => { 
                const errorElement = document.querySelector('.error-message');
                if (errorElement) {
                    errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                }
            });
        } finally {
            this.isSubmitting = false;
        }
    }

}" x-init="
    try {
        isLoggedIn = api.utils.isAuthenticated();
        
        // Автозаповнення полів для залогіненого користувача
        if (isLoggedIn) {
            (async function() {
                try {
                    const user = await api.users.getCurrentUser();
                    if(user) {
                        contactName = user.name || '';
                        contactEmail = user.email || '';
                    }
                } catch(e) { 
                    console.warn('Failed to autofill contact form:', e); 
                }
            })();
        }
    } catch(e) {
        console.error('Error checking authentication status:', e);
        isLoggedIn = false;
    }
">

<!-- Хедер -->
<header>
  <div class="container">
    <nav class="navbar">
      <a href="index.html" class="logo">Таємний<span>Світ</span></a>
      <!-- Навігація з i18n -->
      <ul class="nav-links">
        <li><a href="index.html" x-text="$store.i18n.t('general.home')"></a></li>
        <li><a href="new-stories.html" x-text="$store.i18n.t('general.newStories')"></a></li>
        <li><a href="top-stories.html" x-text="$store.i18n.t('general.topStories')"></a></li>
        <li><a href="categories.html" x-text="$store.i18n.t('general.categories')"></a></li>
        <li><a href="authors.html" x-text="$store.i18n.t('general.authors')"></a></li>
      </ul>
      <div class="auth-buttons">
        <!-- Мовний перемикач -->
        <div class="lang-dropdown-container" x-data="{ open: false }" @click.away="open = false">
          <div class="lang-dropdown-button" @click="open = !open">
            <span x-text="$store.i18n.selectedLang.toUpperCase()"></span>
            <i class="fas fa-chevron-down" :class="{ 'rotate-180': open }"></i>
          </div>
          <div class="lang-dropdown-menu" x-show="open" x-transition>
            <template x-for="lang in $store.i18n.available" :key="lang.code">
              <div class="lang-dropdown-item"
                   :class="{ 'active': lang.code === $store.i18n.selectedLang }"
                   @click="$store.i18n.setLanguage(lang.code); open = false;">
                <span x-text="lang.name"></span>
                <i x-show="lang.code === $store.i18n.selectedLang" class="fas fa-check"></i>
              </div>
            </template>
          </div>
        </div>
        <!-- Кнопки авторизації -->
        <template x-if="!isLoggedIn">
          <div>
            <a href="login.html" class="btn btn-outline">
              <i class="fas fa-sign-in-alt"></i> <span x-text="$store.i18n.t('general.login')"></span>
            </a>
            <a href="register-page.html" class="btn btn-primary">
              <i class="fas fa-user-plus"></i> <span x-text="$store.i18n.t('general.register')"></span>
            </a>
          </div>
        </template>
        <template x-if="isLoggedIn">
          <div>
            <a href="profile.html" class="btn btn-outline">
              <i class="fas fa-user"></i> <span x-text="$store.i18n.t('general.profile')"></span>
            </a>
            <a href="#" @click.prevent="api.auth.logout(); window.location.reload();" class="btn btn-primary">
              <i class="fas fa-sign-out-alt"></i> <span x-text="$store.i18n.t('general.logout')"></span>
            </a>
          </div>
        </template>
      </div>
    </nav>
  </div>
</header>

<!-- Основний контент -->
<main class="container">
  <!-- Хлібні крихти -->
  <div class="breadcrumbs">
    <a href="index.html" x-text="$store.i18n.t('general.home')"></a>
    <span class="separator">/</span>
    <span class="current" x-text="$store.i18n.t('contact.title')"></span>
  </div>

  <div class="contact-page-container">
    <!-- Заголовок -->
    <div class="contact-header">
      <h1 class="contact-title" x-text="$store.i18n.t('contact.title')"></h1>
      <p class="contact-description" x-text="$store.i18n.t('contact.description')"></p>
    </div>

    <div class="contact-content">
      <!-- Контактна інформація -->
      <div class="contact-info">
        <h2 class="contact-subtitle" x-text="$store.i18n.t('contact.infoTitle')"></h2>
        <p x-text="$store.i18n.t('contact.infoText')"></p>
        <!-- Виправлені адреси електронної пошти -->
        <div class="contact-details">
          <div class="contact-item">
            <i class="fas fa-envelope"></i>
            <div>
              <strong x-text="$store.i18n.t('contact.infoGeneral') || 'Загальні питання:'"></strong> 
              <a href="mailto:contact@erostory.world">contact@erostory.world</a>
            </div>
          </div>
          <div class="contact-item">
            <i class="fas fa-headset"></i>
            <div>
              <strong x-text="$store.i18n.t('contact.infoSupport') || 'Технічна підтримка:'"></strong> 
              <a href="mailto:help@erostory.world">help@erostory.world</a>
            </div>
          </div>
          <div class="contact-item">
            <i class="fas fa-shield-alt"></i>
            <div>
              <strong x-text="$store.i18n.t('contact.infoSecurity') || 'Безпека та скарги:'"></strong> 
              <a href="mailto:admin@erostory.world">admin@erostory.world</a>
            </div>
          </div>
        </div>
        <p x-text="$store.i18n.t('contact.infoResponseTime')"></p>
        <!-- Використовуємо x-html для вставки посилання з текстом -->
        <p x-html="$store.i18n.t('contact.infoCheckFAQ', { link: `<a href='faq.html'>${$store.i18n.t('contact.infoFAQLink')}</a>` }) || `Також рекомендуємо переглянути наш розділ <a href='faq.html'>Часті запитання (FAQ)</a>, можливо, ви знайдете відповідь там.`"></p>
      </div>

      <!-- Форма зворотного зв'язку -->
      <div class="contact-form-container">
        <h2 class="contact-subtitle" x-text="$store.i18n.t('contact.formTitle')"></h2>

        <!-- Повідомлення про помилку -->
        <div x-show="errorMessage" x-transition class="error-message" role="alert" aria-live="assertive">
          <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
          <span x-text="errorMessage"></span>
        </div>

        <!-- Повідомлення про успіх -->
        <div x-show="successMessage" x-transition class="success-message" role="status" aria-live="polite">
          <i class="fas fa-check-circle" aria-hidden="true"></i>
          <span x-text="successMessage"></span>
        </div>

        <form @submit.prevent="submitForm()" class="contact-form">
          <div class="form-group">
            <label for="contactName" class="form-label" x-text="$store.i18n.t('contact.formNameLabel')"></label>
            <input type="text" id="contactName" class="form-input" x-model="contactName" :placeholder="$store.i18n.t('contact.formNamePlaceholder')" required aria-required="true">
          </div>
          <div class="form-group">
            <label for="contactEmail" class="form-label" x-text="$store.i18n.t('contact.formEmailLabel')"></label>
            <input type="email" id="contactEmail" class="form-input" x-model="contactEmail" :placeholder="$store.i18n.t('contact.formEmailPlaceholder')" required aria-required="true">
          </div>
          <div class="form-group">
            <label for="contactSubject" class="form-label" x-text="$store.i18n.t('contact.formSubjectLabel')"></label>
            <input type="text" id="contactSubject" class="form-input" x-model="contactSubject" :placeholder="$store.i18n.t('contact.formSubjectPlaceholder')" required aria-required="true">
          </div>
          <div class="form-group">
            <label for="contactMessage" class="form-label" x-text="$store.i18n.t('contact.formMessageLabel')"></label>
            <textarea id="contactMessage" class="form-textarea" x-model="contactMessage" rows="6" :placeholder="$store.i18n.t('contact.formMessagePlaceholder')" required aria-required="true"></textarea>
          </div>
          <!-- Поліпшення UX для кнопки під час відправки -->
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" :disabled="isSubmitting" 
                    aria-busy="isSubmitting">
              <span x-show="!isSubmitting" x-text="$store.i18n.t('contact.sendButton') || 'Надіслати'"></span>
              <span x-show="isSubmitting">
                <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 
                <span x-text="$store.i18n.t('contact.sendingButton') || 'Відправляємо...'"></span>
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer>
  <div class="container">
    <!-- Код футера з i18n, як в index.html -->
    <div class="footer-content">
      <div class="footer-section footer-about">
        <h4 x-text="$store.i18n.t('general.about')"></h4>
        <p x-text="$store.i18n.t('general.aboutText')"></p>
        <div class="social-links">
          <a href="#" class="social-link" :title="$store.i18n.t('general.shareFacebook')"><i class="fab fa-facebook-f"></i></a>
          <a href="#" class="social-link" :title="$store.i18n.t('general.shareTelegram')"><i class="fab fa-telegram-plane"></i></a>
          <a href="#" class="social-link" title="Instagram"><i class="fab fa-instagram"></i></a>
        </div>
      </div>
      <div class="footer-section">
        <h4 x-text="$store.i18n.t('general.navigation')"></h4>
        <ul>
          <li><a href="index.html" x-text="$store.i18n.t('general.home')"></a></li>
          <li><a href="categories.html" x-text="$store.i18n.t('general.categories')"></a></li>
          <li><a href="new-stories.html" x-text="$store.i18n.t('general.newStories')"></a></li>
          <li><a href="top-stories.html" x-text="$store.i18n.t('general.topStories')"></a></li>
          <li><a href="authors.html" x-text="$store.i18n.t('general.authors')"></a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4 x-text="$store.i18n.t('general.support')"></h4>
        <ul>
          <li><a href="faq.html" x-text="$store.i18n.t('faq.title')"></a></li>
          <li><a href="contact.html" x-text="$store.i18n.t('contact.title')"></a></li>
          <li><a href="terms-page.html" x-text="$store.i18n.t('general.terms')"></a></li>
          <li><a href="privacy-policy.html" x-text="$store.i18n.t('general.privacy')"></a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4 x-text="$store.i18n.t('general.join')"></h4>
        <ul>
          <li><a href="login.html" x-text="$store.i18n.t('general.login')"></a></li>
          <li><a href="login.html?tab=register" x-text="$store.i18n.t('general.register')"></a></li>
          <li><a href="premium.html" x-text="$store.i18n.t('general.premium')"></a></li>
          <li><a href="create_story.html" x-text="$store.i18n.t('createStory.title')"></a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      © <span x-text="new Date().getFullYear()"></span> <span x-text="$store.i18n.t('general.copyright')"></span>. <span x-text="$store.i18n.t('general.allRightsReserved')"></span>. 18+ <br>
      <a href="terms-page.html" x-text="$store.i18n.t('general.terms')"></a> | <a href="privacy-policy.html" x-text="$store.i18n.t('general.privacy')"></a>
    </div>
  </div>
</footer>

</body>
</html>