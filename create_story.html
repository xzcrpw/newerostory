<!DOCTYPE html>
<!-- Додано x-data та :lang -->
<html lang="uk" x-data :lang="$store.i18n.selectedLang" xmlns:x-transition="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title використовує i18n -->
    <title x-text="isEditMode ? `${$store.i18n.t('createStory.pageTitleEdit')} — ${$store.i18n.t('general.copyright')}` : `${$store.i18n.t('createStory.pageTitleCreate')} — ${$store.i18n.t('general.copyright')}`"></title>

    <!-- Мета-теги використовують i18n -->
    <meta name="description" :content="$store.i18n.t('createStory.metaDescription')">
    <!-- Інші мета-теги (OG) краще генерувати динамічно на бекенді -->

    <!-- Шрифти -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Select2 Dark Theme (приклад, може потребувати кастомізації) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme/dist/select2-bootstrap4.min.css">

    <!-- Internationalization -->
    <script type="module" src="js/i18n.js" defer></script> <!-- Важливо: type="module" -->

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- API Config & Utils -->
    <script src="js/api-config.js" defer></script>
    <script src="js/api-utils.js" defer></script>



    <!-- jQuery (потрібен для Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- TinyMCE -->
    <!-- ЗАМІНИ YOUR_API_KEY на свій ключ Tiny Cloud -->
    <script src="https://cdn.tiny.cloud/1/YOUR_API_KEY/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/create_story.css">

    <style>
        /* Стилі для сповіщень */
        .notification {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--card-color); color: var(--text-color);
            padding: 1rem 1.5rem; border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease-out, bottom 0.4s ease-out;
            min-width: 250px; text-align: center; border: 1px solid rgba(153, 0, 0, 0.2);
        }
        .notification.show { opacity: 1; bottom: 20px; }
        .notification.success { border-left: 4px solid #4cd964; }
        .notification.error { border-left: 4px solid #ff6b6b; }

        /* Стилі для індикатора завантаження */
        .loading-indicator-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(15, 10, 12, 0.8); display: flex;
            align-items: center; justify-content: center; z-index: 9998;
            backdrop-filter: blur(5px);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: var(--accent-red);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Стиль для кнопки під час обробки */
        button.removing, button:disabled { opacity: 0.7; pointer-events: none; }
        button.removing i:not(.fa-spinner), button:disabled i:not(.fa-spinner) { display: none; }
        button.removing::after, button:disabled.processing::after { /* Додав клас .processing для загального використання */
            content: '\f110'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            display: inline-block; animation: spin 1s linear infinite; margin-left: 5px;
        }

        /* Стилі для повідомлень про помилки/успіх форми */
        .error-message, .success-message {
            margin-bottom: 1.5rem;
            padding: 0.8rem 1.2rem;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            border: 1px solid transparent;
        }
        .error-message {
            background-color: rgba(255, 50, 50, 0.1);
            border-color: rgba(255, 50, 50, 0.3);
            color: #ff6b6b;
        }
        .success-message {
            background-color: rgba(50, 200, 50, 0.1);
            border-color: rgba(50, 200, 50, 0.3);
            color: #4cd964;
        }
        .error-message i, .success-message i { margin-right: 0.8rem; font-size: 1.1em; }
        .error-message button, .success-message button { margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem; }

        /* Стилі для Select2 dark theme (базові, можливо потребують доопрацювання) */
        /* Перенесено в create_story.css */

        /* Стилі для превью аватара */
        .image-preview { display: block; } /* Зробити видимим за замовчуванням, керувати через x-show */
        .image-preview img { max-width: 100%; max-height: 300px; object-fit: cover; border-radius: var(--border-radius); }
        .image-preview-remove { position: absolute; top: 10px; right: 10px; /* ... решта стилів ... */ }

    </style>
</head>
<body x-data="{
    // --- Стани UI ---
    currentTab: 'editor', // 'editor', 'preview'
    isLoading: false, // Завантаження даних для редагування
    isSavingDraft: false,
    isPublishing: false,
    errorMessage: null, // Загальна помилка
    successMessage: null, // Загальне повідомлення про успіх
    notificationVisible: false,
    notificationMessage: '',
    notificationTimeout: null,
    imagePreviewUrl: null,
    hasUnsavedChanges: false,
    isEditMode: false, // Чи це режим редагування
    storyId: null, // ID історії для редагування
    authorId: null, // ID автора для перевірки прав редагування

    // --- Дані історії ---
    storyTitle: '',
    storyCategory: '',
    storyTags: [], // Масив вибраних тегів
    ageRating: '18+', // Значення за замовчуванням
    storyImageFile: null, // File об'єкт
    storyImageUrl: null, // URL існуючого зображення (для редагування)
    storyContent: '',
    isPremium: false,
    isAnonymous: false,

    // --- Доступні категорії та теги (завантажуються з API) ---
    availableCategories: [],
    // availableTags: [], // Select2 tags дозволяє вводити нові

    // --- Функція сповіщень ---
    showNotification(message, isSuccess = true) {
        this.notificationMessage = message;
        const notificationElement = document.getElementById('global-notification');
        if (notificationElement) {
            notificationElement.classList.toggle('success', isSuccess);
            notificationElement.classList.toggle('error', !isSuccess);
            notificationElement.classList.add('show'); // Додаємо клас для відображення
        }
        this.notificationVisible = true;
        if (this.notificationTimeout) clearTimeout(this.notificationTimeout);
        this.notificationTimeout = setTimeout(() => { 
            this.notificationVisible = false; 
            // Перевіряємо чи елемент все ще існує
            const notificationEl = document.getElementById('global-notification');
            if (notificationEl) {
                notificationEl.classList.remove('show');
            }
        }, 4000);
    },

    // --- Функція валідації ---
    validateForm() {
        this.errorMessage = null;
        
        // Перевірка наявності заголовка
        if (!this.storyTitle.trim()) {
            this.errorMessage = $store.i18n?.t('createStory.errorTitleRequired') || 'Будь ласка, введіть заголовок історії.';
            return false;
        }
        
        // Перевірка наявності категорії
        if (!this.storyCategory) {
            this.errorMessage = $store.i18n?.t('createStory.errorCategoryRequired') || 'Будь ласка, виберіть категорію.';
            return false;
        }
        
        // Безпечне отримання TinyMCE контенту
        let content = '';
        try {
            const editor = tinymce.get('storyContentEditor');
            if (editor) {
                content = editor.getContent({ format: 'text' }).trim();
            }
        } catch (error) {
            console.error('Error getting TinyMCE content:', error);
            this.errorMessage = $store.i18n?.t('createStory.errorEditor') || 'Помилка редактора. Спробуйте оновити сторінку.';
            return false;
        }
        
        // Перевірка наявності контенту
        if (!content) {
            this.errorMessage = $store.i18n?.t('createStory.errorContentRequired') || 'Будь ласка, додайте текст вашої історії.';
            return false;
        }
        
        // Додаткова перевірка довжини контенту
        if (content.length < 100) {
            this.errorMessage = $store.i18n?.t('createStory.errorContentLength', { min: 100 }) || 
                               'Текст історії занадто короткий (мін. 100 символів).';
            return false;
        }
        
        return true;
    },

    // --- Завантаження даних для редагування ---
    async loadStoryForEdit() {
        const urlParams = new URLSearchParams(window.location.search);
        this.storyId = urlParams.get('id');
        if (!this.storyId) return; // Це створення, не редагування

        this.isEditMode = true;
        this.isLoading = true;
        this.errorMessage = null;
        
        try {
            console.log(`Simulating API call: getStoryById(${this.storyId})`);
            await new Promise(resolve => setTimeout(resolve, 700));
            // const storyData = await api.stories.getStoryById(this.storyId); // Реальний виклик
            const storyData = { // Симуляція
                _id: this.storyId, 
                title: `Редагована історія ${this.storyId}`, 
                category: 'romance',
                tags: ['потяг', 'редагування'], 
                ageRating: '18+', 
                isPremium: false, 
                isAnonymous: false,
                imageUrl: `https://source.unsplash.com/random/1200x600/?edit,${this.storyId}`,
                content: `<p>Це початковий текст історії ${this.storyId} для редагування.</p>`,
                author: { _id: api.utils.getUserId() || 'author123' } // Важливо для перевірки прав
            };

            // Перевірка наявності даних історії
            if (!storyData) {
                throw new Error($store.i18n?.t('createStory.errorStoryNotFound') || 'Історію не знайдено');
            }

            // Перевірка прав (чи поточний користувач є автором)
            if (storyData.author?._id !== api.utils.getUserId()) {
                throw new Error($store.i18n?.t('createStory.errorNotAuthor') || 'У вас немає прав на редагування цієї історії');
            }

            // Безпечне заповнення полів з перевірками
            this.storyTitle = storyData.title || '';
            this.storyCategory = storyData.category?._id || storyData.category || '';
            this.storyTags = Array.isArray(storyData.tags) ? storyData.tags : [];
            this.ageRating = storyData.ageRating || '18+';
            this.storyImageUrl = storyData.imageUrl || null;
            this.storyContent = storyData.content || '';
            this.isPremium = Boolean(storyData.isPremium);
            this.isAnonymous = Boolean(storyData.isAnonymous);
            this.authorId = storyData.author?._id || null;

            // Встановлюємо прев'ю для існуючого зображення
            if(this.storyImageUrl) this.imagePreviewUrl = this.storyImageUrl;

            // Оновлюємо TinyMCE та Select2 ПІСЛЯ завантаження даних
            this.$nextTick(() => {
                try {
                    // Оновлення TinyMCE з перевіркою
                    const editor = tinymce.get('storyContentEditor');
                    if (editor) {
                        editor.setContent(this.storyContent);
                    }
                    
                    // Оновлення Select2 з перевіркою
                    if (typeof $ === 'function' && this.$refs.tagsSelect) {
                        $(this.$refs.tagsSelect).val(this.storyTags).trigger('change');
                    }
                } catch (error) {
                    console.error('Error updating editor with story data:', error);
                }
            });

        } catch (error) {
            this.errorMessage = error.message || $store.i18n?.t('createStory.errorLoadingStory') || 'Помилка завантаження історії';
            console.error('Error loading story for edit:', error);
        } finally {
            this.isLoading = false;
        }
    },

    // --- Завантаження категорій ---
    async loadCategories() {
        try {
            console.log('Simulating API call: getCategories');
            await new Promise(resolve => setTimeout(resolve, 300));
            // const categories = await api.categories.getCategories(); // Реальний виклик
            this.availableCategories = [ // Симуляція з використанням ключів i18n
                { id: 'romance', name: $store.i18n.t('createStory.categoryRomance') },
                { id: 'fantasy', name: $store.i18n.t('createStory.categoryFantasy') },
                { id: 'bdsm', name: $store.i18n.t('createStory.categoryBDSM') },
                { id: 'first-time', name: $store.i18n.t('createStory.categoryFirstTime') },
                { id: 'vacation', name: $store.i18n.t('createStory.categoryVacation') },
                { id: 'chance-encounters', name: $store.i18n.t('createStory.categoryChanceEncounters') },
                { id: 'office', name: $store.i18n.t('createStory.categoryOffice') },
                { id: 'group', name: $store.i18n.t('createStory.categoryGroup') },
                { id: 'cheating', name: $store.i18n.t('createStory.categoryCheating') },
                { id: 'other', name: $store.i18n.t('createStory.categoryOther') }
            ];
        } catch (error) {
            console.error('Error loading categories:', error);
            this.errorMessage = $store.i18n.t('createStory.errorLoadingCategories') || 'Не вдалося завантажити категорії.';
        }
    },

    // --- Обробка зображення ---
    handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        // Валідація
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (!allowedTypes.includes(file.type)) {
            this.errorMessage = $store.i18n.t('createStory.errorImageFormat');
            event.target.value = null; // Скидаємо input
            return;
        }
        if (file.size > maxSize) {
            this.errorMessage = $store.i18n.t('createStory.errorImageSize', { size: '5MB' });
            event.target.value = null; // Скидаємо input
            return;
        }
        this.errorMessage = null;
        this.storyImageFile = file;
        this.storyImageUrl = null; // Скидаємо URL, якщо завантажується новий файл
        // Превью
        const reader = new FileReader();
        reader.onload = (e) => { this.imagePreviewUrl = e.target.result; }
        reader.readAsDataURL(file);
        this.setUnsavedChanges(); // Позначаємо зміни
    },
    removeImagePreview() {
        this.storyImageFile = null;
        this.storyImageUrl = null; // Також скидаємо URL існуючого
        this.imagePreviewUrl = null;
        if (this.$refs.imageUploadInput) { // Перевіряємо наявність refs
             this.$refs.imageUploadInput.value = null; // Скидаємо input file
        }
        this.setUnsavedChanges();
    },

    // --- Збереження/Публікація ---
    async saveDraft() {
        if (!this.validateForm()) {
             this.$nextTick(() => { document.querySelector('.error-message')?.scrollIntoView({ behavior: 'smooth', block: 'center' }); });
             return;
        }
        this.isSavingDraft = true; this.errorMessage = null; this.successMessage = null;
        try {
            const formData = this.prepareFormData();
            formData.append('status', 'draft'); // Додаємо статус

            console.log('Simulating API call: saveDraft');
            await new Promise(resolve => setTimeout(resolve, 1000));
            let result;
            if (this.isEditMode) {
                // result = await api.stories.updateStory(this.storyId, formData);
                 result = { _id: this.storyId, title: this.storyTitle }; // Симуляція
                 console.log('Updated draft:', result);
            } else {
                // result = await api.stories.createStory(formData);
                result = { _id: 'newStory' + Date.now(), title: this.storyTitle }; // Симуляція
                console.log('Created draft:', result);
                this.storyId = result._id; // Зберігаємо ID нової історії
                this.isEditMode = true; // Переходимо в режим редагування
                // Оновлюємо URL без перезавантаження
                window.history.pushState({}, '', `?id=${this.storyId}`);
            }

            this.successMessage = $store.i18n.t('createStory.draftSaved');
            this.hasUnsavedChanges = false; // Скидаємо прапорець змін
            // Оновлюємо дані на сторінці (напр. URL зображення, якщо воно було завантажене)
             if (result.imageUrl) {
                 this.storyImageUrl = result.imageUrl;
                 this.imagePreviewUrl = result.imageUrl;
                 this.storyImageFile = null;
                 if (this.$refs.imageUploadInput) this.$refs.imageUploadInput.value = null;
             }
        } catch (error) {
            this.errorMessage = `${$store.i18n.t('createStory.errorSavingDraft')} ${error.message || $store.i18n.t('general.unknownError')}`;
            console.error('Save draft error:', error);
        } finally { this.isSavingDraft = false; }
    },
    async publishStory() {
        if (!this.validateForm()) {
            this.$nextTick(() => { 
                const errorElement = document.querySelector('.error-message');
                if (errorElement) {
                    errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                }
            });
            return;
        }

        // Перевірка чи користувач залогінений
        if (!api.utils.isAuthenticated()) {
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
            return;
        }

        // Попередження про відсутність зображення
        if (!this.storyImageFile && !this.storyImageUrl) {
            if (!confirm($store.i18n?.t('createStory.confirmPublishNoImage') || 'Ви впевнені, що хочете опублікувати історію без зображення?')) {
                return;
            }
        }

        this.isPublishing = true; 
        this.errorMessage = null; 
        this.successMessage = null;
        
        try {
            const formData = this.prepareFormData();
            formData.append('status', 'published'); // Встановлюємо статус

            console.log('Simulating API call: publishStory');
            await new Promise(resolve => setTimeout(resolve, 1200));
            let result;
            
            if (this.isEditMode) {
                // result = await api.stories.updateStory(this.storyId, formData);
                result = { _id: this.storyId }; // Симуляція
                console.log('Published updated story:', result);
            } else {
                // result = await api.stories.createStory(formData);
                result = { _id: 'newStory' + Date.now() }; // Симуляція
                console.log('Published new story:', result);
            }
            
            this.hasUnsavedChanges = false; // Скидаємо прапорець
            this.showNotification(
                $store.i18n?.t('createStory.storyPublishedSuccess') || 'Історію успішно опубліковано!', 
                true
            );
            
            // Перенаправлення на сторінку історії
            setTimeout(() => { 
                if (result && result._id) {
                    window.location.href = `story-detailed.html?id=${result._id}`; 
                } else {
                    // Якщо немає ID, перенаправляємо на профіль користувача
                    window.location.href = 'profile.html';
                }
            }, 1500);

        } catch (error) {
            this.errorMessage = `${$store.i18n?.t('createStory.errorPublishing') || 'Помилка публікації історії:'} ${error.message || $store.i18n?.t('general.unknownError') || 'Невідома помилка'}`;
            console.error('Publish story error:', error);
            this.isPublishing = false; // Знімаємо блокування при помилці
        }
    },
    // Допоміжна функція для підготовки даних форми
    prepareFormData() {
        const formData = new FormData();
        
        // Безпечне додавання полів з перевіркою
        const safeAppend = (name, value) => {
            if (value !== null && value !== undefined) {
                formData.append(name, value);
            }
        };
        
        // Додаємо базові поля з валідацією
        safeAppend('title', this.storyTitle.trim());
        safeAppend('category', this.storyCategory);
        
        // Обробка тегів з перевіркою на масив
        if (Array.isArray(this.storyTags)) {
            this.storyTags.forEach(tag => {
                if (tag) safeAppend('tags', tag);
            });
        }
        
        safeAppend('ageRating', this.ageRating);
        
        // Безпечне оновлення контенту з TinyMCE
        try {
            const editor = tinymce.get('storyContentEditor');
            if (editor) {
                this.storyContent = editor.getContent();
            }
        } catch (error) {
            console.error('Error getting content from TinyMCE:', error);
        }
        
        safeAppend('content', this.storyContent);
        safeAppend('isPremium', this.isPremium);
        safeAppend('isAnonymous', this.isAnonymous);
        
        // Обробка зображення
        if (this.storyImageFile) {
            safeAppend('image', this.storyImageFile);
        } else if (this.isEditMode && !this.storyImageUrl && !this.imagePreviewUrl) {
            safeAppend('removeImage', 'true');
        }
        
        return formData;
    },

    // --- Інше ---
    setUnsavedChanges() { this.hasUnsavedChanges = true; },
    handleBeforeUnload(event) {
        if (this.hasUnsavedChanges) {
            // Зберігаємо поточний контент редактора перед перевіркою
            try {
                const editor = tinymce.get('storyContentEditor');
                if (editor) {
                    const currentContent = editor.getContent();
                    // Порівнюємо зі збереженим контентом
                    if (currentContent !== this.storyContent) {
                        this.hasUnsavedChanges = true;
                    }
                }
            } catch (e) {
                console.warn('Error accessing TinyMCE in beforeunload:', e);
            }

            if (this.hasUnsavedChanges) {
                const message = $store.i18n?.t('createStory.beforeUnloadWarning') || 'У вас є незбережені зміни. Ви впевнені, що хочете залишити сторінку?';
                event.preventDefault();
                event.returnValue = message;
                return message;
            }
        }
        return undefined;
    },
    initEditor() {
        try {
            // Ініціалізація TinyMCE
            tinymce.init({
                selector: '#storyContentEditor',
                plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount help',
                toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat | help',
                skin: (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'oxide-dark' : 'oxide'),
                content_css: (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default'),
                content_style: 'body { font-family:Montserrat,sans-serif; font-size:16px; color: var(--text-color); background-color: var(--card-color); } p {margin-bottom: 1em;}',
                placeholder: $store.i18n?.t('createStory.contentPlaceholder') || 'Почніть писати вашу історію тут...',
                height: 500,
                setup: (editor) => {
                    editor.on('change keyup Undo Redo', () => {
                        this.storyContent = editor.getContent();
                        this.setUnsavedChanges();
                    });
                    editor.on('init', () => {
                        if (this.isEditMode && this.storyContent) {
                            editor.setContent(this.storyContent);
                            setTimeout(() => { this.hasUnsavedChanges = false; }, 50);
                        }
                    });
                },
                language: $store.i18n?.selectedLang === 'uk' ? 'uk' : ($store.i18n?.selectedLang === 'ru' ? 'ru' : 'en'),
                language_url: `/tinymce/langs/${$store.i18n?.selectedLang || 'en'}.js`
            });
        } catch (error) {
            console.error('Error initializing TinyMCE:', error);
            this.errorMessage = $store.i18n?.t('createStory.errorEditorInit') || 'Помилка ініціалізації редактора. Спробуйте оновити сторінку.';
        }

        // Ініціалізація Select2 з перевіркою наявності jQuery
        if (typeof $ === 'function') {
            try {
                $(this.$refs.tagsSelect).select2({
                    theme: 'bootstrap4',
                    tags: true,
                    tokenSeparators: [',', ' '],
                    maximumSelectionLength: 5,
                    placeholder: $store.i18n?.t('createStory.tagsPlaceholder') || 'Додайте теги...',
                    language: {
                        noResults: () => $store.i18n?.t('select2.noResults') || 'Нічого не знайдено',
                        searching: () => $store.i18n?.t('select2.searching') || 'Пошук...',
                        maximumSelected: (args) => $store.i18n?.t('createStory.tagsMaxSelected', { count: args.maximum }) || 
                                                  `Ви можете вибрати лише ${args.maximum} тегів`
                    }
                }).on('change', (e) => {
                    const currentVal = JSON.stringify(this.storyTags);
                    const newVal = JSON.stringify($(e.target).val() || []);
                    if(currentVal !== newVal) {
                        this.storyTags = $(e.target).val() || [];
                        this.setUnsavedChanges();
                    }
                });
            } catch (error) {
                console.error('Error initializing Select2:', error);
            }
        } else {
            console.error('jQuery is not available, Select2 cannot be initialized');
            this.errorMessage = $store.i18n?.t('createStory.errorTagsInit') || 'Помилка ініціалізації тегів. Деякі функції можуть не працювати.';
        }

        // Додаємо слухач для попередження про незбережені зміни
        window.addEventListener('beforeunload', this.handleBeforeUnload.bind(this));
    }

}" x-init="
    loadCategories(); // Завантажуємо категорії
    initEditor();     // Ініціалізуємо редактори
    loadStoryForEdit(); // Спробуємо завантажити історію для редагування
    // Спостерігаємо за змінами в полях для прапорця hasUnsavedChanges
    $watch('storyTitle', () => setUnsavedChanges());
    $watch('storyCategory', () => setUnsavedChanges());
    $watch('ageRating', () => setUnsavedChanges());
    $watch('isPremium', () => setUnsavedChanges());
    $watch('isAnonymous', () => setUnsavedChanges());
    $cleanup = () => {
        try {
            // Видалити TinyMCE редактор
            tinymce.get('storyContentEditor')?.remove();
            
            // Видалити слухача beforeunload
            window.removeEventListener('beforeunload', this.handleBeforeUnload);
            
            // Знищити Select2
            if (typeof $ === 'function') {
                $(this.$refs.tagsSelect)?.select2('destroy');
            }
            
            // Очистити таймаути
            if (this.notificationTimeout) {
                clearTimeout(this.notificationTimeout);
            }
        } catch (error) {
            console.warn('Error during cleanup:', error);
        }
    }
" @beforeunload="handleBeforeUnload($event)">

<!-- Індикатор завантаження -->
<div x-show="isLoading" class="loading-indicator-overlay" x-transition.opacity>
    <div class="loading-spinner"></div>
</div>

<!-- Хедер -->
<header>
    <div class="container">
        <nav class="navbar">
            <a href="index.html" class="logo">Таємний<span>Світ</span></a>
            <!-- Навігація з i18n -->
            <ul class="nav-links">
                <li><a href="index.html" x-text="$store.i18n.t('general.home')"></a></li>
                <li><a href="new-stories.html" x-text="$store.i18n.t('general.newStories')"></a></li>
                <li><a href="top-stories.html" x-text="$store.i18n.t('general.topStories')"></a></li>
                <li><a href="categories.html" x-text="$store.i18n.t('general.categories')"></a></li>
                <li><a href="authors.html" x-text="$store.i18n.t('general.authors')"></a></li>
            </ul>
            <div class="auth-buttons">
                <!-- Мовний перемикач -->
                <div class="lang-dropdown-container" x-data="{ open: false }" @click.away="open = false">
                    <div class="lang-dropdown-button" @click="open = !open" role="button" aria-haspopup="true" :aria-expanded="open">
                        <!-- Безпечний доступ до selectedLang -->
                        <span x-text="$store?.i18n?.selectedLang?.toUpperCase() || 'UK'"></span>
                        <i class="fas fa-chevron-down" :class="{ 'rotate-180': open }" aria-hidden="true"></i>
                    </div>
                    <!-- Перевіряємо наявність $store.i18n -->
                    <template x-if="$store?.i18n">
                        <div class="lang-dropdown-menu" x-show="open" x-transition role="menu" aria-orientation="vertical">
                            <!-- Безпечний доступ до available та ітерація -->
                            <template x-for="lang in $store.i18n.available || []" :key="lang.code">
                                <div class="lang-dropdown-item"
                                     :class="{ 'active': lang.code === $store.i18n.selectedLang }"
                                     @click="
                 const newLang = lang.code;
                 open = false;
                 try {
                     // Виклик setLanguage всередині try...catch
                     $store.i18n.setLanguage(newLang);
                     console.log('Language set to:', newLang);
                 } catch(e) {
                     console.error('Error setting language:', e);
                     // Можна додати сповіщення для користувача тут
                 }
              "
                                     role="menuitemradio"
                                     :aria-checked="lang.code === $store.i18n.selectedLang"
                                     tabindex="0"
                                     @keydown.enter.space.prevent="
                 const newLang = lang.code;
                 open = false;
                 try { $store.i18n.setLanguage(newLang); } catch(e) { console.error('Error setting language:', e); }
              ">
                                    <span x-text="lang.name"></span>
                                    <i x-show="lang.code === $store.i18n.selectedLang" class="fas fa-check" aria-hidden="true"></i>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                <!-- Кнопки авторизації -->
                <template x-if="!isLoggedIn">
                    <div>
                        <a href="login.html" class="btn btn-outline">
                            <i class="fas fa-sign-in-alt"></i> <span x-text="$store.i18n.t('general.login')"></span>
                        </a>
                        <a href="login.html?tab=register" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> <span x-text="$store.i18n.t('general.register')"></span>
                        </a>
                    </div>
                </template>
                <template x-if="isLoggedIn">
                    <div>
                        <a href="profile.html" class="btn btn-outline">
                            <i class="fas fa-user"></i> <span x-text="$store.i18n.t('general.profile')"></span>
                        </a>
                        <a href="#" @click.prevent="api.auth.logout(); isLoggedIn = false;" class="btn btn-primary">
                            <i class="fas fa-sign-out-alt"></i> <span x-text="$store.i18n.t('general.logout')"></span>
                        </a>
                    </div>
                </template>
            </div>
        </nav>
    </div>
</header>

<!-- Основний контент -->
<main class="container editor-container">

    <!-- Заголовок сторінки -->
    <div class="editor-header">
        <h1 class="editor-title" x-text="isEditMode ? $store.i18n.t('createStory.pageTitleEdit') : $store.i18n.t('createStory.pageTitleCreate')"></h1>
        <p class="editor-subtitle" x-text="$store.i18n.t('createStory.subtitle')"></p>
    </div>

    <!-- Повідомлення про помилки/успіх -->
    <div x-show="errorMessage" class="error-message">
        <i class="fas fa-exclamation-circle"></i> <span x-text="errorMessage"></span>
        <button @click="errorMessage = null" class="btn btn-outline" style="margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem;" x-text="$store.i18n.t('general.close')"></button>
    </div>
    <div x-show="successMessage" class="success-message">
        <i class="fas fa-check-circle"></i> <span x-text="successMessage"></span>
        <button @click="successMessage = null" class="btn btn-outline" style="margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem;" x-text="$store.i18n.t('general.close')"></button>
    </div>

    <!-- Таби Редактор/Прев'ю -->
    <div class="editor-tabs">
        <div class="editor-tab" :class="{ 'active': currentTab === 'editor' }" @click="currentTab = 'editor'" x-text="$store.i18n.t('createStory.tabEditor')"></div>
        <div class="editor-tab" :class="{ 'active': currentTab === 'preview' }" @click="currentTab = 'preview'" x-text="$store.i18n.t('createStory.tabPreview')"></div>
    </div>

    <!-- Форма редактора -->
    <div x-show="currentTab === 'editor'" x-transition>
        <!-- Поради -->
        <div class="editor-tips">
            <h3 class="editor-tips-title"><i class="fas fa-lightbulb"></i> <span x-text="$store.i18n.t('createStory.tipsTitle')"></span></h3>
            <ul class="editor-tips-list">
                <li x-text="$store.i18n.t('createStory.tip1')"></li>
                <li x-text="$store.i18n.t('createStory.tip2')"></li>
                <li x-text="$store.i18n.t('createStory.tip3')"></li>
                <li x-text="$store.i18n.t('createStory.tip4')"></li>
                <li x-text="$store.i18n.t('createStory.tip5')"></li>
            </ul>
        </div>

        <form class="editor-form" @submit.prevent>
            <!-- Назва -->
            <div class="form-group">
                <label for="storyTitle" class="form-label" x-text="$store.i18n.t('createStory.titleLabel')"></label>
                <input type="text" id="storyTitle" class="form-input" x-model="storyTitle" :placeholder="$store.i18n.t('createStory.titlePlaceholder')" maxlength="100" required @input="setUnsavedChanges">
                <div class="form-help" x-text="$store.i18n.t('createStory.titleHelp')"></div>
            </div>

            <div class="form-row">
                <!-- Категорія -->
                <div class="form-group" style="flex: 1;">
                    <label for="storyCategory" class="form-label" x-text="$store.i18n.t('createStory.categoryLabel')"></label>
                    <select id="storyCategory" class="form-select" x-model="storyCategory" required @change="setUnsavedChanges">
                        <option value="" disabled selected x-text="$store.i18n.t('createStory.categorySelectDefault')"></option>
                        <template x-for="category in availableCategories" :key="category.id">
                            <option :value="category.id" x-text="category.name"></option>
                        </template>
                    </select>
                </div>
                <!-- Віковий рейтинг -->
                <div class="form-group" style="flex: 1;">
                    <label for="ageRating" class="form-label" x-text="$store.i18n.t('createStory.ageRatingLabel')"></label>
                    <select id="ageRating" class="form-select" x-model="ageRating" required @change="setUnsavedChanges">
                        <option value="18+" x-text="$store.i18n.t('createStory.ageRating18')"></option>
                        <option value="21+" x-text="$store.i18n.t('createStory.ageRating21')"></option>
                    </select>
                </div>
            </div>

            <!-- Теги -->
            <div class="form-group">
                <label for="storyTags" class="form-label" x-text="$store.i18n.t('createStory.tagsLabel')"></label>
                <!-- Використовуємо x-ref для доступу до елемента в init -->
                <select id="storyTags" class="form-select" multiple="multiple" x-ref="tagsSelect"></select>
                <div class="form-help" x-text="$store.i18n.t('createStory.tagsHelp')"></div>
            </div>

            <!-- Зображення -->
            <div class="form-group">
                <label class="form-label" x-text="$store.i18n.t('createStory.imageLabel')"></label>
                <input type="file" id="imageUploadInput" @change="handleImageUpload($event)" accept="image/jpeg, image/png, image/gif, image/webp" style="display: none;" x-ref="imageUploadInput">
                <label for="imageUploadInput" class="image-upload">
                    <div class="image-upload-icon"><i class="fas fa-image"></i></div>
                    <div class="image-upload-text" x-text="$store.i18n.t('createStory.imageUploadButton')"></div>
                    <div class="image-upload-subtext" x-text="$store.i18n.t('createStory.imageUploadHelp')"></div>
                </label>
                <div class="form-help" x-text="$store.i18n.t('createStory.imageHelp')"></div>
                <!-- Прев'ю зображення -->
                <div class="image-preview" x-show="imagePreviewUrl" x-transition>
                    <img :src="imagePreviewUrl" alt="Прев'ю зображення">
                    <button type="button" @click="removeImagePreview()" class="image-preview-remove" :title="$store.i18n.t('createStory.imageRemoveTooltip')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Текст історії -->
            <div class="form-group">
                <label for="storyContentEditor" class="form-label" x-text="$store.i18n.t('createStory.contentLabel')"></label>
                <textarea id="storyContentEditor"></textarea>
            </div>

            <!-- Опції -->
            <div class="form-group checkbox-group">
                <input type="checkbox" id="isPremium" x-model="isPremium" @change="setUnsavedChanges">
                <label for="isPremium" x-text="$store.i18n.t('createStory.premiumCheckbox')"></label>
                <span class="form-help" style="margin-left: 5px;" x-text="$store.i18n.t('createStory.premiumHelp')"></span>
            </div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="isAnonymous" x-model="isAnonymous" @change="setUnsavedChanges">
                <label for="isAnonymous" x-text="$store.i18n.t('createStory.anonymousCheckbox')"></label>
                <span class="form-help" style="margin-left: 5px;" x-text="$store.i18n.t('createStory.anonymousHelp')"></span>
            </div>

            <!-- Кнопки дій -->
            <div class="editor-actions">
                <div class="action-left">
                    <button type="button" class="btn btn-outline" @click="saveDraft()" :disabled="isSavingDraft || isPublishing">
                        <span x-show="!isSavingDraft" x-text="$store.i18n.t('createStory.saveDraftButton')"></span>
                        <span x-show="isSavingDraft"><i class="fas fa-spinner fa-spin"></i> <span x-text="$store.i18n.t('createStory.savingDraft')"></span></span>
                    </button>
                </div>
                <div class="action-right">
                    <button type="button" class="btn btn-outline" @click="window.location.href='index.html'" :disabled="isSavingDraft || isPublishing" x-text="$store.i18n.t('general.cancel')"></button>
                    <button type="button" class="btn btn-primary processing" @click="publishStory()" :disabled="isPublishing || isSavingDraft">
                        <span x-show="!isPublishing" x-text="$store.i18n.t('createStory.publishButton')"></span>
                        <span x-show="isPublishing"><span x-text="$store.i18n.t('createStory.publishing')"></span></span> <!-- Спінер додається через CSS -->
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Попередній перегляд -->
    <div x-show="currentTab === 'preview'" x-transition>
        <div class="preview-container">
            <h2 class="preview-title" x-text="storyTitle || $store.i18n.t('createStory.previewTitlePlaceholder')"></h2>
            <div class="preview-meta">
                <div><i class="fas fa-user"></i> <span x-text="isAnonymous ? $store.i18n.t('createStory.previewAuthorAnon') : ($store.i18n.t('createStory.previewAuthorYou'))"></span></div>
                <div><i class="fas fa-folder"></i> <span x-text="availableCategories.find(c => c.id === storyCategory)?.name || $store.i18n.t('createStory.previewCategoryPlaceholder')"></span></div>
                <div><i class="fas fa-calendar-alt"></i> <span x-text="$store.i18n.t('createStory.previewDateNow')"></span></div>
                <div><i class="fas fa-tag"></i> <span x-text="ageRating"></span></div>
                <div x-show="isPremium"><i class="fas fa-crown" style="color: var(--accent-gold);"></i> <span x-text="$store.i18n.t('general.premium')"></span></div>
            </div>

            <img x-show="imagePreviewUrl" :src="imagePreviewUrl" class="preview-featured-image" :alt="$store.i18n.t('createStory.previewImageAlt')">
            <p x-show="!imagePreviewUrl" style="color: var(--secondary-text); font-style: italic; margin-bottom: 1.5rem;" x-text="$store.i18n.t('createStory.previewNoImage')"></p>

            <!-- Оновлюємо контент з TinyMCE перед показом -->
            <div class="preview-content" x-html="tinymce.get('storyContentEditor')?.getContent() || $store.i18n.t('createStory.previewContentPlaceholder')"></div>

            <div class="preview-tags" x-show="storyTags.length > 0">
                <template x-for="tag in storyTags" :key="tag">
                    <span class="preview-tag" x-text="tag"></span>
                </template>
            </div>

            <button type="button" class="btn btn-outline" @click="currentTab = 'editor'" x-text="$store.i18n.t('createStory.previewBackButton')"></button>
        </div>
    </div>

</main>

<!-- Footer -->
<footer>
    <div class="container">
        <!-- Код футера з i18n, як в index.html -->
        <div class="footer-content">
            <div class="footer-section footer-about">
                <h4 x-text="$store.i18n.t('general.about')"></h4>
                <p x-text="$store.i18n.t('general.aboutText')"></p>
                <div class="social-links">
                    <a href="#" class="social-link" :title="$store.i18n.t('general.shareFacebook')"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social-link" :title="$store.i18n.t('general.shareTelegram')"><i class="fab fa-telegram-plane"></i></a>
                    <a href="#" class="social-link" title="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="footer-section">
                <h4 x-text="$store.i18n.t('general.navigation')"></h4>
                <ul>
                    <li><a href="index.html" x-text="$store.i18n.t('general.home')"></a></li>
                    <li><a href="categories.html" x-text="$store.i18n.t('general.categories')"></a></li>
                    <li><a href="new-stories.html" x-text="$store.i18n.t('general.newStories')"></a></li>
                    <li><a href="top-stories.html" x-text="$store.i18n.t('general.topStories')"></a></li>
                    <li><a href="authors.html" x-text="$store.i18n.t('general.authors')"></a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4 x-text="$store.i18n.t('general.support')"></h4>
                <ul>
                    <li><a href="faq.html" x-text="$store.i18n.t('faq.title')"></a></li>
                    <li><a href="contact.html" x-text="$store.i18n.t('contact.title')"></a></li>
                    <li><a href="terms-page.html" x-text="$store.i18n.t('general.terms')"></a></li>
                    <li><a href="privacy-policy.html" x-text="$store.i18n.t('general.privacy')"></a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4 x-text="$store.i18n.t('general.join')"></h4>
                <ul>
                    <li><a href="login.html" x-text="$store.i18n.t('general.login')"></a></li>
                    <li><a href="login.html?tab=register" x-text="$store.i18n.t('general.register')"></a></li>
                    <li><a href="premium.html" x-text="$store.i18n.t('general.premium')"></a></li>
                    <li><a href="create_story.html" x-text="$store.i18n.t('createStory.title')"></a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            © <span x-text="new Date().getFullYear()"></span> <span x-text="$store.i18n.t('general.copyright')"></span>. <span x-text="$store.i18n.t('general.allRightsReserved')"></span>. 18+ <br>
            <a href="terms-page.html" x-text="$store.i18n.t('general.terms')"></a> | <a href="privacy-policy.html" x-text="$store.i18n.t('general.privacy')"></a>
        </div>
    </div>
</footer>

<!-- Елемент сповіщення -->
<div x-show="notificationVisible"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 translate-y-2"
     x-transition:enter-end="opacity-100 translate-y-0"
     x-transition:leave="transition ease-in duration-300"
     x-transition:leave-start="opacity-100 translate-y-0"
     x-transition:leave-end="opacity-0 -translate-y-full"
     class="notification"
     :class="{ 'show': notificationVisible, 'success': true, 'error': false }"
     style="display: none;"
     id="global-notification">
    <span x-text="notificationMessage"></span>
</div>

</body>
</html>