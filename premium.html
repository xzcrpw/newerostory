<!DOCTYPE html>
<!-- Додано x-data та :lang -->
<html lang="uk" x-data :lang="$store.i18n.selectedLang" xmlns:x-transition="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title використовує i18n -->
    <title x-text="`${$store.i18n.t('premium.title')} — ${$store.i18n.t('general.copyright')}`"></title>

    <!-- Мета-теги використовують i18n -->
    <meta name="description" :content="$store.i18n.t('premium.metaDescription')">
    <meta property="og:title" :content="`${$store.i18n.t('premium.title')} — ${$store.i18n.t('general.copyright')}`">
    <meta property="og:description" :content="$store.i18n.t('premium.metaOgDescription')">
    <meta property="og:image" content="https://source.unsplash.com/random/1200x630/?gold,luxury">
    <meta property="og:type" content="website">

    <!-- Шрифти -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- API Config & Utils -->
    <script src="js/api-config.js" defer></script>
    <script src="js/api-utils.js" defer></script>

    <!-- Internationalization -->
    <script type="module" src="js/i18n.js" defer></script> <!-- Важливо: type="module" -->

    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/premium_page.css">

    <style>
        /* Стилі для завантаження, помилок, сповіщень */
        .loading-overlay { /* Для блокування під час оплати */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(15, 10, 12, 0.8); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
            backdrop-filter: blur(5px); color: var(--text-color);
        }
        .loading-spinner { /* Змінено на spinner */
            border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: var(--accent-red);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Стилі для inline помилок у формі */
        .error-message-inline {
            color: #ff6b6b;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block; /* Додано для відображення */
        }

        /* Стилі для сповіщень купона */
        .form-notification {
            padding: 0.8rem 1rem; margin-top: 1rem; border-radius: var(--border-radius);
            font-size: 0.9rem; display: flex; align-items: center;
        }
        .form-notification.success { background-color: rgba(50, 200, 50, 0.1); border: 1px solid rgba(50, 200, 50, 0.3); color: #4cd964; }
        .form-notification.error { background-color: rgba(255, 50, 50, 0.1); border: 1px solid rgba(255, 50, 50, 0.3); color: #ff6b6b; }
        .form-notification i { margin-right: 0.7rem; }

        /* Стилі для індикатора завантаження планів/статусу */
        .loading-indicator-small {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem 0; /* Зменшений падінг */
            color: var(--secondary-text);
            font-size: 0.9rem; /* Зменшений шрифт */
        }
        .loading-spinner-small {
            border: 2px solid rgba(255, 255, 255, 0.2); /* Тонший бордер */
            border-left-color: var(--accent-red);
            border-radius: 50%;
            width: 20px; /* Менший розмір */
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 8px; /* Менший відступ */
        }
        /* Стилі для повідомлення про помилку планів/статусу */
        .error-message-small {
            color: #ff6b6b;
            background-color: rgba(255, 50, 50, 0.1);
            border: 1px solid rgba(255, 50, 50, 0.3);
            padding: 0.8rem 1rem;
            border-radius: var(--border-radius);
            margin: 1rem auto; /* Центрування */
            display: flex;
            align-items: center;
            max-width: 90%; /* Обмеження ширини */
        }
        .error-message-small i { margin-right: 0.7rem; }
        .error-message-small button { margin-left: auto; padding: 0.3rem 0.8rem; font-size: 0.8rem; }

        /* Сповіщення */
        .notification {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--card-color); color: var(--text-color);
            padding: 1rem 1.5rem; border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease-out, bottom 0.4s ease-out;
            min-width: 250px; text-align: center; border: 1px solid rgba(153, 0, 0, 0.2);
        }
        .notification.show { opacity: 1; bottom: 20px; }
        .notification.success { border-left: 4px solid #4cd964; }
        .notification.error { border-left: 4px solid #ff6b6b; }

        /* Стиль для кнопки під час обробки */
        @keyframes processing-pulse {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }
        .pay-btn.processing {
            background-size: 200% 100%;
            background-image: linear-gradient(to right, var(--accent-red), var(--accent-dark), var(--accent-red));
            animation: processing-pulse 1.5s infinite linear;
            opacity: 0.9;
            pointer-events: none;
        }
    </style>

</head>
<body x-data="{
    // --- Стани UI ---
    isLoggedIn: false,
    isLoadingPlans: true,
    isLoadingUserStatus: true,
    plansError: null,
    userStatusError: null,
    currentStep: 1, // 1: вибір, 2: оплата, 3: підтвердження
    activePaymentMethod: 'card',
    isProcessingPayment: false,
    paymentError: null,
    couponError: null,
    couponSuccessMessage: null,
    isApplyingCoupon: false,
    notificationVisible: false,
    notificationMessage: '',
    notificationTimeout: null,
    cardError: { number: '', name: '', expiry: '', cvc: '' },

    // --- Дані ---
    plans: [],
    selectedPlanSlug: null,
    isYearlyBilling: false,
    userSubscription: null,
    couponCode: '',
    appliedCoupon: null,
    paymentResult: null,

    // --- Платіжні дані ---
    card: { number: '', name: '', expiry: '', cvc: '' },
    termsAgreed: false,
    selectedCrypto: 'BTC',
    cryptoAddress: '', // Буде отримано з API
    cryptoAmount: '',  // Буде розраховано

    // --- Обчислювані властивості ---
    get selectedPlan() {
        return this.plans.find(p => p.slug === this.selectedPlanSlug) || null;
    },
    get currentPlanPriceDetails() {
        const plan = this.selectedPlan;
        if (!plan) return { price: 0, period: '', rawPrice: 0, couponDiscount: 0, yearlySavingsPercent: 0 };

        const price = this.isYearlyBilling ? (plan.yearlyPrice || 0) : (plan.monthlyPrice || 0);
        const period = this.isYearlyBilling ? $store.i18n.t('premium.perYear') : $store.i18n.t('premium.perMonth');
        let finalPrice = price;
        let discountAmount = 0;

        if (this.appliedCoupon) {
            if (this.appliedCoupon.discountType === 'percentage') {
                discountAmount = Math.round(price * (this.appliedCoupon.discountValue / 100));
            } else if (this.appliedCoupon.discountType === 'fixed') {
                discountAmount = this.appliedCoupon.discountValue;
            }
            finalPrice = Math.max(0, price - discountAmount);
        }

        let yearlySavingsPercent = 0;
        if (this.isYearlyBilling && plan.monthlyPrice && plan.yearlyPrice && plan.monthlyPrice > 0) {
            const yearlyCostMonthly = plan.monthlyPrice * 12;
            if (yearlyCostMonthly > plan.yearlyPrice) {
                yearlySavingsPercent = Math.round(((yearlyCostMonthly - plan.yearlyPrice) / yearlyCostMonthly) * 100);
            }
        }

        return {
            price: finalPrice,
            period: period,
            rawPrice: price,
            couponDiscount: discountAmount,
            yearlySavingsPercent: yearlySavingsPercent
        };
    },
    get currentPlanName() {
        return this.selectedPlan?.name || $store.i18n.t('premium.planNotSelected'); // i18n
    },
    // --- Покращена валідація форми картки ---
    validateCardForm() {
        this.cardError = { number: '', name: '', expiry: '', cvc: '' }; // Скидаємо помилки
        let isValid = true;
        const cardNumber = this.card.number.replace(/\s/g, '');

        // Функція для безпечного доступу до перекладів
        const safeT = (key, fallback) => {
            try {
                const translation = $store.i18n?.t(key);
                return (translation && translation !== key) ? translation : fallback;
            } catch (e) {
                return fallback;
            }
        };

        // Прості перевірки (довжина, тільки цифри) - для реального додатку потрібна бібліотека валідації карт
        if (!cardNumber || cardNumber.length < 13 || cardNumber.length > 19 || !/^\d+$/.test(cardNumber)) {
            this.cardError.number = safeT('premium.errorCardNumber', 'Введіть коректний номер картки'); 
            isValid = false;
        }
        if (!this.card.name.trim()) {
            this.cardError.name = safeT('premium.errorCardName', 'Введіть ім\'я власника картки'); 
            isValid = false;
        }
        // Перевірка терміну дії (формат MM/YY та дата в майбутньому)
        if (!/^(0[1-9]|1[0-2])\/?([0-9]{2})$/.test(this.card.expiry)) {
            this.cardError.expiry = safeT('premium.errorCardExpiry', 'Введіть дату у форматі MM/YY'); 
            isValid = false;
        } else {
            const [month, year] = this.card.expiry.split('/');
            const expiryDate = new Date(parseInt(`20${year}`, 10), parseInt(month, 10), 1); // Дата - перший день наступного місяця
            const currentDate = new Date();
            currentDate.setDate(1); // Порівнюємо тільки місяць та рік
            currentDate.setHours(0,0,0,0);
            if (expiryDate <= currentDate) {
                this.cardError.expiry = safeT('premium.errorCardExpiryPast', 'Термін дії картки минув'); 
                isValid = false;
            }
        }
        // Перевірка CVC (3 або 4 цифри)
        if (!/^[0-9]{3,4}$/.test(this.card.cvc)) {
            this.cardError.cvc = safeT('premium.errorCardCVC', 'Введіть коректний CVC код'); 
            isValid = false;
        }
        if (!this.termsAgreed) {
            // Використовуємо загальну помилку paymentError для угоди
            this.paymentError = safeT('premium.errorTermsRequired', 'Будь ласка, прийміть умови використання');
            isValid = false;
        }
        return isValid;
    },
    get isCryptoFormValid() {
        return this.cryptoAddress && this.cryptoAmount && this.termsAgreed;
    },

    // --- Сповіщення ---
    showNotification(message, isSuccess = true) {
        this.notificationMessage = message;
        const notificationElement = document.getElementById('global-notification');
        if (notificationElement) {
            notificationElement.classList.toggle('success', isSuccess);
            notificationElement.classList.toggle('error', !isSuccess);
            notificationElement.classList.add('show'); // Додаємо клас show для анімації
        }
        this.notificationVisible = true;
        if (this.notificationTimeout) clearTimeout(this.notificationTimeout);
        this.notificationTimeout = setTimeout(() => { 
            this.notificationVisible = false;
            // Перевіряємо чи елемент все ще існує
            const notificationEl = document.getElementById('global-notification');
            if (notificationEl) {
                notificationEl.classList.remove('show');
            }
        }, 4000);
    },

    // --- Методи ---
    async init() {
        try {
            this.isLoggedIn = api.utils.isAuthenticated();
        } catch (error) {
            console.error('Error checking authentication status:', error);
            this.isLoggedIn = false;
        }

        this.isLoadingPlans = true;
        this.isLoadingUserStatus = true;
        
        try {
            // Запускаємо завантаження паралельно з обробкою помилок
            await Promise.all([
                this.fetchPlans().catch(error => {
                    console.error('Error fetching plans:', error);
                    this.plansError = error.message || $store.i18n?.t('premium.loadingPlansError') || 'Помилка завантаження планів';
                }),
                this.isLoggedIn ? this.fetchUserSubscriptionStatus().catch(error => {
                    console.error('Error fetching subscription status:', error);
                    // Не показуємо помилку 404 як критичну
                    if (!error.message.toLowerCase().includes('not found') && !error.message.includes('404')) {
                        this.userStatusError = error.message || $store.i18n?.t('premium.loadingSubscriptionError') || 'Помилка завантаження статусу підписки';
                    }
                }) : Promise.resolve()
            ]);

            // Вибираємо план за замовчуванням після завантаження
            if (this.plans.length > 0 && !this.selectedPlanSlug) {
                const defaultPlan = this.plans.find(p => p.isPopular) || this.plans[1] || this.plans[0]; // Преміум або перший доступний
                if (defaultPlan && defaultPlan.slug !== 'basic') { // Не вибираємо базовий за замовчуванням
                    this.selectedPlanSlug = defaultPlan.slug;
                } else if (this.plans.length > 1 && this.plans[1].slug !== 'basic') {
                    this.selectedPlanSlug = this.plans[1].slug;
                } else if (this.plans.length > 0 && this.plans[0].slug !== 'basic') {
                    this.selectedPlanSlug = this.plans[0].slug;
                }
            }

            // Якщо користувач вже має підписку, переходимо на крок підтвердження
            if (this.userSubscription) {
                this.prepareConfirmationData();
                this.currentStep = 3;
            }
        } catch (error) {
            console.error('Initialization error:', error);
        } finally {
            // Завершуємо індикатори завантаження
            this.isLoadingPlans = false;
            this.isLoadingUserStatus = false;
        }
    },
    async fetchPlans() {
        this.plansError = null;
        try {
            console.log('Simulating API call: getPlans');
            await new Promise(resolve => setTimeout(resolve, 400));
            // const fetchedPlans = await api.premium.getPlans(); // Реальний виклик
            // Симуляція планів з використанням i18n
            this.plans = [
                { _id: 'plan_basic', name: $store.i18н.t('premium.basicPlanName'), slug: 'basic', monthlyPrice: 0, yearlyPrice: 0, features: [
                    { text: $store.i18н.t('premium.benefitFreeStories') || 'Обмежена кількість історій', available: true },
                    { text: $store.i18н.t('premium.benefitLimitedBookmarks') || 'Обмежені закладки', available: true },
                    { text: $store.i18н.t('premium.benefitCommunitySupport') || 'Підтримка спільноти', available: true },
                    { text: $store.i18н.t('premium.benefitExclusive') || 'Ексклюзивний контент', available: false },
                    { text: $store.i18н.t('premium.benefitNoAds') || 'Без реклами', available: false },
                    { text: $store.i18н.t('premium.benefitOffline') || 'Офлайн-читання', available: false },
                    { text: $store.i18н.t('premium.benefitTranslation') || 'Переклад історій', available: false }
                ], isPopular: false },
                { _id: 'plan_prem', name: $store.i18н.t('premium.premiumPlanName'), slug: 'premium', monthlyPrice: 199, yearlyPrice: 1990, features: [
                    { text: $store.i18н.t('premium.benefitAllStories') || 'Усі історії без обмежень', available: true },
                    { text: $store.i18н.t('premium.benefitUnlimitedBookmarks') || 'Необмежені закладки', available: true },
                    { text: $store.i18н.t('premium.benefitPrioritySupport') || 'Пріоритетна підтримка', available: true },
                    { text: $store.i18н.t('premium.benefitExclusive') || 'Ексклюзивний контент', available: true },
                    { text: $store.i18н.t('premium.benefitNoAds') || 'Без реклами', available: true },
                    { text: $store.i18н.t('premium.benefitOffline') || 'Офлайн-читання', available: false }, // Приклад: недоступно
                    { text: $store.i18н.t('premium.benefitTranslation') || 'Переклад історій', available: true } // Доступно в Premium
                ], isPopular: true },
                { _id: 'plan_vip', name: $store.i18н.t('premium.vipPlanName'), slug: 'vip', monthlyPrice: 349, yearlyPrice: 3490, features: [
                    { text: $store.i18н.t('premium.benefitAllStories') || 'Усі історії без обмежень', available: true },
                    { text: $store.i18н.t('premium.benefitUnlimitedBookmarks') || 'Необмежені закладки', available: true },
                    { text: $store.i18н.t('premium.benefitVIPSupport') || 'VIP підтримка', available: true },
                    { text: $store.i18н.t('premium.benefitExclusive') || 'Ексклюзивний контент', available: true },
                    { text: $store.i18н.t('premium.benefitNoAds') || 'Без реклами', available: true },
                    { text: $store.i18н.t('premium.benefitOffline') || 'Офлайн-читання', available: true }, // Доступно в VIP
                    { text: $store.i18н.t('premium.benefitTranslation') || 'Переклад історій', available: true }
                ], isPopular: false }
            ];
        } catch (error) {
            this.plansError = error.message || $store.i18н.t('premium.loadingPlansError'); // i18н
            console.error('Fetch plans error:', error);
        }
    },
    async fetchUserSubscriptionStatus() {
        if (!this.isLoggedIn) { this.isLoadingUserStatus = false; return; }
        this.userStatusError = null;
        try {
            console.log('Simulating API call: getCurrentSubscription');
            await new Promise(resolve => setTimeout(resolve, 300));
            // const subscription = await api.premium.getCurrentSubscription(); // Реальний виклик
            // Симуляція: підписки немає
            const subscription = null;
            this.userSubscription = subscription;
            api.utils.setPremiumStatus(!!subscription); // Оновлюємо статус в localStorage
        } catch (error) {
            // Не показуємо помилку 404 як критичну
            if (!error.message.toLowerCase().includes('not found') && !error.message.includes('404')) {
                this.userStatusError = error.message || $store.i18н.t('premium.loadingSubscriptionError'); // i18н
                console.error('Fetch subscription status error:', error);
            } else {
                api.utils.setPremiumStatus(false); // Переконуємось, що статус false
                this.userSubscription = null; // Немає підписки
            }
        } finally { this.isLoadingUserStatus = false; }
    },
    selectPlan(planSlug) {
        if (planSlug === 'basic') return; // Не дозволяємо вибирати базовий план
        this.selectedPlanSlug = planSlug;
    },
    toggleBillingCycle() { this.isYearlyBilling = !this.isYearlyBilling; },
    proceedToPayment() {
        if (!this.selectedPlan || this.selectedPlan.slug === 'basic') {
            this.showNotification($store.i18н.t('premium.errorSelectPlan'), false); // i18н, false=помилка
            return;
        }
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        // Скидаємо стан форми оплати
        this.couponError = null; this.couponSuccessMessage = null; this.paymentError = null;
        this.cardError = { number: '', name: '', expiry: '', cvc: '' }; this.termsAgreed = false;
        this.card = { number: '', name: '', expiry: '', cvc: '' }; // Очищуємо дані картки
        this.couponCode = ''; this.appliedCoupon = null; // Очищуємо купон

        if (this.activePaymentMethod === 'crypto') { this.updateCryptoDetails(); } // Оновлюємо дані для крипти
        this.currentStep = 2;
        this.$nextTick(() => document.getElementById('payment-form-section')?.scrollIntoView({ behavior: 'smooth' }));
    },
    async applyCoupon() {
        if (!this.couponCode.trim() || !this.selectedPlan || this.isApplyingCoupon) return;
        this.isApplyingCoupon = true; this.couponError = null; this.couponSuccessMessage = null; this.appliedCoupon = null; // Скидаємо перед перевіркою
        try {
            const planId = this.selectedPlan._id;
            const billingCycle = this.isYearlyBilling ? 'yearly' : 'monthly';
            console.log(`Simulating API call: validateCoupon('${this.couponCode.trim()}', '${planId}', '${billingCycle}')`);
            await new Promise(resolve => setTimeout(resolve, 600));
            // const response = await api.premium.validateCoupon(this.couponCode.trim(), planId, billingCycle); // Реальний виклик
            let response; // Симуляція
            if (this.couponCode.trim().toUpperCase() === 'SALE20') {
                 response = { valid: true, code: 'SALE20', discountType: 'percentage', discountValue: 20, message: $store.i18н.t('premium.couponAppliedSuccess', { discount: '20%' }) }; // i18н
            } else if (this.couponCode.trim().toUpperCase() === 'FIRST50') {
                 response = { valid: true, code: 'FIRST50', discountType: 'fixed', discountValue: 50, message: $store.i18н.t('premium.couponAppliedSuccess', { discount: '50₴' }) }; // i18н
            } else {
                 response = { valid: false, message: $store.i18н.t('premium.couponInvalidError') }; // i18н
            }

            if (response && response.valid) {
                this.appliedCoupon = response;
                this.couponSuccessMessage = response.message || $store.i18н.t('premium.couponAppliedSuccessDefault'); // i18н fallback
            } else { throw new Error(response?.message || $store.i18н.t('premium.couponInvalidError')); }
        } catch (error) {
            this.couponError = error.message || $store.i18н.t('premium.couponApplyError'); // i18н
            console.error('Apply coupon error:', error);
        } finally { this.isApplyingCoupon = false; }
    },
    async submitPayment() {
        this.paymentError = null; // Скидаємо загальну помилку
        if (this.activePaymentMethod === 'card' && !this.validateCardForm()) { return; }
        if (this.activePaymentMethod === 'crypto' && !this.isCryptoFormValid) {
            this.paymentError = $store.i18н.t('premium.errorTermsRequired'); return;
        }

        this.isProcessingPayment = true;
        try {
            const subscriptionData = {
                planId: this.selectedPlan._id,
                billingCycle: this.isYearlyBilling ? 'yearly' : 'monthly',
                paymentMethod: this.activePaymentMethod,
                couponCode: this.appliedCoupon?.code || null
            };
            // Додаємо специфічні дані для методу оплати
            if (this.activePaymentMethod === 'card') {
                // В реальному додатку тут буде токен, отриманий від Stripe/LiqPay/іншої системи
                subscriptionData.paymentToken = 'card_token_placeholder_' + Date.now();
            } else if (this.activePaymentMethod === 'crypto') {
                subscriptionData.cryptoType = this.selectedCrypto;
                subscriptionData.transactionId = 'crypto_tx_placeholder_' + Date.now(); // Припускаємо, що ID транзакції передається
            }

            console.log('Simulating API call: subscribe', subscriptionData);
            await new Promise(resolve => setTimeout(resolve, 1500));
            // const createdSubscription = await api.premium.subscribe(subscriptionData); // Реальний виклик

            // --- Симуляція успішної відповіді API ---
            const createdSubscription = {
                _id: 'sub_' + Date.now(),
                plan: { name: this.selectedPlan.name },
                status: 'active',
                endDate: this.isYearlyBilling
                    ? new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString()
                    : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                paymentMethodLast4: this.activePaymentMethod === 'card' ? this.card.number.slice(-4) : null
             };
            this.userSubscription = createdSubscription;
            // --- Кінець симуляції ---

            api.utils.setPremiumStatus(true); // Оновлюємо статус користувача
            this.prepareConfirmationData(); // Готуємо дані для відображення
            this.currentStep = 3;
            this.$nextTick(() => document.getElementById('confirmation-section')?.scrollIntoView({ behavior: 'smooth' }));

        } catch (error) {
            this.paymentError = error.message || $store.i18н.t('premium.paymentErrorDefault'); // i18н
            console.error('Payment error:', error);
        } finally { this.isProcessingPayment = false; }
    },
    prepareConfirmationData() {
        if (!this.userSubscription) return; // Перевірка наявності підписки
        this.paymentResult = {
            planName: this.userSubscription.plan?.name || this.currentPlanName,
            billingCycle: this.isYearlyBilling ? $store.i18н.t('premium.yearlySubscription') : $store.i18н.t('premium.monthlySubscription'),
            amount: this.currentPlanPriceDetails.price, // Використовуємо розраховану ціну
            currency: '₴', // Або з API
            status: $store.i18н.t('premium.statusActive') || 'Активна',
            nextBillingDate: this.userSubscription.endDate ? new Date(this.userSubscription.endDate).toLocaleDateString($store.i18н.selectedLang || 'uk-UA') : $store.i18н.t('premium.nextBillingNA') || 'Не застосовується',
            paymentMethod: this.activePaymentMethod === 'card'
                ? ($store.i18н.t('premium.paymentMethodCardLabel') || 'Банківська картка') + (this.userSubscription.paymentMethodLast4 ? ` **** ${this.userSubscription.paymentMethodLast4}` : '')
                : ($store.i18н.t('premium.paymentMethodCryptoLabel') || 'Криптовалюта') + ` (${this.selectedCrypto})`
        };
    },
    restartProcess() { // Повернення до вибору плану
        this.currentStep = 1;
        // this.selectedPlanSlug = null; // Можна не скидати, щоб залишити вибір
        this.userSubscription = null;
        this.paymentResult = null;
        this.paymentError = null;
        this.couponError = null;
        this.couponSuccessMessage = null;
    },
    // --- Форматування полів картки ---
    formatCardNumber() {
        // Видаляємо все, крім цифр
        let value = this.card.number.replace(/\D/g, '');
        // Додаємо пробіли після кожних 4 цифр
        let formattedValue = '';
        for (let i = 0; i < value.length; i++) {
            if (i > 0 && i % 4 === 0) {
                formattedValue += ' ';
            }
            formattedValue += value[i];
        }
        // Обмежуємо довжину (макс 16 цифр + 3 пробіли)
        this.card.number = formattedValue.substring(0, 19);
        // Валідація при вводі
        if (this.cardError.number) this.validateCardForm();
    },
    formatExpiryDate() {
        let value = this.card.expiry.replace(/\D/g, '');
        if (value.length > 2) {
            // Додаємо слеш після місяця
            value = value.substring(0, 2) + '/' + value.substring(2);
        }
        // Обмежуємо довжину MM/YY
        this.card.expiry = value.substring(0, 5);
        // Валідація при вводі
        if (this.cardError.expiry) this.validateCardForm();
    },
    formatCVC() {
        // Дозволяємо тільки цифри і обмежуємо до 4
        this.card.cvc = this.card.cvc.replace(/\D/g, '').substring(0, 4);
        // Валідація при вводі
        if (this.cardError.cvc) this.validateCardForm();
    },
    // --- Оновлення даних для крипто-оплати ---
    updateCryptoDetails() {
        if (!this.selectedPlan) return; // Не оновлюємо, якщо план не вибрано
        console.log(`Updating crypto details for ${this.selectedCrypto}`);
        // В реальності ці дані мають приходити з API на основі плану, циклу та обраної крипти
        const price = this.currentPlanPriceDetails.price;
        let amount = 0;
        let address = '';

        // --- Симуляція ---
        if (this.selectedCrypto === 'BTC') {
            amount = (price / 1800000).toFixed(8); // Приблизна ціна BTC
            address = 'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh';
        } else if (this.selectedCrypto === 'ETH') {
            amount = (price / 100000).toFixed(6); // Приблизна ціна ETH
            address = '0xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe';
        } else if (this.selectedCrypto === 'USDT') {
            amount = price.toFixed(2); // USDT ~ 1:1 з UAH (дуже грубо)
            address = 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t'; // TRC20 Address Example
        }
        this.cryptoAmount = amount;
        this.cryptoAddress = address;
        console.log(`Simulated ${this.selectedCrypto} amount: ${this.cryptoAmount}, address: ${this.cryptoAddress}`);
        // --- Кінець симуляції ---

        // TODO: Запит до API для отримання реальної адреси та суми
        // try {
        //     const cryptoData = await api.premium.getCryptoPaymentDetails(this.selectedPlan._id, this.isYearlyBilling, this.selectedCrypto, this.appliedCoupon?.code);
        //     this.cryptoAddress = cryptoData.address;
        //     this.cryptoAmount = cryptoData.amount;
        // } catch (err) {
        //     this.paymentError = `Не вдалося отримати деталі для оплати ${this.selectedCrypto}: ${err.message}`;
        //     this.cryptoAddress = '';
        //     this.cryptoAmount = '';
        // }
    },
    // --- Покращене копіювання до буфера обміну ---
    async copyToClipboard(text) {
        try {
            // Перевіряємо чи доступне API буфера обміну
            if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                await navigator.clipboard.writeText(text);
                this.showNotification($store.i18н?.t('premium.cryptoCopied') || 'Скопійовано до буфера обміну', true);
            } else {
                // Запасний варіант із тимчасовим елементом input
                const tempInput = document.createElement('input');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                this.showNotification($store.i18н?.t('premium.cryptoCopied') || 'Скопійовано до буфера обміну', true);
            }
        } catch (err) {
            console.error('Clipboard copy error:', err);
            this.showNotification($store.i18н?.t('premium.cryptoCopyError') || 'Помилка копіювання', false);
        }
    },
    // --- Додаткова функція для збереження стану підписки ---
    updateUserPremiumStatus(status) {
        try {
            api.utils.setPremiumStatus(status);
        } catch (error) {
            console.error('Error updating premium status:', error);
            // Спробуємо альтернативний варіант
            try {
                localStorage.setItem('isPremium', status ? 'true' : 'false');
            } catch (localStorageError) {
                console.error('Error saving to localStorage:', localStorageError);
            }
        }
    },
    // --- Допоміжна функція форматування ціни ---
    formatPrice(price) {
        if (price === null || price === undefined) return '0';
        
        // Визначаємо поточну локаль з урахуванням можливих помилок
        let locale;
        try {
            locale = $store.i18n?.selectedLang || 'uk-UA';
        } catch (error) {
            locale = 'uk-UA'; // Запасний варіант
        }
        
        try {
            return price.toLocaleString(locale);
        } catch (error) {
            // Запасний варіант форматування
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }
    },
}" x-init="init()">

<!-- Індикатор завантаження під час обробки платежу -->
<div x-show="isProcessingPayment" class="loading-overlay" x-transition>
    <div class="loading-spinner"></div>
    <p x-text="$store.i18н.t('premium.processingPayment')"></п>
</div>

<!-- Хедер -->
<header>
    <div class="container">
        <nav class="navbar">
            <a href="index.html" class="logo">Таємний<span>Світ</span></а>
            <!-- Навігація з i18н -->
            <ул class="nav-links">
                <ли><a href="index.html" x-text="$store.i18н.t('general.home')"></а></ли>
                <ли><a href="new-stories.html" x-text="$store.i18н.t('general.newStories')"></а></ли>
                <ли><a href="top-stories.html" x-text="$store.i18н.t('general.topStories')"></а></ли>
                <ли><a href="categories.html" x-text="$store.i18н.t('general.categories')"></а></ли>
                <ли><a href="authors.html" x-text="$store.i18н.t('general.authors')"></а></ли>
            </ул>
            <div class="auth-buttons">
                <!-- Мовний перемикач -->
                <div class="lang-dropdown-container" x-data="{ open: false }" @click.away="open = false">
                    <div class="lang-dropdown-button" @click="open = !open">
                        <span x-text="$store.i18н.selectedLang.toUpperCase()"></span>
                        <i class="fas fa-chevron-down" :class="{ 'rotate-180': open }"></и>
                    </div>
                    <div class="lang-dropdown-menu" x-show="open" x-transition>
                        <template x-for="lang in $store.i18н.available" :key="lang.code">
                            <div class="lang-dropdown-item"
                                 :class="{ 'active': lang.code === $store.i18н.selectedLang }"
                                 @click="$store.i18н.setLanguage(lang.code); open = false;">
                                <span x-text="lang.name"></span>
                                <i x-show="lang.code === $store.i18н.selectedLang" class="fas fa-check"></и>
                            </div>
                        </template>
                    </div>
                </div>
                <!-- Кнопки авторизації -->
                <template x-if="!isLoggedIn">
                    <div>
                        <a href="login.html" class="btn btn-outline">
                            <i class="fas fa-sign-in-alt"></и> <span x-text="$store.i18н.t('general.login')"></span>
                        </а>
                        <a href="register-page.html" class="btn btn-primary">
                            <i class="fas fa-user-plus"></и> <span x-text="$store.i18н.t('general.register')"></span>
                        </а>
                    </div>
                </template>
                <template x-if="isLoggedIn">
                    <div>
                        <a href="profile.html" class="btn btn-outline">
                            <i class="fas fa-user"></и> <span x-text="$store.i18н.t('general.profile')"></span>
                        </а>
                        <!-- Безпечний обробник виходу -->
                        <a href="#" @click.prevent="
                            try { 
                                api.auth.logout();
                                updateUserPremiumStatus(false); // Оновлюємо статус преміум
                                setTimeout(() => window.location.href = 'index.html', 100);
                            } catch (error) { 
                                console.error('Logout error:', error);
                                showNotification($store.i18н.t('general.logoutError') || 'Помилка при виході', false);
                            }
                        " class="btn btn-primary">
                            <i class="fas fa-sign-out-alt"></и> <span x-text="$store.i18н.t('general.logout')"></span>
                        </а>
                    </div>
                </template>
            </div>
        </nav>
    </div>
</header>

<!-- Основний контент -->
<main>
    <!-- Хлібні крихти -->
    <div class="container">
        <div class="breadcrumbs">
            <a href="index.html" x-text="$store.i18н.t('general.home')"></а>
            <span class="separator">/</span>
            <span class="current" x-text="$store.i18н.t('general.premium')"></span>
        </div>
    </div>

    <!-- Hero секція -->
    <section class="premium-hero">
        <div class="container">
            <div class="premium-hero-content">
                <div class="premium-icon"><i class="fas fa-crown"></и></div>
                <h1 class="premium-title" x-text="$store.i18н.t('premium.heroTitle')"></h1>
                <п class="premium-subtitle" x-text="$store.i18н.t('premium.heroSubtitle')"></п>
                <div class="hero-features">
                    <div class="hero-feature"><i class="fas fa-lock-open"></и> <span x-text="$store.i18н.t('premium.heroFeatureAccess')"></span></div>
                    <div class="hero-feature"><i class="fas fa-language"></и> <span x-text="$store.i18н.t('premium.heroFeatureTranslate')"></span></div>
                    <div class="hero-feature"><i class="fas fa-ad"></и> <span x-text="$store.i18н.t('premium.heroFeatureNoAds')"></span></div>
                    <div class="hero-feature"><i class="fas fa-star"></и> <span x-text="$store.i18н.t('premium.heroFeatureExclusive')"></span></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Індикатор завантаження планів/статусу -->
    <div x-show="isLoadingPlans || isLoadingUserStatus" class="container loading-indicator-small">
        <div class="loading-spinner-small"></и> <span x-text="$store.i18н.t('general.loadingData')"></span>
    </div>
    <!-- Помилка завантаження планів -->
    <div x-show="plansError" class="container error-message-small">
        <i class="fas fa-exclamation-circle"></и> <span x-text="plansError"></span>
        <button @click="fetchPlans()" class="btn btn-outline" x-text="$store.i18н.t('general.retryButton')"></button>
    </div>
    <!-- Помилка завантаження статусу підписки -->
    <div x-show="userStatusError" class="container error-message-small">
        <i class="fas fa-exclamation-circle"></и> <span x-text="userStatusError"></span>
        <button @click="fetchUserSubscriptionStatus()" class="btn btn-outline" x-text="$store.i18н.t('general.retryButton')"></button>
    </div>

    <!-- Інструкція зі статусною панеллю -->
    <section class="container steps-section" x-show="!isLoadingPlans && !isLoadingUserStatus && plans.length > 0">
        <div class="steps-container">
            <div class="step" :class="{ 'active': currentStep >= 1, 'completed': currentStep > 1 }">
                <div class="step-indicator"> <i x-show="currentStep > 1" class="fas fa-check"></и> <span x-show="currentStep <= 1">1</span> </div>
                <div class="step-details"> <h3 class="step-title" x-text="$store.i18н.t('premium.step1Title')"></h3> <п class="step-description" x-text="$store.i18н.t('premium.step1Desc')"></п> </div>
            </div>
            <div class="step-connector" :class="{ 'active': currentStep > 1 }"></div>
            <div class="step" :class="{ 'active': currentStep >= 2, 'completed': currentStep > 2 }">
                <div class="step-indicator"> <i x-show="currentStep > 2" class="fas fa-check"></и> <span x-show="currentStep <= 2">2</span> </div>
                <div class="step-details"> <h3 class="step-title" x-text="$store.i18н.t('premium.step2Title')"></h3> <п class="step-description" x-text="$store.i18н.t('premium.step2Desc')"></п> </div>
            </div>
            <div class="step-connector" :class="{ 'active': currentStep > 2 }"></div>
            <div class="step" :class="{ 'active': currentStep >= 3 }">
                <div class="step-indicator"> <i x-show="currentStep >= 3" class="fas fa-check"></и> <span x-show="currentStep < 3">3</span> </div>
                <div class="step-details"> <h3 class="step-title" x-text="$store.i18н.t('premium.step3Title')"></h3> <п class="step-description" x-text="$store.i18н.t('premium.step3Desc')"></п> </div>
            </div>
        </div>
    </section>

    <!-- Плани підписки -->
    <section class="plans-section" x-show="currentStep === 1 && !isLoadingPlans && !isLoadingUserStatus && plans.length > 0">
        <div class="container">
            <h2 class="section-title" x-text="$store.i18н.t('premium.plansTitle')"></h2>

            <div class="billing-toggle">
                <span :class="{ 'active': !isYearlyBilling }" x-text="$store.i18н.t('premium.monthly')"></span>
                <div class="toggle-switch" @click="toggleBillingCycle()" role="switch" :aria-checked="isYearlyBilling.toString()" tabindex="0" @keydown.enter.space.prevent="toggleBillingCycle()">
                    <div class="toggle-slider" :class="{ 'yearly': isYearlyBilling }"></div>
                </div>
                <span :class="{ 'active': isYearlyBilling }" x-text="$store.i18н.t('premium.yearly')"></span>
                <!-- Показуємо відсоток економії для річного плану -->
                <div class="discount-badge" x-show="isYearlyBilling && currentPlanPriceDetails.yearlySavingsPercent > 0" x-text="$store.i18н.t('premium.yearlySave', { percent: currentPlanPriceDetails.yearlySavingsPercent })"></div>
            </div>

            <div class="plans-grid">
                <template x-for="plan in plans" :key="plan.slug">
                    <div class="plan-card" :class="{ 'selected': selectedPlanSlug === plan.slug, 'popular': plan.isPopular }" @click="selectPlan(plan.slug)" tabindex="0" @keydown.enter.space.prevent="selectPlan(plan.slug)">
                        <div x-show="plan.isPopular" class="popular-badge" x-text="$store.i18н.t('premium.recommendedBadge')"></div>
                        <div class="plan-header">
                            <h3 class="plan-name" x-text="plan.name"></h3>
                            <div class="plan-price">
                                <span class="currency">₴</span>
                                <!-- Динамічна ціна залежно від циклу оплати -->
                                <span class="amount" x-text="isYearlyBilling ? plan.yearlyPrice.toLocaleString($store.i18н.selectedLang || 'uk-UA') : plan.monthlyPrice.toLocaleString($store.i18н.selectedLang || 'uk-UA')"></span>
                                <span class="period" x-text="isYearlyBilling ? $store.i18н.t('premium.perYear') : $store.i18н.t('premium.perMonth')"></span>
                            </div>
                            <!-- Еквівалентна місячна ціна для річного плану -->
                            <div class="price-detail" x-show="isYearlyBilling && plan.yearlyPrice && plan.monthlyPrice && plan.monthlyPrice > 0" x-text="$store.i18н.t('premium.monthlyEquivalent', { price: (plan.yearlyPrice / 12).toFixed(0) })"></div>
                            <div class="price-detail" x-show="!isYearlyBilling || !(plan.yearlyPrice && plan.monthlyPrice)"> </div> <!-- Placeholder для вирівнювання -->
                        </div>
                        <div class="plan-features">
                            <template x-for="feature in plan.features" :key="feature.text">
                                <div class="plan-feature" :class="{ 'inactive': !feature.available }">
                                    <i :class="feature.available ? 'fas fa-check' : 'fas fa-times'"></и>
                                    <span x-text="feature.text"></span>
                                </div>
                            </template>
                        </div>
                        <div class="plan-action" x-show="plan.slug !== 'basic'"> <!-- Не показуємо кнопку для базового -->
                            <button type="button" class="btn" :class="selectedPlanSlug === plan.slug ? 'btn-primary' : 'btn-outline'" @click.stop="selectPlan(plan.slug)">
                                <span x-text="selectedPlanSlug === plan.slug ? $store.i18н.t('premium.selected') : $store.i18н.t('premium.selectPlanButton')"></span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Інформація про обраний план і кнопка -->
            <div class="selected-plan-info" x-show="selectedPlan">
                <div class="selected-plan-details">
                    <h3><span x-text="$store.i18н.t('premium.selectedPlanLabel')"></span> <span x-text="currentPlanName"></span></h3>
                    <п>
                        <strong x-text="isYearlyBilling ? $store.i18н.t('premium.yearlySubscription') : $store.i18н.t('premium.monthlySubscription')"></strong> -
                        <span x-text="currentPlanPriceDetails.price.toLocaleString($store.i18н.selectedLang || 'uk-UA')"></span> ₴
                        <span x-text="currentPlanPriceDetails.period"></span>
                        <template x-if="isYearlyBilling && currentPlanPriceDetails.yearlySavingsPercent > 0 && !appliedCoupon">
                            <span class="discount-info" x-text="$store.i18н.t('premium.yearlySave', { percent: currentPlanPriceDetails.yearlySavingsPercent })"></span>
                        </template>
                        <template x-if="appliedCoupon">
                            <span class="discount-info" style="background-color: rgba(0, 150, 0, 0.1); color: #4cd964;">
                                <span x-text="$store.i18н.t('premium.discountLabel')"></span> <span x-text="currentPlanPriceDetails.couponDiscount.toLocaleString($store.i18н.selectedLang || 'uk-UA')"></span> ₴
                            </span>
                        </template>
                    </п>
                </div>
                <button class="btn btn-primary continue-btn" @click="proceedToPayment()">
                    <span x-text="$store.i18н.t('premium.continueButton')"></span> <i class="fas fa-arrow-right"></и>
                </button>
            </div>

            <div class="plan-guarantee">
                <i class="fas fa-shield-alt"></и>
                <п x-text="$store.i18н.t('premium.guaranteeText')"></п>
            </div>
        </div>
    </section>

    <!-- Форма оплати -->
    <section id="payment-form-section" class="payment-section" x-show="currentStep === 2" x-transition>
        <div class="container">
            <h2 class="section-title" x-text="$store.i18н.t('premium.paymentTitle')"></h2>

            <!-- Помилка оплати загальна -->
            <div x-show="paymentError" class="error-message-small" style="margin-bottom: 1rem;">
                <i class="fas fa-exclamation-circle"></и> <span x-text="paymentError"></span>
                <button @click="paymentError = null" class="btn btn-outline" style="margin-left: auto; padding: 0.3rem 0.8рем; font-size: 0.8rem;" x-text="$store.i18н.t('general.close')"></button>
            </div>

            <div class="payment-summary">
                <div class="summary-details">
                    <div class="summary-plan">
                        <h4><span x-text="$store.i18н.t('premium.confirmationPlanLabel')"></span> "<span x-text="currentPlanName"></span>"</h4>
                        <п x-text="isYearlyBilling ? $store.i18н.t('premium.yearlySubscription') : $store.i18н.t('premium.monthlySubscription')"></п>
                    </div>
                    <div class="summary-price">
                        <!-- Ціна до знижки (якщо є купон) -->
                        <span x-show="appliedCoupon" style="text-decoration: line-through; font-size: 1.5rem; color: var(--secondary-text); margin-right: 10px;" x-text="currentPlanPriceDetails.rawPrice.toLocaleString($store.i18н.selectedLang || 'uk-UA') + ' ₴'"></span>
                        <!-- Фінальна ціна -->
                        <span x-text="currentPlanPriceDetails.price.toLocaleString($store.i18н.selectedLang || 'uk-UA')"></span> ₴
                    </div>
                </div>
                <div class="coupon-section">
                    <form class="coupon-form" @submit.prevent="applyCoupon()">
                        <input type="text" x-model="couponCode" :placeholder="$store.i18н.t('premium.promoCodePlaceholder')" class="coupon-input" :disabled="isApplyingCoupon">
                        <button type="submit" class="btn btn-outline coupon-btn" :disabled="isApplyingCoupon || !couponCode.trim()">
                            <span x-show="!isApplyingCoupon" x-text="$store.i18н.t('premium.applyButton')"></span>
                            <span x-show="isApplyingCoupon"><i class="fas fa-spinner fa-spin"></и> <span x-text="$store.i18н.t('premium.applying')"></span></span>
                        </button>
                    </form>
                    <!-- Повідомлення про купон -->
                    <div x-show="couponError" class="form-notification error">
                        <i class="fas fa-times-circle"></и> <span x-text="couponError"></span>
                    </div>
                    <div x-show="couponSuccessMessage" class="form-notification success">
                        <i class="fas fa-check-circle"></и> <span x-text="couponSuccessMessage"></span>
                    </div>
                </div>
            </div>

            <div class="payment-form">
                <div class="form-tabs">
                    <button type="button" @click="activePaymentMethod = 'card'" class="form-tab" :class="{ 'active': activePaymentMethod === 'card' }">
                        <i class="fas fa-credit-card"></и> <span x-text="$store.i18н.t('premium.paymentMethodCard')"></span>
                    </button>
                    <button type="button" @click="activePaymentMethod = 'crypto'; updateCryptoDetails();" class="form-tab" :class="{ 'active': activePaymentMethod === 'crypto' }">
                        <i class="fab fa-bitcoin"></и> <span x-text="$store.i18н.t('premium.paymentMethodCrypto')"></span>
                    </button>
                </div>

                <!-- Форма оплати карткою -->
                <div x-show="activePaymentMethod === 'card'" x-transition>
                    <form class="card-form" @submit.prevent="submitPayment()" novalidate> <!-- novalidate для кастомної валідації -->
                        <div class="form-group">
                            <label for="cardNumber" class="form-label" x-text="$store.i18н.t('premium.cardNumberLabel')"></label>
                            <div class="card-input-group">
                                <input type="text" id="cardNumber" x-model="card.number" @input="formatCardNumber()" maxlength="19" inputmode="numeric" :placeholder="$store.i18н.t('premium.cardNumberPlaceholder')" required aria-required="true" :aria-invalid="cardError.number ? 'true' : 'false'">
                                <div class="card-icons"> <i class="fab fa-cc-visa"></и> <i class="fab fa-cc-mastercard"></и> </div>
                            </div>
                            <span x-show="cardError.number" class="error-message-inline" x-text="cardError.number"></span>
                        </div>
                        <div class="form-group">
                            <label for="cardName" class="form-label" x-text="$store.i18н.t('premium.cardNameLabel')"></label>
                            <input type="text" id="cardName" x-model="card.name" :placeholder="$store.i18н.t('premium.cardNamePlaceholder')" required aria-required="true" :aria-invalid="cardError.name ? 'true' : 'false'">
                            <span x-show="cardError.name" class="error-message-inline" x-text="cardError.name"></span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cardExpiry" class="form-label" x-text="$store.i18н.t('premium.cardExpiryLabel')"></label>
                                <input type="text" id="cardExpiry" x-model="card.expiry" @input="formatExpiryDate()" maxlength="5" inputmode="numeric" :placeholder="$store.i18н.t('premium.cardExpiryPlaceholder')" required aria-required="true" :aria-invalid="cardError.expiry ? 'true' : 'false'">
                                <span x-show="cardError.expiry" class="error-message-inline" x-text="cardError.expiry"></span>
                            </div>
                            <div class="form-group">
                                <label for="cardCVC" class="form-label" x-text="$store.i18н.t('premium.cardCVCLabel')"></label>
                                <input type="password" inputmode="numeric" id="cardCVC" x-model="card.cvc" @input="formatCVC()" maxlength="4" :placeholder="$store.i18н.t('premium.cardCVCPlaceholder')" required autocomplete="cc-csc" aria-required="true" :aria-invalid="cardError.cvc ? 'true' : 'false'">
                                <span x-show="cardError.cvc" class="error-message-inline" x-text="cardError.cvc"></span>
                            </div>
                        </div>
                        <div class="form-agreement">
                            <input type="checkbox" id="termsAgreementCard" x-model="termsAgreed" required aria-required="true">
                            <label for="termsAgreementCard" x-html="$store.i18н.t('premium.agreeTerms', { termsLink: `<a href='terms-page.html' target='_blank'>${$store.i18н.t('premium.termsLink')}</а>`, privacyLink: `<a href='privacy-policy.html' target='_blank'>${$store.i18н.t('premium.privacyLink')}</а>` })"></label>
                        </div>
                        <div class="form-action">
                            <!-- Виправлена кнопка оплати без постійного класу processing -->
                            <button type="submit" class="btn btn-primary pay-btn" :class="{ 'processing': isProcessingPayment }" :disabled="isProcessingPayment || !termsAgreed">
                                <span x-show="!isProcessingPayment" x-text="$store.i18н.t('premium.payButton', { amount: currentPlanPriceDetails.price.toLocaleString($store.i18н.selectedLang || 'uk-UA') })"></span>
                                <span x-show="isProcessingPayment"><i class="fas fa-spinner fa-spin"></и> <span x-text="$store.i18н.t('premium.processingPayment')"></span></span>
                            </button>
                        </div>
                        <div class="form-security">
                            <div class="security-item"><i class="fas fa-lock"></и> <span x-text="$store.i18н.t('premium.securePayment')"></span></div>
                        </div>
                    </form>
                </div>

                <!-- Форма оплати криптовалютою -->
                <div x-show="activePaymentMethod === 'crypto'" x-transition>
                    <div class="crypto-payment">
                        <div class="crypto-options">
                            <label class="crypto-option"> <input type="radio" name="cryptoType" value="BTC" x-model="selectedCrypto" @change="updateCryptoDetails()"> <i class="fab fa-bitcoin"></и> Bitcoin </label>
                            <label class="crypto-option"> <input type="radio" name="cryptoType" value="ETH" x-model="selectedCrypto" @change="updateCryptoDetails()"> <i class="fab fa-ethereum"></и> Ethereum </label>
                            <label class="crypto-option"> <input type="radio" name="cryptoType" value="USDT" x-model="selectedCrypto" @change="updateCryptoDetails()"> <i class="fas fa-dollar-sign"></и> USDT (TRC20) </label>
                        </div>
                        <div class="crypto-info" x-show="cryptoAddress">
                            <div class="qr-code">
                                <!-- Тут має бути реальний QR-код, згенерований бібліотекою -->
                                <div class="qr-placeholder" :title="$store.i18н.t('premium.qrCodeTitle')">
                                    <i class="fas fa-qrcode" style="font-size: 8rem; color: rgba(255,255,255,0.3);"></и>
                                </div>
                            </div>
                            <div class="wallet-address">
                                <п><strong x-text="$store.i18н.t('premium.cryptoSendLabel', {amount: cryptoAmount, currency: selectedCrypto})"></strong> <span x-text="$store.i18н.t('premium.cryptoToAddress')"></span></п>
                                <div class="address-box">
                                    <code x-text="cryptoAddress"></code>
                                    <button type="button" @click="copyToClipboard(cryptoAddress)" class="copy-btn" :title="$store.i18н.t('premium.cryptoCopyTooltip')"> <i class="fas fa-copy"></и> </button>
                                </div>
                                <п class="crypto-note" x-text="$store.i18н.t('premium.cryptoNote')"></п>
                            </div>
                        </div>
                        <div x-show="!cryptoAddress && activePaymentMethod === 'crypto'" class="loading-indicator-small" x-text="$store.i18н.t('premium.loadingPaymentDetails')"></div>
                        <div class="form-agreement" style="margin-top: 1rem;">
                            <input type="checkbox" id="termsAgreementCrypto" x-model="termsAgreed" required aria-required="true">
                            <label for="termsAgreementCrypto" x-html="$store.i18н.t('premium.agreeTerms', { termsLink: `<a href='terms-page.html' target='_blank'>${$store.i18н.t('premium.termsLink')}</а>`, privacyLink: `<a href='privacy-policy.html' target='_blank'>${$store.i18н.t('premium.privacyLink')}</а>` })"></label>
                        </div>
                        <div class="form-action">
                            <!-- Виправлена кнопка для оплати криптовалютою -->
                            <button type="button" class="btn btn-primary pay-btn" :class="{ 'processing': isProcessingPayment }" @click="submitPayment()" :disabled="isProcessingPayment || !isCryptoFormValid">
                                <span x-show="!isProcessingPayment" x-text="$store.i18н.t('premium.cryptoConfirmPaymentButton')"></span>
                                <span x-show="isProcessingPayment"><i class="fas fa-spinner fa-spin"></и> <span x-text="$store.i18н.t('premium.cryptoCheckingPayment')"></span></span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Підтвердження оплати -->
    <section id="confirmation-section" class="confirmation-section" x-show="currentStep === 3" x-transition>
        <div class="container">
            <div class="confirmation-card" x-show="paymentResult">
                <div class="confirmation-icon"><i class="fas fa-check-circle"></и></div>
                <h2 class="confirmation-title" x-text="$store.i18н.t('premium.confirmationTitle')"></h2>
                <п class="confirmation-message" x-html="$store.i18н.t('premium.confirmationMessage', { billingCycle: paymentResult?.billingCycle.toLowerCase(), planName: paymentResult?.planName }) || 'Підписка активована.'"></п>
                <div class="confirmation-details">
                    <div class="confirmation-detail"> <span class="detail-label" x-text="$store.i18н.t('premium.confirmationPlanLabel')"></span> <span class="detail-value" x-text="paymentResult?.planName"></span> </div>
                    <div class="confirmation-detail"> <span class="detail-label" x-text="$store.i18н.t('premium.confirmationPeriodLabel')"></span> <span class="detail-value" x-text="paymentResult?.billingCycle"></span> </div>
                    <div class="confirmation-detail"> <span class="detail-label" x-text="$store.i18н.t('premium.confirmationAmountLabel')"></span> <span class="detail-value"><span x-text="paymentResult?.amount.toLocaleString($store.i18н.selectedLang || 'uk-UA')"></span> <span x-text="paymentResult?.currency"></span></span> </div>
                    <div class="confirmation-detail"> <span class="detail-label" x-text="$store.i18н.t('premium.confirmationMethodLabel')"></span> <span class="detail-value" x-text="paymentResult?.paymentMethod"></span> </div>
                    <div class="confirmation-detail"> <span class="detail-label" x-text="$store.i18н.t('premium.confirmationStatusLabel')"></span> <span class="detail-value success" x-text="paymentResult?.status"></span> </div>
                    <div class="confirmation-detail"> <span class="detail-label" x-text="$store.i18н.t('premium.confirmationNextBillingLabel')"></span> <span class="detail-value" x-text="paymentResult?.nextBillingDate"></span> </div>
                </div>
                <div class="confirmation-actions">
                    <a href="index.html" class="btn btn-primary" x-text="$store.i18н.t('premium.confirmationActionHome')"></а>
                    <a href="profile.html" class="btn btn-outline" x-text="$store.i18н.t('premium.confirmationActionProfile')"></а>
                </div>
                <div class="confirmation-help">
                    <п x-html="$store.i18н.t('premium.confirmationHelpText', { link: `<a href='contact.html'>${$store.i18н.t('premium.confirmationHelpLink')}</а>` }) || `Маєте питання? <a href='contact.html'>Зв'яжіться з підтримкою</а>`"></п>
                </div>
            </div>
            <!-- Повідомлення про обробку даних підтвердження -->
            <div x-show="currentStep === 3 && !paymentResult" class="loading-indicator-small" x-text="$store.i18н.t('premium.processingInfo')"></div>
        </div>
    </section>

    <!-- Інші секції (Переваги, Відгуки, FAQ, CTA) -->
    <section class="benefits-section" x-show="currentStep !== 3">
        <div class="container">
            <h2 class="section-title" x-text="$store.i18н.t('premium.benefitsTitle')"></h2>
            <div class="benefits-grid">
                <div class="benefit-card">
                    <div class="benefit-icon"><i class="fas fa-book-open"></и></div>
                    <h3 class="benefit-title" x-text="$store.i18н.t('premium.benefitTitleAccess')"></h3>
                    <п class="benefit-description" x-text="$store.i18н.t('premium.benefitDescAccess')"></п>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon"><i class="fas fa-language"></и></div>
                    <h3 class="benefit-title" x-text="$store.i18н.t('premium.benefitTitleTranslate')"></h3>
                    <п class="benefit-description" x-text="$store.i18н.t('premium.benefitDescTranslate')"></п>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon"><i class="fas fa-ad"></и></div>
                    <h3 class="benefit-title" x-text="$store.i18н.t('premium.benefitTitleNoAds')"></h3>
                    <п class="benefit-description" x-text="$store.i18н.t('premium.benefitDescNoAds')"></п>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon"><i class="fas fa-star"></и></div>
                    <h3 class="benefit-title" x-text="$store.i18н.t('premium.benefitTitleExclusive')"></h3>
                    <п class="benefit-description" x-text="$store.i18н.t('premium.benefitDescExclusive')"></п>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon"><i class="fas fa-download"></и></div>
                    <h3 class="benefit-title" x-text="$store.i18н.t('premium.benefitTitleOffline')"></h3>
                    <п class="benefit-description" x-text="$store.i18н.t('premium.benefitDescOffline')"></п>
                </div>
                <div class="benefit-card">
                    <div class="benefit-icon"><i class="fas fa-headset"></и></div>
                    <h3 class="benefit-title" x-text="$store.i18н.t('premium.benefitTitleSupport')"></h3>
                    <п class="benefit-description" x-text="$store.i18н.t('premium.benefitDescSupport')"></п>
                </div>
            </div>
        </div>
    </section>

    <section class="testimonials-section" x-show="currentStep === 1">
        <div class="container">
            <h2 class="section-title" x-text="$store.i18н.t('premium.testimonialsTitle')"></h2>
            <div class="testimonials-grid">
                <!-- Приклад відгуку 1 -->
                <div class="testimonial-card">
                    <div class="testimonial-rating"><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="fas fa-star"></и></div>
                    <п class="testimonial-text" x-text="$store.i18н.t('premium.testimonial1Text')"></п>
                    <div class="testimonial-author">
                        <div class="author-avatar" style="background-image: url('https://source.unsplash.com/random/100x100/?woman,portrait')"></div>
                        <div>
                            <div class="author-name" x-text="$store.i18н.t('premium.testimonial1Author')"></div>
                            <div class="subscription-type" x-text="$store.i18н.t('premium.premiumPlanName')"></div>
                        </div>
                    </div>
                </div>
                <!-- Приклад відгуку 2 -->
                <div class="testimonial-card">
                    <div class="testimonial-rating"><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="far fa-star"></и></div>
                    <п class="testimonial-text" x-text="$store.i18н.t('premium.testimonial2Text')"></п>
                    <div class="testimonial-author">
                        <div class="author-avatar" style="background-image: url('https://source.unsplash.com/random/100x100/?man,profile')"></div>
                        <div>
                            <div class="author-name" x-text="$store.i18н.t('premium.testimonial2Author')"></div>
                            <div class="subscription-type" x-text="$store.i18н.t('premium.vipPlanName')"></div>
                        </div>
                    </div>
                </div>
                <!-- Приклад відгуку 3 -->
                <div class="testimonial-card">
                    <div class="testimonial-rating"><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="fas fa-star"></и><i class="fas fa-star-half-alt"></и></div>
                    <п class="testimonial-text" x-text="$store.i18н.t('premium.testimonial3Text')"></п>
                    <div class="testimonial-author">
                        <div class="author-avatar" style="background-image: url('https://source.unsplash.com/random/100x100/?person,face')"></div>
                        <div>
                            <div class="author-name" x-text="$store.i18н.t('premium.testimonial3Author')"></div>
                            <div class="subscription-type" x-text="$store.i18н.t('premium.premiumPlanName')"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="faq-section" x-show="currentStep !== 3">
        <div class="container">
            <h2 class="section-title" x-text="$store.i18н.t('premium.faqTitle')"></h2>
            <div class="faq-list">
                <!-- Приклад FAQ Item -->
                <div class="faq-item" x-data="{ open: false }">
                    <div class="faq-question" @click="open = !open">
                        <h3 x-text="$store.i18н.t('premium.faqQ1')"></h3>
                        <div class="faq-toggle"><i :class="open ? 'fas fa-times' : 'fas fa-plus'"></и></div>
                    </div>
                    <div class="faq-answer" x-show="open" x-collapse> <!-- Використовуємо x-collapse для анімації -->
                        <п x-text="$store.i18н.t('premium.faqA1')"></п>
                    </div>
                </div>
                <div class="faq-item" x-data="{ open: false }">
                    <div class="faq-question" @click="open = !open">
                        <h3 x-text="$store.i18н.t('premium.faqQ2')"></h3>
                        <div class="faq-toggle"><i :class="open ? 'fas fa-times' : 'fas fa-plus'"></и></div>
                    </div>
                    <div class="faq-answer" x-show="open" x-collapse>
                        <п x-text="$store.i18н.t('premium.faqA2')"></п>
                    </div>
                </div>
                <div class="faq-item" x-data="{ open: false }">
                    <div class="faq-question" @click="open = !open">
                        <h3 x-text="$store.i18н.t('premium.faqQ3')"></h3>
                        <div class="faq-toggle"><i :class="open ? 'fas fa-times' : 'fas fa-plus'"></и></div>
                    </div>
                    <div class="faq-answer" x-show="open" x-collapse>
                        <п x-text="$store.i18н.t('premium.faqA3')"></п>
                    </div>
                </div>
                <div class="faq-item" x-data="{ open: false }">
                    <div class="faq-question" @click="open = !open">
                        <h3 x-text="$store.i18н.t('premium.faqQ4')"></h3>
                        <div class="faq-toggle"><i :class="open ? 'fas fa-times' : 'fas fa-plus'"></и></div>
                    </div>
                    <div class="faq-answer" x-show="open" x-collapse>
                        <п x-text="$store.i18н.t('premium.faqA4')"></п>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="cta-section" x-show="currentStep === 1">
        <div class="container">
            <div class="cta-content">
                <h2 class="cta-title" x-text="$store.i18н.t('premium.ctaTitle')"></h2>
                <п class="cta-description" x-text="$store.i18н.t('premium.ctaDescription')"></п>
                <button class="btn btn-primary cta-button" @click="document.querySelector('.plans-section').scrollIntoView({ behavior: 'smooth' })" x-text="$store.i18н.t('premium.ctaButton')"></button>
            </div>
        </div>
    </section>

</main>

<!-- Footer -->
<footer>
    <div class="container">
        <!-- Код футера з i18н, як в index.html -->
        <div class="footer-content">
            <div class="footer-section footer-about">
                <h4 x-text="$store.i18н.t('general.about')"></h4>
                <п x-text="$store.i18н.t('general.aboutText')"></п>
                <div class="social-links">
                    <a href="#" class="social-link" :title="$store.i18н.t('general.shareFacebook')"><i class="fab fa-facebook-f"></и></а>
                    <a href="#" class="social-link" :title="$store.i18н.t('general.shareTelegram')"><i class="fab fa-telegram-plane"></и></а>
                    <a href="#" class="social-link" title="Instagram"><i class="fab fa-instagram"></и></а>
                </div>
            </div>
            <div class="footer-section">
                <h4 x-text="$store.i18н.t('general.navigation')"></h4>
                <ул>
                    <ли><a href="index.html" x-text="$store.i18н.t('general.home')"></а></ли>
                    <ли><a href="categories.html" x-text="$store.i18н.t('general.categories')"></а></ли>
                    <ли><a href="new-stories.html" x-text="$store.i18н.t('general.newStories')"></а></ли>
                    <ли><a href="top-stories.html" x-text="$store.i18н.t('general.topStories')"></а></ли>
                    <ли><a href="authors.html" x-text="$store.i18н.t('general.authors')"></а></ли>
                </ул>
            </div>
            <div class="footer-section">
                <h4 x-text="$store.i18н.t('general.support')"></h4>
                <ул>
                    <ли><a href="faq.html" x-text="$store.i18н.t('faq.title')"></а></ли>
                    <ли><a href="contact.html" x-text="$store.i18н.t('contact.title')"></а></ли>
                    <ли><a href="terms-page.html" x-text="$store.i18н.t('general.terms')"></а></ли>
                    <ли><a href="privacy-policy.html" x-text="$store.i18н.t('general.privacy')"></а></ли>
                </ул>
            </div>
            <div class="footer-section">
                <h4 x-text="$store.i18н.t('general.join')"></h4>
                <ул>
                    <ли><a href="login.html" x-text="$store.i18н.t('general.login')"></а></ли>
                    <ли><a href="login.html?tab=register" x-text="$store.i18н.t('general.register')"></а></ли>
                    <ли><a href="premium.html" x-text="$store.i18н.t('general.premium')"></а></ли>
                    <ли><a href="create_story.html" x-text="$store.i18н.t('createStory.title')"></а></ли>
                </ул>
            </div>
        </div>
        <div class="footer-bottom">
            © <span x-text="new Date().getFullYear()"></span> <span x-text="$store.i18н.t('general.copyright')"></span>. <span x-text="$store.i18н.t('general.allRightsReserved')"></span>. 18+ <br>
            <a href="terms-page.html" x-text="$store.i18н.t('general.terms')"></а> | <a href="privacy-policy.html" x-text="$store.i18н.t('general.privacy')"></а>
        </div>
    </div>
</footer>

<!-- Елемент сповіщення з оновленими класами -->
<div x-show="notificationVisible"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 translate-y-2"
     x-transition:enter-end="opacity-100 translate-y-0"
     x-transition:leave="transition ease-in duration-300"
     x-transition:leave-start="opacity-100 translate-y-0"
     x-transition:leave-end="opacity-0 -translate-y-full"
     class="notification"
     :class="{ 'show': notificationVisible, 'success': true, 'error': false }"
     style="display: none;"
     id="global-notification">
    <span x-text="notificationMessage"></span>
</div>

</body>
</html>