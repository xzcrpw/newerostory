<!DOCTYPE html>
<html lang="uk" x-data :lang="$store.i18n.selectedLang" xmlns:x-transition="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Title встановлюється динамічно -->
  <title x-text="isLoading ? `${safeT('general.loading')}... — ${safeT('general.copyright')}` : (error ? `${safeT('general.error')} — ${safeT('general.copyright')}` : (story ? `${story.title} — ${safeT('general.copyright')}` : `${safeT('general.error')} — ${safeT('general.copyright')}`))"></title>

  <!-- Мета-теги встановлюються динамічно -->
  <meta name="description" :content="story ? story.content.replace(/<[^>]*>?/gm, '').substring(0, 160) + '...' : (safeT('story.metaDescriptionPlaceholder') || 'Еротичні історії на сайті Таємний Світ.')">
  <meta property="og:title" content=""> <!-- Встановлюється в JS -->
  <meta property="og:description" content=""> <!-- Встановлюється в JS -->
  <meta property="og:image" content=""> <!-- Встановлюється в JS -->
  <meta property="og:type" content="article">

  <!-- Шрифти -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

  <!-- Internationalization -->
  <script type="module" src="js/i18n.js" defer></script> <!-- Важливо: type="module" -->



  <!-- API Config & Utils -->
  <script src="js/api-config.js" defer></script>
  <script src="js/api-utils.js" defer></script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script>
    // Запасний варіант, якщо API не завантажився
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof api === 'undefined') {
        console.error('API is not defined after loading scripts! Creating a mock API.');
        window.api = {
          utils: {
            getUserId: () => null,
            isAuthenticated: () => false,
            isPremium: () => false
          },
          stories: {
            getStoryById: async (id) => {
              console.warn(`MOCK API: getStoryById(${id})`);
              await new Promise(res => setTimeout(res, 300));
              // Повертаємо базову структуру, щоб уникнути помилок в Alpine
              return { _id: id, title: 'Завантаження...', content: '<p>Завантаження...</p>', author: null, category: null, commentsCount: 0, likes: 0, views: 0 };
            },
            likeStory: async () => { console.warn('MOCK API: likeStory'); return Promise.resolve({}); },
            rateStory: async () => { console.warn('MOCK API: rateStory'); return Promise.resolve({ averageRating: 0, totalRatings: 0 }); }
            // getRelatedStories: async () => { console.warn('MOCK API: getRelatedStories'); return { data: [] }; } // Додамо пізніше
          },
          users: {
            toggleBookmark: async () => { console.warn('MOCK API: toggleBookmark'); return Promise.resolve({}); },
            checkIfFollowing: async () => { console.warn('MOCK API: checkIfFollowing'); return Promise.resolve(false); },
            getStoryInteractionStatus: async () => { // Додано мок
              console.warn('MOCK API: getStoryInteractionStatus');
              return Promise.resolve({ liked: false, bookmarked: false, rating: 0 });
            },
            toggleFollow: async () => { console.warn('MOCK API: toggleFollow'); return Promise.resolve({ following: false }); }
          },
          comments: {
            getComments: async () => { console.warn('MOCK API: getComments'); return { data: [] }; },
            createComment: async () => { console.warn('MOCK API: createComment'); return Promise.resolve({}); },
            likeComment: async () => { console.warn('MOCK API: likeComment'); return Promise.resolve({}); }
            // getLikeStatuses: async () => { console.warn('MOCK API: getLikeStatuses'); return {}; } // Додамо пізніше
          },
          translation: { // Мок для перекладу
            translateText: async (text, lang) => {
              console.warn(`MOCK API: translateText to ${lang}`);
              await new Promise(res => setTimeout(res, 500));
              return { translatedText: `[${lang.toUpperCase()}] ${text}` };
            }
          }
        };
      }
    });
  </script>



  <!-- CSS -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/story.css">

  <style>
    /* Стилі для сповіщення */
    .notification {
      position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%) translateY(150%);
      background-color: var(--card-color); color: var(--text-color);
      padding: 1rem 1.5rem; border-radius: var(--border-radius);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); z-index: 1050; /* Вищий z-index */
      opacity: 0; transition: opacity 0.3s ease-out, transform 0.4s ease-out;
      min-width: 250px; max-width: 90%; text-align: center;
      border: 1px solid rgba(153, 0, 0, 0.2); border-left-width: 4px; pointer-events: none;
    }
    .notification.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }
    .notification.success { border-left-color: #4cd964; }
    .notification.error { border-left-color: #ff6b6b; }

    /* Стилі для індикатора завантаження */
    .loading-indicator-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(15, 10, 12, 0.8); display: flex;
      align-items: center; justify-content: center; z-index: 9998;
      backdrop-filter: blur(5px);
    }
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: var(--accent-red);
      border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Стиль для кнопки під час обробки */
    button.removing, .action-btn.removing { opacity: 0.7; pointer-events: none; }
    button.removing i:not(.fa-spinner), .action-btn.removing i:not(.fa-spinner) { display: none; }
    button.removing::after, .action-btn.removing::after, button:disabled.processing::after {
      content: '\f110'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
      display: inline-block; animation: spin 1s linear infinite; margin-left: 5px;
      font-size: 0.9em; /* Трохи менший спінер */
    }
    /* Специфічний відступ для кнопки follow */
    .follow-btn.removing::after { margin-left: 5px; }
    /* Специфічний відступ для лайка коментаря */
    .comment-actions a.removing::after { margin-left: 3px; font-size: 0.8em; }

    /* Додаткові стилі для перекладу */
    .translation-controls {
      margin-bottom: 1.5rem; padding: 1rem;
      background-color: rgba(255, 255, 255, 0.03); border-radius: var(--border-radius);
      display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .translation-label { font-weight: 500; color: var(--secondary-text); }
    .translation-select {
      padding: 0.5rem 0.8rem; background-color: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--border-radius);
      color: var(--text-color); font-family: 'Montserrat', sans-serif; cursor: pointer;
    }
    .translation-status {
      margin-left: auto; font-size: 0.9rem; color: var(--secondary-text);
      display: flex; align-items: center; gap: 0.5rem;
    }
    .translation-error-inline { color: #ff6b6b; }

    /* Помилка коментаря */
    .error-message-inline { color: #ff6b6b; font-size: 0.85rem; margin-top: -0.8rem; margin-bottom: 0.8rem; display: block; }

    /* Стилі для рейтингу */
    .rating-star:hover { color: #a67c3f; }

    /* Адаптивність для коментарів */
    @media (max-width: 576px) {
      .comment { flex-direction: column; gap: 0.5rem; }
      .comment-avatar { margin-right: 0; margin-bottom: 0.5rem; width: 40px; height: 40px;}
    }
    /* Приховування оверлею за замовчуванням */
    .premium-overlay { opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .story-item:hover .premium-overlay { opacity: 1; pointer-events: auto; }

    /* Кнопка Нагору */
    .back-to-top {
      position: fixed; bottom: 20px; right: 20px; width: 40px; height: 40px;
      border-radius: 50%; background-color: var(--accent-red); color: white;
      border: none; display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.3s ease;
      cursor: pointer; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .back-to-top.visible { opacity: 0.8; visibility: visible; }
    .back-to-top:hover { opacity: 1; background-color: var(--accent-burgundy); }
    .back-to-top:focus {
      outline: 2px solid var(--accent-gold);
      outline-offset: 3px;
    }

  </style>
</head>
<body x-data="{
    // --- Стани UI ---
    isLoggedIn: false,
    isPremiumUser: false,
    isLoading: true,
    error: null,
    isSubmittingComment: false,
    commentError: null,
    notificationVisible: false,
    notificationMessage: '',
    notificationType: 'success',
    notificationTimeout: null,
    userId: null, // ID поточного користувача
    isProcessingFollow: false, // Для індикатора кнопки Follow

    // --- Дані ---
    story: null,
    author: null,
    relatedStories: [],
    comments: [],
    storyId: null,

    // --- Стани взаємодії поточного користувача ---
    userRating: 0,
    bookmarked: false,
    followed: false, // Стеження за автором історії
    liked: false, // Лайк самої історії
    commentText: '',

    // --- Переклад ---
    selectedLang: 'uk', // Мова за замовчуванням
    translatedContent: null,
    isTranslating: false,
    translationError: null,
    availableLanguages: [], // Заповнюється з $store.i18n

     // --- Додаємо безпечну функцію для перекладів ---
    safeT(key, params = {}, fallback = '') {
        try {
            if (typeof $store !== 'undefined' && $store.i18n?.initialized) {
                const translation = $store.i18n.t(key, params);
                 return (translation && translation !== key && translation.trim() !== '') ? translation : fallback;
            }
             if (Object.keys(params).length > 0 && typeof fallback === 'string') {
                return Object.keys(params).reduce((str, pKey) => str.replace(new RegExp(`\\{${pKey}\\}`, 'g'), params[pKey]), fallback);
             }
            return fallback;
        } catch (error) { console.warn(`safeT error for key: ${key}`, error); return fallback; }
    },

    // --- Функція сповіщень ---
    showNotification(message, isSuccess = true) {
      this.notificationMessage = message;
      this.notificationType = isSuccess ? 'success' : 'error';
      const notificationElement = document.getElementById('global-notification');
      if (notificationElement) {
           notificationElement.classList.remove('success', 'error');
           notificationElement.classList.add(this.notificationType);
           notificationElement.classList.add('show');
      }
      this.notificationVisible = true;
      if (this.notificationTimeout) clearTimeout(this.notificationTimeout);
      this.notificationTimeout = setTimeout(() => {
          this.notificationVisible = false;
           const el = document.getElementById('global-notification');
           if (el) el.classList.remove('show');
      }, 4000);
    },

    // --- Завантаження даних ---
    async fetchStoryData() {
        this.isLoading = true;
        this.error = null;
        try {
            const urlParams = new URLSearchParams(window.location.search);
            this.storyId = urlParams.get('id');
            if (!this.storyId) throw new Error(this.safeT('story.errorStoryIdMissing', 'ID історії не знайдено в URL.'));

            console.log(`[API] Fetching story ID: ${this.storyId}`);
            const storyResult = await api.stories.getStoryById(this.storyId);
            if (!storyResult || !storyResult.data) throw new Error(this.safeT('story.storyNotFound', 'Історію не знайдено.'));
            this.story = storyResult.data;
            this.author = storyResult.data.author; // Автор вже є в відповіді

            // Оновлюємо title та мета-теги ПІСЛЯ отримання даних історії
            this.updateMetaTags();

            // Завантажуємо коментарі та схожі історії паралельно
            const [commentsResult, relatedResult] = await Promise.allSettled([
                api.comments.getComments(this.storyId, { limit: 10, sort: '-createdAt' }),
                // api.stories.getRelatedStories(this.storyId, { limit: 3 }) // Потрібна реалізація
                 Promise.resolve({ data: [ // Симуляція схожих
                     { _id: 'rel1', title: 'Дуже схожа історія 1', imageUrl: 'https://source.unsplash.com/random/300x200/?similar,1', views: 150, averageRating: 4.3 },
                     { _id: 'rel2', title: 'Інша схожа історія 2', imageUrl: 'https://source.unsplash.com/random/300x200/?similar,2', views: 98, averageRating: 4.0 }
                 ] })
            ]);

            if (commentsResult.status === 'fulfilled' && commentsResult.value.data) {
                this.comments = commentsResult.value.data.map(c => ({
                    ...c,
                    liked: false, // Початковий стан
                    date: c.createdAt ? new Date(c.createdAt).toLocaleString(this.selectedLang || 'uk-UA', { dateStyle: 'medium', timeStyle: 'short' }) : this.safeT('general.unknownDate')
                }));
                 // Якщо залогінені, завантажуємо статуси лайків коментарів
                 if (this.isLoggedIn && this.comments.length > 0) {
                      // TODO: Реалізувати fetchCommentLikeStatuses()
                 }
            } else {
                 console.warn('Could not load comments:', commentsResult.reason);
            }

            if (relatedResult.status === 'fulfilled' && relatedResult.value.data) {
                this.relatedStories = relatedResult.value.data;
            } else {
                 console.warn('Could not load related stories:', relatedResult.reason);
            }

            // Завантажуємо статус взаємодії користувача, якщо залогінений
            if (this.isLoggedIn) {
                await this.fetchUserInteractionStatus();
            }

        } catch (err) {
            this.error = err.message || this.safeT('story.errorLoadingStory', 'Помилка завантаження історії.');
            console.error('Fetch Story Data Error:', err);
        } finally {
            this.isLoading = false;
        }
    },

    async fetchUserInteractionStatus() {
        if (!this.storyId) return;
        try {
            console.log(`[API] Fetching interaction status for story: ${this.storyId}`);
            const status = await api.users.getStoryInteractionStatus(this.storyId);
            this.liked = status.data.liked || false;
            this.bookmarked = status.data.bookmarked || false;
            this.userRating = status.data.rating || 0;
            // Перевіряємо підписку на автора, якщо він є
            if (this.author?._id) {
                const followStatus = await api.users.checkIfFollowing(this.author._id);
                this.followed = followStatus.data.isFollowing || false;
            }
            console.log('Interaction status loaded:', status.data, 'Following:', this.followed);
        } catch (error) {
            console.warn('Failed to load interaction status:', error);
            // Не скидаємо помилку, просто використовуємо дефолтні значення
        }
    },

    // --- Оновлення мета-тегів ---
    updateMetaTags() {
        if (!this.story) return;
        const siteName = this.safeT('general.copyright', {}, 'Таємний Світ');
        const title = `${this.story.title} — ${siteName}`;
        // Використовуємо простий текст з контенту для опису
        const textContent = this.story.content ? this.story.content.replace(/<[^>]*>?/gm, '').replace(/\s+/g, ' ').trim() : '';
        const excerpt = textContent.substring(0, 160) + (textContent.length > 160 ? '...' : '');

        // Оновлюємо title
        document.title = title;

        // Оновлюємо meta теги
        const ogTitleTag = document.querySelector('meta[property=\'og:title\']');
        const ogDescriptionTag = document.querySelector('meta[property=\'og:description\']');
        const ogImageTag = document.querySelector('meta[property=\'og:image\']');
        const descriptionTag = document.querySelector('meta[name=\'description\']');

        if (ogTitleTag) ogTitleTag.setAttribute('content', title);
        if (descriptionTag) descriptionTag.setAttribute('content', excerpt);
        if (ogDescriptionTag) ogDescriptionTag.setAttribute('content', excerpt);
        if (ogImageTag && this.story.imageUrl) ogImageTag.setAttribute('content', this.story.imageUrl);
        else if (ogImageTag) ogImageTag.setAttribute('content', 'https://source.unsplash.com/random/1200x630/?abstract'); // Fallback
    },

    // --- Функції взаємодії (залишаються схожими, але з `safeT`) ---
    async toggleLike(event) {
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        if (!this.story) return;
        const button = event?.currentTarget; if (button) button.classList.add('removing');
        const originalLiked = this.liked;
        const originalLikes = this.story.likes || 0;
        this.liked = !this.liked;
        this.story.likes = Math.max(0, originalLikes + (this.liked ? 1 : -1));
        try {
            await api.stories.likeStory(this.storyId);
            this.showNotification(this.liked ? this.safeT('notifications.addedToLikes') : this.safeT('notifications.removedFromLikes'), true);
        } catch (err) {
            this.liked = originalLiked; this.story.likes = originalLikes;
            this.showNotification(this.safeT('story.errorTogglingLike') + ': ' + (err.message || this.safeT('general.unknownError')), false);
            console.error('Like Error:', err);
        } finally { if (button) button.classList.remove('removing'); }
    },
    async setRating(rating) {
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        if (!this.story) return;
        const originalRating = this.userRating;
        const newRating = this.userRating === rating ? 0 : rating;
        const starsContainer = this.$refs.ratingStarsContainer;
        try {
            this.userRating = newRating;
            if(starsContainer) starsContainer.style.opacity = '0.5';
            const response = await api.stories.rateStory(this.storyId, newRating);
            if (response && response.data && response.data.averageRating !== undefined && response.data.totalRatings !== undefined) {
                this.story.averageRating = response.data.averageRating;
                this.story.totalRatings = response.data.totalRatings;
            }
            this.showNotification(
                newRating > 0 ? this.safeT('notifications.ratingThanks', { rating: newRating }) : this.safeT('notifications.ratingRemoved'),
                true
            );
        } catch (err) {
            this.userRating = originalRating;
            this.showNotification(this.safeT('story.errorSavingRating') + ': ' + (err.message || this.safeT('general.unknownError')), false);
            console.error('Rating Error:', err);
        } finally { if(starsContainer) starsContainer.style.opacity = '1'; }
    },
    async toggleBookmark(event) {
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        if (!this.story) return;
        const button = event?.currentTarget; if (button) button.classList.add('removing');
        const originalBookmarked = this.bookmarked;
        this.bookmarked = !this.bookmarked;
        try {
            await api.users.toggleBookmark(this.storyId); // Використовуємо user controller
            this.showNotification(this.bookmarked ? this.safeT('notifications.addedToBookmarks') : this.safeT('notifications.removedFromBookmarks'), true);
        } catch (err) {
            this.bookmarked = originalBookmarked;
            this.showNotification(this.safeT('story.errorTogglingBookmark') + ': ' + (err.message || this.safeT('general.unknownError')), false);
            console.error('Bookmark Error:', err);
        } finally { if (button) button.classList.remove('removing'); }
    },
    async toggleFollow(event) {
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        if (!this.author?._id) return;
        if (this.author._id === this.userId) { this.showNotification(this.safeT('story.errorFollowSelf'), false); return; }

        this.isProcessingFollow = true;
        const originalFollowed = this.followed;
        const originalFollowers = this.author.stats?.followersCount || 0;
        this.followed = !this.followed;
        if (this.author.stats && typeof this.author.stats.followersCount === 'number') {
            this.author.stats.followersCount = Math.max(0, originalFollowers + (this.followed ? 1 : -1));
        }

        try {
             await api.users.toggleFollow(this.author._id); // Використовуємо user controller
            this.showNotification(this.followed ? this.safeT('notifications.followingAuthor', {name: this.author.name}) : this.safeT('notifications.unfollowingAuthor', {name: this.author.name}), true);
        } catch (err) {
            this.followed = originalFollowed;
            if (this.author.stats && typeof this.author.stats.followersCount === 'number') { this.author.stats.followersCount = originalFollowers; }
            this.showNotification(this.safeT('story.errorTogglingFollow') + ': ' + (err.message || this.safeT('general.unknownError')), false);
            console.error('Follow Error:', err);
        } finally { this.isProcessingFollow = false; }
    },
    async submitComment() {
        this.commentError = null;
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        const commentTextTrimmed = this.commentText.trim();
        if (!commentTextTrimmed) { this.commentError = this.safeT('story.errorCommentEmpty'); return; }
        if (commentTextTrimmed.length < 3) { this.commentError = this.safeT('story.errorCommentTooShort', 'Коментар занадто короткий.'); return; }
        if (commentTextTrimmed.length > 1000) { this.commentError = this.safeT('story.errorCommentTooLong', 'Коментар занадто довгий (макс 1000).'); return; }
        if (!this.story) return;

        this.isSubmittingComment = true;
        try {
            const addedCommentData = await api.comments.createComment(this.storyId, commentTextTrimmed);
            if (!addedCommentData.data) throw new Error('API did not return comment data'); // Перевірка відповіді

const newComment = addedCommentData.data; // Беремо дані з data
newComment.date = newComment.createdAt ? new Date(newComment.createdAt).toLocaleString(this.selectedLang || 'uk-UA', { dateStyle: 'medium', timeStyle: 'short' }) : this.safeT('general.justNow');
newComment.liked = false;

this.comments.unshift(newComment); // Додаємо на початок масиву
this.commentText = '';
if (this.story && typeof this.story.commentsCount === 'number') { this.story.commentsCount++; }
this.showNotification(this.safeT('notifications.commentAdded'), true);
} catch (err) {
this.commentError = err.message || this.safeT('story.errorAddingComment');
console.error('Comment Submit Error:', err);
} finally { this.isSubmittingComment = false; }
},
async likeComment(commentId, event) {
if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
const commentIndex = this.comments.findIndex(c => (c._id || c.id) === commentId);
if (commentIndex === -1) return;

const button = event?.currentTarget; if (button) button.classList.add('removing');

const comment = this.comments[commentIndex];
const originalLiked = comment.liked;
const originalLikes = comment.likes || 0;
this.comments[commentIndex].liked = !originalLiked;
this.comments[commentIndex].likes = Math.max(0, originalLikes + (this.comments[commentIndex].liked ? 1 : -1));
try {
await api.comments.likeComment(commentId);
} catch (err) {
this.comments[commentIndex].liked = originalLiked;
this.comments[commentIndex].likes = originalLikes;
this.showNotification(this.safeT('story.errorLikingComment') + ': ' + (err.message || this.safeT('general.unknownError')), false);
console.error('Comment Like Error:', err);
} finally { if (button) button.classList.remove('removing'); }
},
async copyLink() {
try {
if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
await navigator.clipboard.writeText(window.location.href);
this.showNotification(this.safeT('general.copiedLink'), true);
} else {
const tempInput = document.createElement('input');
tempInput.value = window.location.href;
document.body.appendChild(tempInput);
tempInput.select();
if (document.execCommand('copy')) { this.showNotification(this.safeT('general.copiedLink'), true); }
else { throw new Error('Copy command failed'); }
document.body.removeChild(tempInput);
}
} catch (err) {
console.error('Copy Link Error:', err);
this.showNotification(this.safeT('general.copyLinkError'), false);
}
},
async translateStory() {
// Перевіряємо преміум СИНХРОННО, бо isPremiumUser вже встановлено
if (!this.isPremiumUser) {
this.showNotification(this.safeT('story.translationAvailableForPremium'), false);
// Скидаємо селект назад на українську
this.selectedLang = 'uk';
this.$nextTick(() => { this.$refs.languageSelect.value = 'uk'; });
return;
}
if (this.selectedLang === 'uk') { this.translatedContent = null; this.translationError = null; return; }

this.isTranslating = true; this.translationError = null; this.translatedContent = null;
try {
const originalContent = this.story?.content;
if (!originalContent) throw new Error(this.safeT('story.errorNoContentForTranslation'));

// Кидаємо помилку, бо переклад має бути на бекенді
throw new Error(this.safeT('story.errorTranslationClientSide'));

// --- Закоментований код для майбутнього API ---
// console.log(`[API] Translating story ${this.storyId} to ${this.selectedLang}`);
// const translationResult = await api.translation.translateText(originalContent, this.selectedLang);
// this.translatedContent = translationResult.translatedText;
// --- Кінець ---

} catch (error) {
this.translationError = error.message || this.safeT('story.translationError');
console.error('Translation error:', error);
// Показуємо помилку замість контенту
this.translatedContent = `<p style='color: #ff6b6b;'>${this.translationError}</p>`;
} finally { this.isTranslating = false; }
},
formatStars(rating) {
if (!rating || isNaN(rating)) return '';
const fullStars = Math.floor(rating);
const hasHalfStar = rating - fullStars >= 0.5;
const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
let stars = '';
for (let i = 0; i < fullStars; i++) stars += '<i class=\'fas fa-star\'></i>';
if (hasHalfStar) stars += '<i class=\'fas fa-star-half-alt\'></i>';
for (let i = 0; i < emptyStars; i++) stars += '<i class=\'far fa-star\'></i>';
return stars;
},
// --- Метод для виходу ---
async logoutUser() {
try {
console.log('Attempting logout...');
if (typeof api !== 'undefined' && api.auth && typeof api.auth.logout === 'function') {
api.auth.logout();
this.isLoggedIn = false;
this.isPremiumUser = false;
this.userId = null;
// Скидаємо статуси взаємодії
this.liked = false;
this.bookmarked = false;
this.userRating = 0;
this.followed = false;
this.showNotification(this.safeT('notifications.logoutSuccess', {}, 'Вихід успішний!'), true);
// Не перезавантажуємо сторінку, просто оновлюємо стан
} else { throw new Error('API logout function is not available.'); }
} catch (error) {
console.error('Logout error:', error);
this.showNotification(this.safeT('auth.logoutError', {}, 'Помилка при виході з системи.'), false);
}
}

}" x-init="
try {
// Чекаємо ініціалізації i18n перед завантаженням
let waitCount = 0;
while ((typeof $store === 'undefined' || !$store.i18n?.initialized) && waitCount < 50) {
await new Promise(resolve => setTimeout(resolve, 100));
waitCount++;
}
if (typeof $store === 'undefined' || !$store.i18n?.initialized) {
console.error('i18n store failed to initialize!');
} else {
selectedLang = $store.i18n.selectedLang;
availableLanguages = $store.i18n.available.map(lang => ({
code: lang.code,
name: lang.code === 'uk' ? `${safeT('story.translationOriginalUk')} (Оригінал)` : lang.name
}));
$watch('$store.i18n.selectedLang', (newLang) => {
if (selectedLang !== newLang) {
selectedLang = newLang;
// Оновлюємо дати коментарів, якщо вони є
if(comments.length > 0) {
comments.forEach(c => c.date = new Date(c.createdAt).toLocaleString(selectedLang || 'uk-UA', { dateStyle: 'medium', timeStyle: 'short' }));
}
// Пере-рендерінг деяких елементів, якщо потрібно (Alpine має робити це автоматично)
}
});
}
// Перевіряємо API
waitCount = 0;
while ((typeof api === 'undefined' || typeof api.utils === 'undefined') && waitCount < 50) {
await new Promise(resolve => setTimeout(resolve, 100));
waitCount++;
}
if (typeof api === 'undefined' || typeof api.utils === 'undefined') {
console.error('API object failed to load!');
error = 'Не вдалося завантажити необхідні компоненти сторінки.';
isLoading = false;
} else {
userId = api.utils.getUserId();
isLoggedIn = api.utils.isAuthenticated();
isPremiumUser = api.utils.isPremium();
fetchStoryData(); // Запускаємо основне завантаження
}
} catch(e) {
console.error('Error in x-init:', e);
error = 'Помилка ініціалізації сторінки.';
isLoading = false;
}
">

<!-- Індикатор завантаження -->
<div x-show="isLoading" class="loading-indicator-overlay" x-transition.opacity>
  <div class="loading-spinner"></div>
</div>

<!-- Хедер (без змін) -->
<header>
  <div class="container">
    <nav class="navbar">
      <a href="index.html" class="logo">Таємний<span>Світ</span></a>
      <ul class="nav-links">
        <li><a href="index.html" x-text="safeT('general.home')"></a></li>
        <li><a href="new-stories.html" x-text="safeT('general.newStories')"></a></li>
        <li><a href="top-stories.html" x-text="safeT('general.topStories')"></a></li>
        <li><a href="categories.html" x-text="safeT('general.categories')"></a></li>
        <li><a href="authors.html" x-text="safeT('general.authors')"></a></li>
      </ul>
      <div class="auth-buttons">
        <!-- Мовний перемикач -->
        <div class="lang-dropdown-container" x-data="{ open: false }" @click.away="open = false">
          <div class="lang-dropdown-button" @click="open = !open" role="button" aria-haspopup="true" :aria-expanded="open">
            <span x-text="$store?.i18n?.selectedLang?.toUpperCase() || 'UK'"></span>
            <i class="fas fa-chevron-down" :class="{ 'rotate-180': open }" aria-hidden="true"></i>
          </div>
          <template x-if="$store?.i18n">
            <div class="lang-dropdown-menu" x-show="open" x-transition role="menu" aria-orientation="vertical">
              <template x-for="lang in $store.i18n.available || []" :key="lang.code">
                <div class="lang-dropdown-item"
                     :class="{ 'active': lang.code === $store.i18n.selectedLang }"
                     @click="const newLang=lang.code; open=false; try{$store.i18n.setLanguage(newLang);}catch(e){console.error('Lang switch error',e);}"
                     role="menuitemradio" :aria-checked="lang.code === $store.i18n.selectedLang" tabindex="0"
                     @keydown.enter.space.prevent="const newLang=lang.code; open=false; try{$store.i18n.setLanguage(newLang);}catch(e){console.error('Lang switch error',e);}"
                >
                  <span x-text="lang.name"></span>
                  <i x-show="lang.code === $store.i18n.selectedLang" class="fas fa-check" aria-hidden="true"></i>
                </div>
              </template>
            </div>
          </template>
        </div>
        <!-- Кнопки входу/профілю -->
        <template x-if="!isLoggedIn">
          <div>
            <a href="login.html" class="btn btn-outline"> <i class="fas fa-sign-in-alt"></i> <span x-text="safeT('general.login')"></span> </a>
            <a href="login.html?tab=register" class="btn btn-primary"> <i class="fas fa-user-plus"></i> <span x-text="safeT('general.register')"></span> </a>
          </div>
        </template>
        <template x-if="isLoggedIn">
          <div>
            <a href="profile.html" class="btn btn-outline"> <i class="fas fa-user"></i> <span x-text="safeT('general.profile')"></span> </a>
            <a href="#" @click.prevent="logoutUser()" class="btn btn-primary">
              <i class="fas fa-sign-out-alt"></i> <span x-text="safeT('general.logout')"></span>
            </a>
          </div>
        </template>
      </div>
    </nav>
  </div>
</header>

<!-- Основний контент -->
<main class="container">
  <!-- Повідомлення про помилку завантаження -->
  <div x-show="error && !isLoading" class="error-message" style="margin: 2rem 0;">
    <i class="fas fa-exclamation-circle"></i> <span x-text="error"></span>
    <button @click="fetchStoryData()" class="btn btn-outline" x-text="safeT('general.retryButton')"></button>
  </div>

  <!-- Контент сторінки історії -->
  <template x-if="story && !isLoading && !error">
    <div>
      <!-- Хлібні крихти -->
      <div class="breadcrumbs">
        <a href="index.html" x-text="safeT('general.home')"></a>
        <span class="separator">/</span>
        <a href="categories.html" x-text="safeT('general.categories')"></a>
        <span class="separator">/</span>
        <a :href="`category-page.html?slug=${story.category?.slug || 'other'}`" x-text="story.category?.name || safeT('general.defaultCategory')"></a>
        <span class="separator">/</span>
        <span class="current" x-text="story.title"></span>
      </div>

      <!-- Структура сторінки -->
      <div class="story-page">
        <!-- Основний контент -->
        <div class="story-main">
          <!-- Заголовок історії -->
          <div class="story-header">
            <div class="story-category" x-text="story.category?.name || safeT('general.defaultCategory')"></div>
            <h1 class="story-title-main" x-text="story.title"></h1>
            <div class="story-meta-info">
              <div><i class="far fa-calendar-alt"></i> <span x-text="story.createdAt ? new Date(story.createdAt).toLocaleDateString(selectedLang || 'uk-UA', { day: 'numeric', month: 'long', year: 'numeric' }) : '...'"></span></div>
              <div><i class="far fa-eye"></i> <span x-text="story.views || 0"></span> <span x-text="safeT('general.views')"></span></div>
              <div><i class="far fa-clock"></i> <span x-text="story.readingTime"></span> <span x-text="safeT('general.readingTimeSuffix')"></span></div>
              <div><i class="far fa-comments"></i> <span x-text="story.commentsCount || comments.length"></span> <span x-text="safeT('general.comments')"></span></div>
            </div>

            <!-- Блок автора -->
            <template x-if="author && !story.isAnonymous">
              <div class="story-author">
                <a :href="author._id ? `author-profile.html?id=${author._id}` : '#'" style="display: contents;">
                  <div class="author-avatar"
                       :style="`background-image: url('${author.avatarUrl || 'https://source.unsplash.com/random/100x100/?profile'}')`"
                       role="img"
                       :aria-label="`${safeT('story.avatarOf')} ${author.name || safeT('general.anonymous')}`">
                  </div>
                </a>
                <div class="author-info">
                  <div class="author-name">
                    <a :href="author._id ? `author-profile.html?id=${author._id}` : '#'" style="color: inherit; text-decoration: none;"
                       x-text="author.name || safeT('general.anonymous')"></a>
                  </div>
                  <div class="author-bio" x-text="author.bio || safeT('authorsPage.bioMissing')"></div>
                </div>
                <!-- Кнопка стеження -->
                <template x-if="author._id && isLoggedIn && userId !== author._id">
                  <button type="button"
                          @click="toggleFollow($event)"
                          class="btn btn-outline follow-btn"
                          :class="{ 'following': followed, 'removing': isProcessingFollow }"
                          :disabled="!author || isProcessingFollow">
                    <span x-show="!isProcessingFollow" x-text="followed ? safeT('story.unfollowAuthor') : safeT('story.followAuthor')"></span>
                  </button>
                </template>
                <template x-if="author._id && !isLoggedIn">
                  <a :href="'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search)"
                     class="btn btn-outline follow-btn"
                     x-text="safeT('story.followAuthor')">
                  </a>
                </template>
              </div>
            </template>
            <!-- Якщо анонімно -->
            <template x-if="story.isAnonymous">
              <div class="story-author">
                <div class="author-avatar" style="background-image: url('https://source.unsplash.com/random/100x100/?mystery,mask')"></div>
                <div class="author-info">
                  <div class="author-name" x-text="safeT('general.anonymous')"></div>
                  <div class="author-bio" x-text="safeT('story.anonymousAuthorNote', 'Автор вирішив залишитись анонімним.')"></div>
                </div>
              </div>
            </template>
          </div>

          <!-- Головне зображення -->
          <div class="story-featured-image" :style="`background-image: url('${story.imageUrl || 'https://source.unsplash.com/random/1200x600/?abstract'}')`">
            <div class="story-badge-large" x-text="story.ageRating"></div>
          </div>

          <!-- Оцінка і дії -->
          <div class="story-actions">
            <div class="story-rating" :aria-label="`Поточний рейтинг: ${(story.averageRating || 0).toFixed(1)} з 5`">
              <div class="rating-score" x-text="(story.averageRating || 0).toFixed(1)"></div>
              <div class="rating-stars" x-ref="ratingStarsContainer" role="radiogroup">
                <template x-for="i in 5" :key="i">
                  <button class="rating-star"
                          @click="setRating(i)"
                          type="button"
                          role="radio"
                          :aria-checked="i === userRating"
                          :aria-label="safeT('story.rateAriaLabel', { stars: i }) || `Оцінити на ${i} з 5`"
                          :class="{
                              'fas fa-star': i <= userRating,
                              'far fa-star': i > userRating
                          }"
                          :title="safeT('story.rateAriaLabel', { stars: i }) || `Оцінити на ${i}`">
                  </button>
                </template>
              </div>
              <div class="rating-count">
                (<span x-text="story.totalRatings || 0"></span> <span x-text="safeT('story.ratingCountSuffix', 'оцінок')"></span>)
              </div>
            </div>
            <div class="story-buttons">
              <button type="button" class="action-btn" :class="{ 'removing': false }" @click="toggleLike($event)" :title="liked ? safeT('story.likedStory') : safeT('story.likeStory')" :style="{ 'background-color': liked ? 'rgba(204, 0, 51, 0.2)' : '' }">
                <i :class="liked ? 'fas fa-heart' : 'far fa-heart'" style="color: var(--accent-red);"></i>
                <span x-text="story.likes || 0" style="margin-left: 5px; font-size: 0.9em;"></span>
              </button>
              <button type="button" class="action-btn" :class="{ 'removing': false }" @click="toggleBookmark($event)" :title="bookmarked ? safeT('story.savedBookmark') : safeT('story.saveBookmark')" :style="{ 'background-color': bookmarked ? 'rgba(255, 255, 255, 0.1)' : '' }">
                <i :class="bookmarked ? 'fas fa-bookmark' : 'far fa-bookmark'"></i>
              </button>
              <button type="button" class="action-btn" @click="copyLink()" :title="safeT('general.copyLink')"> <i class="fas fa-share-alt"></i> </button>
              <button type="button" class="action-btn" @click="showNotification(safeT('notifications.reportSent'), true)" :title="safeT('story.reportProblem')"> <i class="fas fa-flag"></i> </button>
            </div>
          </div>

          <!-- Блок керування перекладом -->
          <template x-if="isPremiumUser">
            <div class="translation-controls">
              <span class="translation-label" x-text="safeT('story.translationLabel')"></span>
              <select class="translation-select" x-model="selectedLang" @change="translateStory()" x-ref="languageSelect">
                <template x-for="lang in availableLanguages" :key="lang.code">
                  <option :value="lang.code" x-text="lang.name"></option>
                </template>
              </select>
              <div class="translation-status">
                <span x-show="isTranslating"><i class="fas fa-spinner fa-spin"></i> <span x-text="safeT('story.translationLoading')"></span></span>
                <span x-show="translationError" class="translation-error-inline"><i class="fas fa-exclamation-triangle"></i> <span x-text="translationError"></span></span>
                <span x-show="!isTranslating && !translationError && selectedLang !== 'uk'" x-text="safeT('story.translationShowing')"></span>
                <span x-show="!isTranslating && !translationError && selectedLang === 'uk'" x-text="safeT('story.translationOriginalShowing')"></span>
              </div>
            </div>
          </template>

          <!-- Контент історії -->
          <div class="story-content" lang="uk"> <!-- Завжди вказуємо мову контенту -->
            <!-- Урізаний контент для не-преміум -->
            <template x-if="story.isPremium && !isPremiumUser">
              <div x-html="story.content.substring(0, Math.min(500, Math.floor(story.content.length * 0.3))) + '...'"></div>
              <div class="story-premium-notice">
                <h3 x-text="safeT('story.premiumContentBlocked')"></h3>
                <p x-text="safeT('story.premiumContentDescription')"></p>
                <a href="premium.html" class="btn btn-primary" x-text="safeT('story.getPremiumButton')"></a>
              </div>
            </template>
            <!-- Повний контент -->
            <template x-if="!story.isPremium || isPremiumUser">
              <!-- Перекладений контент -->
              <div x-show="selectedLang !== 'uk' && translatedContent" x-html="translatedContent" :lang="selectedLang"></div>
              <!-- Оригінальний контент -->
              <div x-show="selectedLang === 'uk' || !translatedContent" x-html="story.content"></div>
            </template>
          </div>


          <!-- Теги історії -->
          <div class="story-tags-section" x-show="story.tags && story.tags.length > 0">
            <h3 class="story-tags-title" x-text="safeT('story.tagsLabel')"></h3>
            <div class="story-tags-list">
              <template x-for="tag in story.tags" :key="tag">
                <a href="#" @click.prevent="window.location.href=`categories.html?search=${encodeURIComponent(tag)}`" class="story-tag-link" x-text="tag"></a>
              </template>
            </div>
          </div>

          <!-- Навігація між історіями (заглушка) -->
          <div class="story-navigation">
            <a href="#" class="prev-story" style="opacity: 0.5; pointer-events: none;" aria-disabled="true">
              <div class="prev-story-icon"><i class="fas fa-chevron-left"></i></div>
              <div>
                <span class="nav-direction" x-text="safeT('story.prevStoryLink', 'Попередня')"></span>
                <h4 class="nav-title" x-text="safeT('story.noPrevStory', 'Немає')"></h4>
              </div>
            </a>
            <a href="#" class="next-story" style="opacity: 0.5; pointer-events: none;" aria-disabled="true">
              <div>
                <span class="nav-direction" x-text="safeT('story.nextStoryLink', 'Наступна')"></span>
                <h4 class="nav-title" x-text="safeT('story.noNextStory', 'Немає')"></h4>
              </div>
              <div class="next-story-icon"><i class="fas fa-chevron-right"></i></div>
            </a>
          </div>

          <!-- Коментарі -->
          <div class="comments-section">
            <h2 class="comments-title"><span x-text="safeT('story.commentsTitle')"></span> (<span x-text="comments.length"></span>)</h2>
            <div class="comment-form" x-show="isLoggedIn">
              <textarea x-model="commentText" class="comment-input" :placeholder="safeT('story.leaveCommentPlaceholder')" :disabled="isSubmittingComment" aria-label="Текст коментаря" x-ref="commentInputRef" minlength="3" maxlength="1000"></textarea>
              <div x-show="commentError" class="error-message-inline" x-text="commentError"></div>
              <div class="comment-submit">
                <button type="button" @click="submitComment()" class="btn btn-primary" :class="{ 'processing': isSubmittingComment }" :disabled="isSubmittingComment || !commentText.trim()">
                  <span x-show="!isSubmittingComment" x-text="safeT('story.addCommentButton')"></span>
                  <!-- Спінер тепер додається через CSS клас .processing -->
                </button>
              </div>
            </div>
            <div class="comment-form" x-show="!isLoggedIn" style="text-align: center; padding: 1rem; background-color: rgba(255,255,255,0.05); border-radius: var(--border-radius);">
              <p style="margin-bottom: 1rem; color: var(--secondary-text);">
                <span x-text="safeT('story.loginToComment')"></span>
                <a :href="'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search)" style="color: var(--accent-red);" x-text="safeT('general.login')"></a>
                <span x-text="safeT('general.or')"></span>
                <a href="login.html?tab=register" style="color: var(--accent-red);" x-text="safeT('general.register')"></a>.
              </p>
            </div>

            <div class="comments-list">
              <template x-for="comment in comments" :key="comment._id || comment.id">
                <div class="comment">
                  <a :href="comment.author?._id ? `author-profile.html?id=${comment.author._id}` : '#'" style="display: contents;">
                    <div class="comment-avatar" :style="`background-image: url('${comment.author?.avatarUrl || 'https://source.unsplash.com/random/100x100/?face'}')`" role="img" :aria-label="`${safeT('story.avatarOf')} ${comment.author?.name}`"></div>
                  </a>
                  <div class="comment-body">
                    <div class="comment-author"><a :href="comment.author?._id ? `author-profile.html?id=${comment.author._id}` : '#'" style="color: inherit; text-decoration: none;" x-text="comment.author?.name || safeT('general.anonymous')"></a></div>
                    <div class="comment-date" x-text="comment.date || '...' "></div>
                    <div class="comment-text" x-text="comment.text"></div>
                    <div class="comment-actions">
                      <a href="#" @click.prevent="likeComment(comment._id || comment.id, $event)" :aria-label="comment.liked ? safeT('story.unlikeCommentAriaLabel') : safeT('story.likeCommentAriaLabel')">
                        <i :class="comment.liked ? 'fas fa-thumbs-up' : 'far fa-thumbs-up'"></i>
                        <span x-text="safeT('story.likeCommentAction')"></span> (<span x-text="comment.likes || 0"></span>)
                      </a>
                      <a href="#" @click.prevent="alert(safeT('story.replyWIP'))"><i class="far fa-comment"></i> <span x-text="safeT('story.replyButton')"></span></a>
                    </div>
                  </div>
                </div>
              </template>
              <div x-show="comments.length === 0 && !isLoading" style="text-align: center; color: var(--secondary-text); padding: 1rem;" x-text="safeT('story.noCommentsYet')">
              </div>
            </div>
          </div>
        </div>

        <!-- Сайдбар -->
        <div class="story-sidebar">
          <!-- Віджет автора -->
          <template x-if="author && !story.isAnonymous">
            <div class="sidebar-widget author-widget">
              <a :href="author._id ? `author-profile.html?id=${author._id}` : '#'" style="display: contents;">
                <div class="author-avatar-large" :style="`background-image: url('${author.avatarUrl || 'https://source.unsplash.com/random/200x200/?profile'}')`" role="img" :aria-label="`${safeT('story.avatarOf')} ${author.name}`"></div>
              </a>
              <h3 class="author-name-large">
                <a :href="author._id ? `author-profile.html?id=${author._id}` : '#'" style="color: inherit; text-decoration: none;" x-text="author.name || safeT('general.anonymous')"></a>
              </h3>
              <div class="author-stats">
                <div class="author-stat">
                  <div class="stat-value" x-text="author.stats?.storyCount || 0"></div>
                  <div class="stat-label" x-text="safeT('profile.storiesWritten')"></div>
                </div>
                <div class="author-stat">
                  <div class="stat-value" x-text="(author.stats?.averageRating || 0).toFixed(1)"></div>
                  <div class="stat-label" x-text="safeT('general.ratingLabel')"></div>
                </div>
                <div class="author-stat">
                  <div class="stat-value" x-text="author.stats?.followersCount || 0"></div>
                  <div class="stat-label" x-text="safeT('profile.followers')"></div>
                </div>
              </div>
              <!-- Кнопка стеження в сайдбарі -->
              <template x-if="author._id && isLoggedIn && userId !== author._id">
                <button type="button"
                        @click="toggleFollow($event)"
                        class="btn btn-primary follow-btn"
                        :class="{ 'following': followed, 'removing': isProcessingFollow }"
                        style="width: 100%;"
                        :disabled="!author || isProcessingFollow">
                  <span x-show="!isProcessingFollow" x-text="followed ? safeT('story.unfollowAuthor') : safeT('story.followAuthor')"></span>
                  <!-- Спінер додається через CSS клас .removing -->
                </button>
              </template>
              <template x-if="author._id && !isLoggedIn">
                <a :href="'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search)"
                   class="btn btn-primary" style="width: 100%;"
                   x-text="safeT('story.followAuthor')">
                </a>
              </template>
            </div>
          </template>
          <!-- Заглушка для анонімного автора -->
          <template x-if="story.isAnonymous">
            <div class="sidebar-widget author-widget">
              <div class="author-avatar-large" style="background-image: url('https://source.unsplash.com/random/200x200/?mystery,mask')"></div>
              <h3 class="author-name-large" x-text="safeT('general.anonymous')"></h3>
              <p style="color: var(--secondary-text); font-style: italic;" x-text="safeT('story.anonymousAuthorNote')"></p>
            </div>
          </template>

          <!-- Віджет підписки -->
          <template x-if="!isPremiumUser">
            <div class="sidebar-widget premium-widget">
              <div class="premium-icon"><i class="fas fa-crown"></i></div>
              <h3 class="premium-title" x-text="safeT('premium.sidebarTitle')"></h3>
              <p class="premium-description" x-text="safeT('premium.sidebarDescription')"></p>
              <div class="premium-price" x-text="safeT('premium.sidebarPrice')"></div>
              <span class="price-period" x-text="safeT('premium.perMonth')"></span>
              <div class="premium-features">
                <div class="premium-feature"><i class="fas fa-check"></i><div x-text="safeT('premium.benefitAllStories')"></div></div>
                <div class="premium-feature"><i class="fas fa-check"></i><div x-text="safeT('premium.benefitExclusive')"></div></div>
                <div class="premium-feature"><i class="fas fa-check"></i><div x-text="safeT('premium.benefitNoAds')"></div></div>
                <div class="premium-feature"><i class="fas fa-check"></i><div x-text="safeT('premium.benefitTranslation')"></div></div>
              </div>
              <a href="premium.html" class="btn btn-primary" style="width: 100%;" x-text="safeT('premium.sidebarButton')"></a>
            </div>
          </template>

          <!-- Віджет схожих історій -->
          <div class="sidebar-widget" x-show="relatedStories.length > 0">
            <h3 class="widget-title" x-text="safeT('story.similarStories')"></h3>
            <div class="related-stories-list">
              <template x-for="related in relatedStories" :key="related._id">
                <a :href="`story-detailed.html?id=${related._id}`" class="related-story">
                  <div class="related-story-image" :style="`background-image: url('${related.imageUrl || 'https://source.unsplash.com/random/80x80/?story' }')`" role="img" :aria-label="related.title"></div>
                  <div class="related-story-info">
                    <h4 class="related-story-title" x-text="related.title"></h4>
                    <div class="related-story-meta">
                      <div class="related-story-views"><i class="far fa-eye"></i> <span x-text="related.views || 0"></span></div>
                      <div class="related-story-rating"><i class="fas fa-star"></i> <span x-text="(related.averageRating || 0).toFixed(1)"></span></div>
                    </div>
                  </div>
                </a>
              </template>
            </div>
          </div>

          <!-- Віджет поділитися -->
          <div class="sidebar-widget">
            <h3 class="widget-title" x-text="safeT('story.shareStoryTitle')"></h3>
            <p x-text="safeT('story.shareStoryText')"></p>
            <div class="share-buttons">
              <a href="#" @click.prevent="window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank', 'width=600,height=400')" class="share-button share-facebook" :title="safeT('general.shareFacebook')" :aria-label="safeT('general.shareFacebook')"><i class="fab fa-facebook-f"></i></a>
              <a href="#" @click.prevent="window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(story.title)}`, '_blank', 'width=600,height=400')" class="share-button share-twitter" :title="safeT('general.shareTwitter')" :aria-label="safeT('general.shareTwitter')"><i class="fab fa-twitter"></i></a>
              <a href="#" @click.prevent="window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(story.title)}`, '_blank')" class="share-button share-telegram" :title="safeT('general.shareTelegram')" :aria-label="safeT('general.shareTelegram')"><i class="fab fa-telegram-plane"></i></a>
              <a :href="`https://api.whatsapp.com/send?text=${encodeURIComponent(story.title + ' ' + window.location.href)}`" target="_blank" class="share-button share-whatsapp" :title="safeT('general.shareWhatsApp')" :aria-label="safeT('general.shareWhatsApp')"><i class="fab fa-whatsapp"></i></a>
              <button type="button" @click.prevent="copyLink()" class="share-button share-link" :title="safeT('general.copyLink')" :aria-label="safeT('general.copyLink')"><i class="fas fa-link"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
</main>

<!-- Footer (без змін) -->
<footer>
  <div class="container">
    <div class="footer-content">
      <div class="footer-section footer-about"> <h4 x-text="safeT('general.about')"></h4> <p x-text="safeT('general.aboutText')"></p> <div class="social-links"> <a href="#" class="social-link" :title="safeT('general.shareFacebook')"><i class="fab fa-facebook-f"></i></a> <a href="#" class="social-link" :title="safeT('general.shareTelegram')"><i class="fab fa-telegram-plane"></i></a> <a href="#" class="social-link" title="Instagram"><i class="fab fa-instagram"></i></a> </div> </div>
      <div class="footer-section"> <h4 x-text="safeT('general.navigation')"></h4> <ul> <li><a href="index.html" x-text="safeT('general.home')"></a></li> <li><a href="categories.html" x-text="safeT('general.categories')"></a></li> <li><a href="new-stories.html" x-text="safeT('general.newStories')"></a></li> <li><a href="top-stories.html" x-text="safeT('general.topStories')"></a></li> <li><a href="authors.html" x-text="safeT('general.authors')"></a></li> </ul> </div>
      <div class="footer-section"> <h4 x-text="safeT('general.support')"></h4> <ul> <li><a href="faq.html" x-text="safeT('faq.title')"></a></li> <li><a href="contact.html" x-text="safeT('contact.title')"></a></li> <li><a href="terms-page.html" x-text="safeT('general.terms')"></a></li> <li><a href="privacy-policy.html" x-text="safeT('general.privacy')"></a></li> </ul> </div>
      <div class="footer-section"> <h4 x-text="safeT('general.join')"></h4> <ul> <li><a href="login.html" x-text="safeT('general.login')"></a></li> <li><a href="login.html?tab=register" x-text="safeT('general.register')"></a></li> <li><a href="premium.html" x-text="safeT('general.premium')"></a></li> <li><a href="create_story.html" x-text="safeT('createStory.title')"></a></li> </ul> </div>
    </div>
    <div class="footer-bottom"> © <span x-text="new Date().getFullYear()"></span> <span x-text="safeT('general.copyright')"></span>. <span x-text="safeT('general.allRightsReserved')"></span>. 18+ <br> <a href="terms-page.html" x-text="safeT('general.terms')"></a> | <a href="privacy-policy.html" x-text="safeT('general.privacy')"></a> </div>
  </div>
</footer>


<!-- Елемент сповіщення з підтримкою типів -->
<div x-show="notificationVisible"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 transform translate-y-2"
     x-transition:enter-end="opacity-100 transform translate-y-0"
     x-transition:leave="transition ease-in duration-300"
     x-transition:leave-start="opacity-100 transform translate-y-0"
     x-transition:leave-end="opacity-0 transform translate-y-2"
     class="notification"
     :class="{ 'show': notificationVisible, 'success': notificationType === 'success', 'error': notificationType === 'error' }"
     style="display: none;"
     id="global-notification">
  <span x-text="notificationMessage"></span>
</div>

<!-- Кнопка Нагору -->
<button id="back-to-top"
        @click="window.scrollTo({ top: 0, behavior: 'smooth' })"
        x-data="{ isVisible: false }"
        x-init="window.addEventListener('scroll', () => { isVisible = window.scrollY > 300 })"
        x-show="isVisible"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-y-2"
        x-transition:enter-end="opacity-80 transform translate-y-0"
        x-transition:leave="transition ease-in duration-300"
        x-transition:leave-start="opacity-80 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform translate-y-2"
        aria-label="На початок сторінки"
        title="На початок сторінки"
        class="back-to-top">
  <i class="fas fa-arrow-up"></i>
</button>

<!-- Скрипт для встановлення початкового заголовка -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Встановлюємо початковий заголовок (буде оновлено після завантаження даних)
    try {
      const fallbackTitle = document.querySelector('title[data-fallback-title]')?.getAttribute('data-fallback-title') || 'Завантаження... — Таємний Світ';
      document.title = fallbackTitle;
    } catch(e) { console.warn('Error setting initial title', e); }
  });
</script>

</body>
</html>