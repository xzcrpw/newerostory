<!DOCTYPE html>
<html lang="uk" x-data :lang="$store.i18n.selectedLang" xmlns:x-transition="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Title встановлюється динамічно -->
  <title x-text="isLoading ? `${safeT('general.loading')}... — ${safeT('general.copyright')}` : (error ? `${safeT('general.error')} — ${safeT('general.copyright')}` : (story ? `${story.title} — ${safeT('general.copyright')}` : `${safeT('general.error')} — ${safeT('general.copyright')}`))"></title>

  <!-- Мета-теги встановлюються динамічно -->
  <meta name="description" :content="story ? story.content.replace(/<[^>]*>?/gm, '').substring(0, 160) + '...' : (safeT('story.metaDescriptionPlaceholder') || 'Еротичні історії на сайті Таємний Світ.')">
  <meta property="og:title" content=""> <!-- Встановлюється в JS -->
  <meta property="og:description" content=""> <!-- Встановлюється в JS -->
  <meta property="og:image" content=""> <!-- Встановлюється в JS -->
  <meta property="og:type" content="article">

  <!-- Шрифти -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- API Config & Utils -->
  <script src="js/api-config.js" defer></script>
  <script src="js/api-utils.js" defer></script>

  <!-- Internationalization -->
  <script type="module" src="js/i18n.js" defer></script> <!-- Важливо: type="module" -->

  <!-- CSS -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/story.css">

  <style>
    /* Стилі для сповіщення */
    .notification {
      position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
      background-color: var(--card-color); color: var(--text-color);
      padding: 1rem 1.5rem; border-radius: var(--border-radius);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); z-index: 1000;
      opacity: 0; transition: opacity 0.3s ease-out, bottom 0.4s ease-out;
      min-width: 250px; text-align: center; border: 1px solid rgba(153, 0, 0, 0.2);
    }
    .notification.show { opacity: 1; bottom: 20px; }
    .notification.success { border-left: 4px solid #4cd964; }
    .notification.error { border-left: 4px solid #ff6b6b; }

    /* Стилі для індикатора завантаження */
    .loading-indicator-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(15, 10, 12, 0.8); display: flex;
      align-items: center; justify-content: center; z-index: 9998;
      backdrop-filter: blur(5px);
    }
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.2); border-left-color: var(--accent-red);
      border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Стиль для кнопки під час обробки */
    button.removing, .action-btn.removing { opacity: 0.7; pointer-events: none; }
    button.removing i:not(.fa-spinner), .action-btn.removing i:not(.fa-spinner) { display: none; }
    button.removing::after, .action-btn.removing::after, button:disabled.processing::after {
      content: '\f110'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
      display: inline-block; animation: spin 1s linear infinite; margin-left: 5px;
      font-size: 0.9em; /* Трохи менший спінер */
    }
    /* Специфічний відступ для кнопки follow */
    .follow-btn.removing::after { margin-left: 5px; }
    /* Специфічний відступ для лайка коментаря */
    .comment-actions a.removing::after { margin-left: 3px; font-size: 0.8em; }

    /* Додаткові стилі для перекладу */
    .translation-controls {
      margin-bottom: 1.5rem; padding: 1rem;
      background-color: rgba(255, 255, 255, 0.03); border-radius: var(--border-radius);
      display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    .translation-label { font-weight: 500; color: var(--secondary-text); }
    .translation-select {
      padding: 0.5rem 0.8rem; background-color: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--border-radius);
      color: var(--text-color); font-family: 'Montserrat', sans-serif; cursor: pointer;
    }
    .translation-status {
      margin-left: auto; font-size: 0.9rem; color: var(--secondary-text);
      display: flex; align-items: center; gap: 0.5rem;
    }
    .translation-error-inline { color: #ff6b6b; }

    /* Помилка коментаря */
    .error-message-inline { color: #ff6b6b; font-size: 0.85rem; margin-top: -0.8rem; margin-bottom: 0.8rem; display: block; }
  </style>
</head>
<body x-data="{
    // --- Стани UI ---
    isLoggedIn: false,
    isPremiumUser: false,
    isLoading: true,
    error: null,
    isSubmittingComment: false,
    commentError: null,
    notificationVisible: false,
    notificationMessage: '',
    notificationTimeout: null,
    userId: null, // ID поточного користувача

    // --- Дані ---
    story: null,
    author: null,
    relatedStories: [],
    comments: [],
    storyId: null,

    // --- Стани взаємодії поточного користувача ---
    userRating: 0,
    bookmarked: false,
    followed: false, // Стеження за автором історії
    liked: false, // Лайк самої історії
    commentText: '',

    // --- Переклад ---
    selectedLang: 'uk',
    translatedContent: null,
    isTranslating: false,
    translationError: null,
    availableLanguages: [], // Заповнюється з $store.i18n

    // --- Функція для показу сповіщень ---
    showNotification(message, isSuccess = true) {
        this.notificationMessage = message;
        this.notificationType = isSuccess ? 'success' : 'error';
        
        const el = document.getElementById('global-notification');
        if(el) { 
            el.classList.toggle('success', isSuccess); 
            el.classList.toggle('error', !isSuccess);
            el.classList.add('show'); // Додавання класу show для анімації 
        }
        
        this.notificationVisible = true;
        
        if (this.notificationTimeout) clearTimeout(this.notificationTimeout);
        
        this.notificationTimeout = setTimeout(() => { 
            this.notificationVisible = false; 
            // Перевіряємо наявність елемента перед модифікацією
            const notification = document.getElementById('global-notification');
            if(notification) {
                notification.classList.remove('show');
            }
        }, 4000);
    },

    // --- Завантаження даних з покращеною обробкою помилок ---
    async fetchStoryData() {
        this.isLoading = true;
        this.error = null;
        
        try {
            // Отримуємо ID історії з URL
            const urlParams = new URLSearchParams(window.location.search);
            this.storyId = urlParams.get('id');

            if (!this.storyId) {
                this.error = this.safeT('story.errorStoryIdMissing', {}, 'ID історії не знайдено в URL.');
                this.isLoading = false;
                return;
            }

            console.log(`Fetching story data for ID: ${this.storyId}`);
            
            // Обробляємо кожний запит окремо для кращої обробки помилок
            let storyData, commentsData, relatedData;
            
            try {
                // Симуляція для прикладу - у реальному додатку потрібен справжній API
                await new Promise(resolve => setTimeout(resolve, 500));
                storyData = {
                    _id: this.storyId,
                    title: 'Приклад чудової еротичної історії',
                    content: '<p>Це приклад контенту історії. У реальному додатку тут буде повний текст історії.</p><p>Другий абзац історії для прикладу.</p>',
                    createdAt: new Date().toISOString(),
                    views: 1250,
                    likes: 86,
                    totalRatings: 34,
                    averageRating: 4.7,
                    readingTime: '8 хв',
                    author: {
                        _id: 'author123',
                        name: 'Творчий Автор',
                        avatarUrl: 'https://source.unsplash.com/random/100x100/?portrait',
                        bio: 'Пишу захоплюючі історії про кохання та пристрасть',
                        stats: {
                            storyCount: 12,
                            averageRating: 4.5,
                            followersCount: 67
                        }
                    },
                    category: {
                        name: 'Романтика',
                        slug: 'romance'
                    }
                };
                
                if (!storyData) throw new Error(this.safeT('story.storyNotFound', {}, 'Історію не знайдено'));
            } catch (storyError) {
                console.error('Error fetching story:', storyError);
                throw new Error(this.safeT('story.errorLoadingStoryData', {}, 'Помилка завантаження історії'));
            }

            // Завантажуємо коментарі, обробляємо помилку окремо
            try {
                commentsData = { 
                    data: [
                        {
                            _id: 'comment1',
                            author: {
                                _id: 'user1',
                                name: 'Читач',
                                avatarUrl: 'https://source.unsplash.com/random/100x100/?face'
                            },
                            text: 'Чудова історія! Мені дуже сподобалось.',
                            createdAt: new Date().toISOString(),
                            likes: 5
                        }
                    ] 
                };
            } catch (commentsError) {
                console.warn('Could not load comments:', commentsError);
                commentsData = { data: [] }; // Встановлюємо пустий масив, щоб не ламати інтерфейс
            }

            // Завантажуємо пов'язані історії, обробляємо помилку окремо
            try {
                relatedData = { 
                    data: [
                        {
                            id: 'related1',
                            title: 'Пов\'язана історія 1',
                            imageUrl: 'https://source.unsplash.com/random/300x200/?romance',
                            views: 843,
                            rating: 4.2
                        },
                        {
                            id: 'related2',
                            title: 'Пов\'язана історія 2',
                            imageUrl: 'https://source.unsplash.com/random/300x200/?night',
                            views: 561,
                            rating: 4.0
                        }
                    ]
                };
            } catch (relatedError) {
                console.warn('Could not load related stories:', relatedError);
                relatedData = { data: [] }; // Встановлюємо пустий масив, щоб не ламати інтерфейс
            }

            // Встановлюємо дані
            this.story = storyData;
            this.comments = commentsData.data || [];
            this.relatedStories = relatedData.data || [];
            this.author = storyData.author; // Якщо автор вже є в даних історії

            // Форматуємо дати коментарів з перевіркою правильності даних
            this.comments.forEach(c => {
                try {
                    const date = new Date(c.createdAt);
                    if (!isNaN(date.getTime())) {
                        c.date = date.toLocaleString(
                            $store.i18n?.selectedLang || 'uk-UA', 
                            { dateStyle: 'medium', timeStyle: 'short' }
                        );
                    } else {
                        c.date = this.safeT('general.unknownDate', {}, 'Невідома дата');
                    }
                } catch (error) {
                    console.warn('Date formatting error:', error);
                    c.date = this.safeT('general.unknownDate', {}, 'Невідома дата');
                }
                c.liked = false; // Початковий стан лайка
            });

            // Оновлюємо мета-теги
            this.updateMetaTags();

            // Завантажуємо статус взаємодії користувача, обробляємо помилку окремо
            if (this.isLoggedIn) {
                try {
                    await this.fetchUserInteractionStatus();
                } catch (statusError) {
                    console.warn('Could not load user interaction status:', statusError);
                    // Не кидаємо помилку, просто статуси залишаються false/0
                }
            }

        } catch (err) {
            this.error = err.message || this.safeT('story.errorLoadingStory', {}, 'Помилка завантаження історії');
            console.error('Fetch Story Error:', err);
        } finally {
            this.isLoading = false;
        }
    },
    // Завантаження статусів взаємодії користувача
    async fetchUserInteractionStatus() {
         try {
              console.log(`Fetching user interaction status for story ${this.storyId}`);
              const status = await api.users.getStoryInteractionStatus(this.storyId); // Потрібно реалізувати в api-utils
              this.liked = status.liked;
              this.bookmarked = status.bookmarked;
              this.userRating = status.rating || 0;
              if (this.author?._id) {
                  this.followed = await api.users.checkIfFollowing(this.author._id); // Потрібно реалізувати в api-utils
              }
              console.log('User interaction status loaded:', status, 'Following:', this.followed);
         } catch (statusError) {
             console.warn('Could not load user interaction status:', statusError);
             // Не кидаємо помилку, просто статуси залишаться false/0
         }
     },
    // (Опціонально) Завантаження статусів лайків коментарів
     async fetchCommentLikeStatuses() {
         if (!this.comments.length) return;
         const commentIds = this.comments.map(c => c._id);
         try {
             console.log('Fetching like statuses for comments:', commentIds);
             // Припускаємо, що API повертає об'єкт { commentId: true/false }
             const likeStatuses = await api.comments.getLikeStatuses(commentIds);
             this.comments.forEach(comment => {
                 if (likeStatuses[comment._id] !== undefined) {
                     comment.liked = likeStatuses[comment._id];
                 }
             });
             console.log('Comment like statuses updated');
         } catch (error) {
             console.warn('Could not fetch comment like statuses:', error);
         }
     },

    // --- Оновлення мета-тегів ---
    updateMetaTags() {
        if (!this.story) return;
        const ogTitleTag = document.querySelector('meta[property=\'og:title\']');
        const ogDescriptionTag = document.querySelector('meta[property=\'og:description\']');
        const ogImageTag = document.querySelector('meta[property=\'og:image\']');
        const descriptionTag = document.querySelector('meta[name=\'description\']');

        const siteName = safeT('general.copyright');
        const title = `${this.story.title} — ${siteName}`;
        const textContent = this.story.content ? this.story.content.replace(/<[^>]*>?/gm, '') : '';
        const excerpt = textContent.substring(0, 160) + '...';

        if (ogTitleTag) ogTitleTag.setAttribute('content', title);
        if (descriptionTag) descriptionTag.setAttribute('content', excerpt);
        if (ogDescriptionTag) ogDescriptionTag.setAttribute('content', excerpt);
        if (ogImageTag && this.story.imageUrl) ogImageTag.setAttribute('content', this.story.imageUrl);
    },

    // --- Функції взаємодії ---
    async toggleLike(event) {
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        if (!this.story) return;
        const button = event?.currentTarget; if (button) button.classList.add('removing');
        const originalLiked = this.liked;
        const originalLikes = this.story.likes || 0;
        // Оптимістичне оновлення
        this.liked = !this.liked;
        this.story.likes = Math.max(0, originalLikes + (this.liked ? 1 : -1));
        try {
            await api.stories.likeStory(this.storyId);
            this.showNotification(this.liked ? safeT('notifications.addedToLikes') : safeT('notifications.removedFromLikes'), true);
        } catch (err) {
            this.liked = originalLiked; this.story.likes = originalLikes; // Відкат
            this.showNotification(safeT('story.errorTogglingLike') + ': ' + (err.message || safeT('general.unknownError')), false);
            console.error('Like Error:', err);
        } finally { if (button) button.classList.remove('removing'); }
    },
    async setRating(rating) {
        if (!this.isLoggedIn) { 
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); 
            return; 
        }
        if (!this.story) return;
        
        const originalRating = this.userRating;
        const newRating = this.userRating === rating ? 0 : rating; // Дозволяємо скасувати оцінку повторним кліком
        
        // Запобіжник для випадку, коли container не існує
        const starsContainer = this.$refs.ratingStarsContainer;
        try {
            // Оптимістичне оновлення
            this.userRating = newRating;
            
            // Показуємо стан обробки, якщо контейнер існує
            if(starsContainer) starsContainer.style.opacity = '0.5';
            
            // API запит
            const response = await api.stories.rateStory(this.storyId, newRating);
            
            // Оновлюємо дані з відповіді API
            if (response && response.averageRating !== undefined && response.totalRatings !== undefined) {
                this.story.averageRating = response.averageRating;
                this.story.totalRatings = response.totalRatings;
            }
            
            this.showNotification(
                newRating > 0 ? 
                    this.safeT('notifications.ratingThanks', { rating: newRating }, `Дякуємо за оцінку ${newRating}/5!`) : 
                    this.safeT('notifications.ratingRemoved', {}, 'Оцінку видалено'), 
                true
            );
        } catch (err) {
            this.userRating = originalRating; // Відкат
            
            // Безпечне отримання повідомлення про помилку
            let errorMessage;
            try {
                errorMessage = this.safeT('story.errorSavingRating', {}, 'Помилка збереження оцінки') + 
                    ': ' + (err.message || this.safeT('general.unknownError', {}, 'Невідома помилка'));
            } catch (e) {
                errorMessage = 'Помилка збереження оцінки';
            }
            
            this.showNotification(errorMessage, false);
            console.error('Rating Error:', err);
        } finally { 
            // Безпечне відновлення прозорості
            if(starsContainer) {
                try {
                    starsContainer.style.opacity = '1';
                } catch (e) {
                    console.warn('Error resetting stars container opacity:', e);
                }
            }
        }
    },
    async toggleBookmark(event) {
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        if (!this.story) return;
        const button = event?.currentTarget; if (button) button.classList.add('removing');
        const originalBookmarked = this.bookmarked;
        this.bookmarked = !this.bookmarked; // Оптимістичне оновлення
        try {
            await api.users.toggleBookmark(this.storyId);
            this.showNotification(this.bookmarked ? safeT('notifications.addedToBookmarks') : safeT('notifications.removedFromBookmarks'), true);
        } catch (err) {
            this.bookmarked = originalBookmarked; // Відкат
            this.showNotification(safeT('story.errorTogglingBookmark') + ': ' + (err.message || safeT('general.unknownError')), false);
            console.error('Bookmark Error:', err);
        } finally { if (button) button.classList.remove('removing'); }
    },
    async toggleFollow(event) {
        if (!this.isLoggedIn) { 
            try {
                window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
            } catch (error) {
                console.error('Redirect error:', error);
                window.location.href = 'login.html'; // Запасний варіант
            }
            return; 
        }
        
        if (!this.author || !this.author._id) return;
        
        // Не дозволяємо підписуватись на себе
        if (this.author._id === this.userId) {
             this.showNotification(this.safeT('story.errorFollowSelf', {}, 'Ви не можете стежити за собою'), false);
             return;
        }
        
        // Використовуємо новий стан для показу індикатора завантаження
        this.isProcessingFollow = true;
        
        const originalFollowed = this.followed;
        const originalFollowers = this.author.followersCount || 0;
        
        // Оптимістичне оновлення
        this.followed = !this.followed;
        if (typeof this.author.followersCount === 'number') { 
            this.author.followersCount = Math.max(0, originalFollowers + (this.followed ? 1 : -1)); 
        }
        
        try {
            // Симуляція API запиту
            await new Promise(resolve => setTimeout(resolve, 500));
            
            this.showNotification(
                this.followed ? 
                    this.safeT('notifications.followingAuthor', {name: this.author.name}, `Ви тепер стежите за автором ${this.author.name}`) : 
                    this.safeT('notifications.unfollowingAuthor', {name: this.author.name}, `Ви більше не стежите за автором ${this.author.name}`), 
                true
            );
        } catch (err) {
            this.followed = originalFollowed; // Відкат
            if (typeof this.author.followersCount === 'number') { 
                this.author.followersCount = originalFollowers; 
            }
            
            this.showNotification(
                this.safeT('story.errorTogglingFollow', {}, 'Помилка зміни підписки') + 
                ': ' + (err.message || this.safeT('general.unknownError', {}, 'Невідома помилка')), 
                false
            );
            
            console.error('Follow Error:', err);
        } finally { 
            this.isProcessingFollow = false;
        }
    },
    // Покращена обробка помилок додавання коментаря
    async submitComment() {
        this.commentError = null;
        
        if (!this.isLoggedIn) { 
            try {
                window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
            } catch (error) {
                console.error('Redirect error:', error);
                window.location.href = 'login.html'; // Запасний варіант
            }
            return; 
        }
        
        // Перевірка наявності тексту
        const commentTextTrimmed = this.commentText.trim();
        if (!commentTextTrimmed) {
            this.commentError = this.safeT('story.errorCommentEmpty', {}, 'Будь ласка, введіть текст коментаря.');
            try {
                this.$nextTick(() => { 
                    const commentInput = this.$refs.commentInputRef;
                    if (commentInput) commentInput.focus(); 
                });
            } catch (focusError) {
                console.warn('Focus error:', focusError);
            }
            return;
        }
        
        // Перевірка на мінімальну довжину
        if (commentTextTrimmed.length < 3) {
            this.commentError = this.safeT('story.errorCommentTooShort', {}, 'Коментар занадто короткий.');
            try {
                this.$nextTick(() => { 
                    const commentInput = this.$refs.commentInputRef;
                    if (commentInput) commentInput.focus(); 
                });
            } catch (focusError) {
                console.warn('Focus error:', focusError);
            }
            return;
        }
        
        // Перевірка на максимальну довжину
        if (commentTextTrimmed.length > 1000) {
            this.commentError = this.safeT('story.errorCommentTooLong', {}, 'Коментар занадто довгий (максимум 1000 символів).');
            try {
                this.$nextTick(() => { 
                    const commentInput = this.$refs.commentInputRef;
                    if (commentInput) commentInput.focus(); 
                });
            } catch (focusError) {
                console.warn('Focus error:', focusError);
            }
            return;
        }
        
        if (!this.story) return;
        
        this.isSubmittingComment = true;
        
        try {
            const addedCommentData = await api.comments.createComment(this.storyId, commentTextTrimmed);
            
            // Форматуємо дату та додаємо стан лайка
            try {
                addedCommentData.date = new Date(addedCommentData.createdAt).toLocaleString(
                    $store.i18n?.selectedLang || 'uk-UA', 
                    { dateStyle: 'medium', timeStyle: 'short' }
                );
            } catch (dateError) {
                console.warn('Error formatting comment date:', dateError);
                addedCommentData.date = this.safeT('general.justNow', {}, 'Щойно');
            }
            
            addedCommentData.liked = false; // Новий коментар ще не лайкнутий
            this.comments.unshift(addedCommentData);
            this.commentText = '';
            
            if (this.story && typeof this.story.commentsCount === 'number') { 
                this.story.commentsCount++; 
            }
            
            this.showNotification(this.safeT('notifications.commentAdded', {}, 'Коментар додано успішно!'), true);
        } catch (err) {
            this.commentError = err.message || this.safeT('story.errorAddingComment', {}, 'Помилка додавання коментаря');
            console.error('Comment Submit Error:', err);
        } finally { 
            this.isSubmittingComment = false;
        }
    },
    async likeComment(commentId, event) {
        if (!this.isLoggedIn) { window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search); return; }
        const commentIndex = this.comments.findIndex(c => (c._id або c.id) === commentId);
        if (commentIndex === -1) return;

        const button = event?.currentTarget; if (button) button.classList.add('removing'); // Показуємо спінер

        const comment = this.comments[commentIndex];
        const originalLiked = comment.liked;
        const originalLikes = comment.likes або 0;
        // Оптимістичне оновлення
        this.comments[commentIndex].liked = !originalLiked;
        this.comments[commentIndex].likes = Math.max(0, originalLikes + (this.comments[commentIndex].liked ? 1 : -1));
        try {
            await api.comments.likeComment(commentId);
            // Сповіщення не показуємо, щоб не дратувати
        } catch (err) {
            this.comments[commentIndex].liked = originalLiked; // Відкат
            this.comments[commentIndex].likes = originalLikes;
            this.showNotification(safeT('story.errorLikingComment') + ': ' + (err.message або safeT('general.unknownError')), false);
            console.error('Comment Like Error:', err);
        } finally { if (button) button.classList.remove('removing'); }
    },
    // Безпечніше копіювання URL до буфера обміну
    async copyLink() {
        try {
            if (navigator.clipboard і typeof navigator.clipboard.writeText === 'function') {
                await navigator.clipboard.writeText(window.location.href);
                this.showNotification(this.safeT('general.copiedLink', {}, 'Посилання скопійовано!'), true);
            } else {
                // Запасний варіант для старіших браузерів
                const tempInput = document.createElement('input');
                tempInput.value = window.location.href;
                document.body.appendChild(tempInput);
                tempInput.select();
                
                if (document.execCommand('copy')) {
                    this.showNotification(this.safeT('general.copiedLink', {}, 'Посилання скопійовано!'), true);
                } else {
                    throw new Error('Копіювання не підтримується');
                }
                
                document.body.removeChild(tempInput);
            }
        } catch (err) {
            console.error('Copy Link Error:', err);
            this.showNotification(this.safeT('general.copyLinkError', {}, 'Не вдалося скопіювати посилання'), false);
        }
    },
     async translateStory() {
         if (!this.isPremiumUser) {
             this.showNotification(safeT('story.translationAvailableForPremium'), false);
             this.selectedLang = 'uk'; return;
         }
         if (this.selectedLang === 'uk') { this.translatedContent = null; this.translationError = null; return; }
         this.isTranslating = true; this.translationError = null; this.translatedContent = null;
         try {
             const originalContent = this.story?.content;
             if (!originalContent) throw new Error(safeT('story.errorNoContentForTranslation') або 'Немає контенту для перекладу.');

             console.log(`Translating story ${this.storyId} to ${this.selectedLang} (client-side translation disabled)`);
             // Кидаємо помилку, бо переклад має бути на бекенді
             throw new Error(safeT('story.errorTranslationClientSide') або 'Функція перекладу контенту виконується на сервері.');

             // --- Закоментований код для симуляції/майбутнього API ---
             // console.log(`API call: translateText to ${this.selectedLang}`);
             // await new Promise(resolve => setTimeout(resolve, 1000));
             // const translationResult = await api.translation.translateText(originalContent, this.selectedLang);
             // this.translatedContent = translationResult.translatedText;
             // --- Кінець ---

         } catch (error) {
             this.translationError = error.message або safeT('story.translationError');
             console.error('Translation error:', error);
             this.translatedContent = `<p style='color: #ff6b6b;'>${this.translationError}</p>`;
         } finally { this.isTranslating = false; }
     },
     // Безпечнiша функція для доступу до i18n перекладів
     safeT(key, params = {}, fallback = '') {
         try {
             if (!$store або !$store.i18n або typeof $store.i18n.t !== 'function') {
                 return fallback;
             }
             const translation = $store.i18n.t(key, params);
             return (translation і translation !== key) ? translation : fallback;
         } catch (error) {
             console.warn(`Translation error for key: ${key}`, error);
             return fallback;
         }
     },
     // Функція для форматування HTML зірок на основі числового рейтингу
     formatStars(rating) {
         if (!rating або isNaN(rating)) return '';
         
         const fullStars = Math.floor(rating);
         const hasHalfStar = rating - fullStars >= 0.5;
         const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
         
         let stars = '';
         
         // Додаємо заповнені зірки
         for (let i = 0; i < fullStars; i++) {
             stars += '<i class="fas fa-star"></i>';
         }
         
         // Додаємо напівзірку, якщо потрібно
         if (hasHalfStar) {
             stars += '<i class="fas fa-star-half-alt"></i>';
         }
         
         // Додаємо порожні зірки
         for (let i = 0; i < emptyStars; i++) {
             stars += '<i class="far fa-star"></i>';
         }
         
         return stars;
     },
     // Додаємо новий стан для відстеження процесу підписки
     isProcessingFollow: false

}" x-init="
    userId = api.utils.getUserId(); // Зберігаємо ID поточного користувача
    isLoggedIn = api.utils.isAuthenticated();
    isPremiumUser = api.utils.isPremium();
    // Синхронізуємо selectedLang з i18n store
    if (typeof $store !== 'undefined' і $store.i18n) {
        selectedLang = $store.i18n.selectedLang;
        availableLanguages = $store.i18n.available.map(lang => ({
            code: lang.code,
            name: lang.code === 'uk' ? `${safeT('story.translationOriginalUk') або 'Українська'} (Оригінал)` : lang.name
        }));
        // Спостерігаємо за зміною мови в store
        $watch('$store.i18n.selectedLang', (newLang) => {
            if (selectedLang !== newLang) {
                selectedLang = newLang;
                // Оновлюємо дати коментарів
                comments.forEach(c => c.date = new Date(c.createdAt).toLocaleString(selectedLang або 'uk-UA', { dateStyle: 'medium', timeStyle: 'short' }));
                // Можливо, скинути переклад при зміні мови сайту
                // if (selectedLang !== 'uk') translateStory(); else translatedContent = null;
            }
        });
    } else { console.warn('i18n store not available on init'); }
    // Запускаємо завантаження даних історії
    fetchStoryData();
">

<!-- Індикатор завантаження -->
<div x-show="isLoading" class="loading-indicator-overlay" x-transition.opacity>
  <div class="loading-spinner"></div>
</div>

<!-- Хедер -->
<header>
  <div class="container">
    <nav class="navbar">
      <a href="index.html" class="logo">Таємний<span>Світ</span></a>
      <ul class="nav-links">
        <li><a href="index.html" x-text="safeT('general.home')"></a></li>
        <li><a href="new-stories.html" x-text="safeT('general.newStories')"></a></li>
        <li><a href="top-stories.html" x-text="safeT('general.topStories')"></a></li>
        <li><a href="categories.html" x-text="safeT('general.categories')"></a></li>
        <li><a href="authors.html" x-text="safeT('general.authors')"></a></li>
      </ul>
      <div class="auth-buttons">
        <!-- Мовний перемикач з покращеною обробкою помилок -->
        <div class="lang-dropdown-container" x-data="{ open: false }" @click.away="open = false">
          <div class="lang-dropdown-button" @click="open = !open">
            <span x-text="$store.i18n?.selectedLang?.toUpperCase() або 'UK'"></span>
            <i class="fas fa-chevron-down" :class="{ 'rotate-180': open }"></i>
          </div>
          <div class="lang-dropdown-menu" x-show="open" x-transition>
            <template x-for="lang in $store.i18n?.available або []" :key="lang.code">
              <div class="lang-dropdown-item"
                   :class="{ 'active': lang.code === $store.i18n?.selectedLang }"
                   @click="try { 
                       $store.i18n.setLanguage(lang.code); 
                       open = false; 
                       // Оновлюємо дати коментарів
                       comments.forEach(c => {
                           try {
                               c.date = new Date(c.createdAt).toLocaleString(lang.code або 'uk-UA', 
                               { dateStyle: 'medium', timeStyle: 'short' });
                           } catch (error) {
                               console.warn('Date formatting error:', error);
                           }
                       });
                   } catch(e) { 
                       console.error('Error switching language:', e); 
                       open = false; 
                   }">
                <span x-text="lang.name"></span>
                <i x-show="lang.code === $store.i18n?.selectedLang" class="fas fa-check"></i>
              </div>
            </template>
          </div>
        </div>
        <!-- Кнопки входу/профілю -->
        <template x-if="!isLoggedIn">
          <div>
            <a href="login.html" class="btn btn-outline">
              <i class="fas fa-sign-in-alt"></i> <span x-text="safeT('general.login')"></span>
            </a>
            <a href="login.html?tab=register" class="btn btn-primary">
              <i class="fas fa-user-plus"></i> <span x-text="safeT('general.register')"></span>
            </a>
          </div>
        </template>
        <template x-if="isLoggedIn">
          <div>
            <a href="profile.html" class="btn btn-outline">
              <i class="fas fa-user"></i> <span x-text="safeT('general.profile')"></span>
            </a>
            <!-- Виправлений обробник виходу з безпечною обробкою помилок -->
            <a href="#" @click.prevent="
                try {
                    api.auth.logout();
                    isLoggedIn = false;
                    isPremiumUser = false;
                    window.location.reload();
                } catch (error) {
                    console.error('Logout error:', error);
                    showNotification(safeT('auth.logoutError', {}, 'Помилка при виході з системи'), false);
                }
            " class="btn btn-primary">
                <i class="fas fa-sign-out-alt"></i> <span x-text="$store.i18n.t('general.logout')"></span>
            </a>
          </div>
        </template>
      </div>
    </nav>
  </div>
</header>

<!-- Основний контент -->
<main class="container">
  <!-- Повідомлення про помилку завантаження -->
  <div x-show="error і !isLoading" class="error-message" style="margin: 2rem 0;">
    <i class="fas fa-exclamation-circle"></i> <span x-text="error"></span>
    <button @click="fetchStoryData()" class="btn btn-outline" x-text="safeT('general.retryButton')"></button>
  </div>

  <!-- Контент сторінки історії -->
  <template x-if="story і !isLoading і !error">
    <div>
      <!-- Хлібні крихти -->
      <div class="breadcrumbs">
        <a href="index.html" x-text="safeT('general.home')"></a>
        <span class="separator">/</span>
        <a href="categories.html" x-text="safeT('general.categories')"></a>
        <span class="separator">/</span>
        <a :href="`category-page.html?slug=${story.category?.slug або 'other'}`" x-text="story.category?.name або safeT('general.defaultCategory')"></a>
        <span class="separator">/</span>
        <span class="current" x-text="story.title"></span>
      </div>

      <!-- Структура сторінки -->
      <div class="story-page">
        <!-- Основний контент -->
        <div class="story-main">
          <!-- Заголовок історії -->
          <div class="story-header">
            <div class="story-category" x-text="story.category?.name або safeT('general.defaultCategory')"></div>
            <h1 class="story-title-main" x-text="story.title"></h1>
            <div class="story-meta-info">
              <div><i class="far fa-calendar-alt"></i> <span x-text="new Date(story.createdAt).toLocaleDateString($store.i18n.selectedLang або 'uk-UA', { day: 'numeric', month: 'long', year: 'numeric' })"></span></div>
              <div><i class="far fa-eye"></i> <span x-text="story.views"></span> <span x-text="safeT('general.views')"></span></div>
              <div><i class="far fa-clock"></i> <span x-text="story.readingTime"></span> <span x-text="safeT('general.readingTimeSuffix')"></span></div>
              <div><i class="far fa-comments"></i> <span x-text="comments.length"></span> <span x-text="safeT('general.comments')"></span></div>
            </div>

            <!-- Виправлений блок автора з обробкою помилок у шаблоні -->
            <template x-if="author">
              <div class="story-author">
                <a :href="author._id ? `author-profile.html?id=${author._id}` : '#'" style="display: contents;">
                  <div class="author-avatar" 
                       :style="`background-image: url('${author.avatarUrl або 'https://source.unsplash.com/random/100x100/?profile'}')`" 
                       role="img" 
                       :aria-label="`${safeT('story.avatarOf', {}, 'Аватар')} ${author.name або safeT('general.anonymous', {}, 'Анонімний автор')}`">
                  </div>
                </a>
                <div class="author-info">
                  <div class="author-name">
                    <a :href="author._id ? `author-profile.html?id=${author._id}` : '#'" style="color: inherit; text-decoration: none;" 
                       x-text="author.name або safeT('general.anonymous', {}, 'Анонімний автор')"></a>
                  </div>
                  <div class="author-bio" x-text="author.bio або safeT('authorsPage.bioMissing', {}, 'Інформація про автора відсутня')"></div>
                </div>
                <!-- Кнопка стеження -->
                <template x-if="author._id і isLoggedIn і userId !== author._id">
                  <button type="button" 
                          @click="toggleFollow($event)" 
                          class="btn btn-outline follow-btn" 
                          :class="{ 'following': followed }"
                          :disabled="!author">
                    <span x-text="followed ? 
                                  safeT('story.unfollowAuthor', {}, 'Відписатися') : 
                                  safeT('story.followAuthor', {}, 'Стежити')">
                    </span>
                  </button>
                </template>
                <template x-if="author._id і !isLoggedIn">
                  <a :href="'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search)" 
                     class="btn btn-outline follow-btn" 
                     x-text="safeT('story.followAuthor', {}, 'Стежити')">
                  </a>
                </template>
              </div>
            </template>
            <template x-if="!author"> <!-- Якщо автора немає -->
              <div class="story-author">
                <div class="author-avatar" style="background-image: url('https://source.unsplash.com/random/100x100/?profile-placeholder')"></div>
                <div class="author-info">
                  <div class="author-name" x-text="safeT('general.anonymous')"></div>
                  <div class="author-bio" x-text="safeT('authorsPage.bioMissing')"></div>
                </div>
              </div>
            </template>
          </div>

          <!-- Головне зображення -->
          <div class="story-featured-image" :style="`background-image: url('${story.imageUrl або 'https://source.unsplash.com/random/1200x600/?abstract'}')`">
            <div class="story-badge-large" x-text="story.ageRestriction"></div>
          </div>

          <!-- Оцінка і дії -->
          <div class="story-actions">
            <div class="story-rating">
              <div class="rating-score" x-text="(story.averageRating або 0).toFixed(1)"></div>
              <div class="rating-stars" x-ref="ratingStarsContainer"> <!-- Додав x-ref -->
                <template x-for="i in 5">
                  <i class="rating-star"
                     :class="i <= userRating ? 'fas fa-star' : 'far fa-star'"
                     @click="setRating(i)"
                     style="cursor: pointer;"
                     :aria-label="safeT('story.rateAriaLabel', { stars: i }) або `Оцінити на ${i} з 5`"></i>
                </template>
              </div>
              <div class="rating-count">
                (<span x-text="story.totalRatings або 0"></span> <span x-text="safeT('story.ratingCountSuffix')"></span>)
              </div>
            </div>
            <div class="story-buttons">
              <button type="button" class="action-btn" @click="toggleLike($event)" :title="liked ? safeT('story.likedStory') : safeT('story.likeStory')" :style="{ 'background-color': liked ? 'rgba(204, 0, 51, 0.2)' : '' }">
                <i :class="liked ? 'fas fa-heart' : 'far fa-heart'" style="color: var(--accent-red);"></i>
                <span x-text="story.likes або 0" style="margin-left: 5px; font-size: 0.9em;"></span>
              </button>
              <button type="button" class="action-btn" @click="toggleBookmark($event)" :title="bookmarked ? safeT('story.savedBookmark') : safeT('story.saveBookmark')" :style="{ 'background-color': bookmarked ? 'rgba(255, 255, 255, 0.1)' : '' }">
                <i :class="bookmarked ? 'fas fa-bookmark' : 'far fa-bookmark'"></i>
              </button>
              <button type="button" class="action-btn" @click="copyLink()" :title="safeT('general.copyLink')">
                <i class="fas fa-share-alt"></i>
              </button>
              <button type="button" class="action-btn" @click="showNotification(safeT('notifications.reportSent'), true)" :title="safeT('story.reportProblem')">
                <i class="fas fa-flag"></i>
              </button>
            </div>
          </div>

          <!-- Блок керування перекладом -->
          <template x-if="isPremiumUser"> <!-- Показуємо тільки преміум користувачам -->
            <div class="translation-controls">
              <span class="translation-label" x-text="safeT('story.translationLabel')"></span>
              <select class="translation-select" x-model="selectedLang" @change="translateStory()">
                <template x-for="lang in availableLanguages" :key="lang.code">
                  <option :value="lang.code" x-text="lang.name"></option>
                </template>
              </select>
              <div class="translation-status">
                <span x-show="isTranslating"><i class="fas fa-spinner fa-spin"></i> <span x-text="safeT('story.translationLoading')"></span></span>
                <span x-show="translationError" class="translation-error-inline"><i class="fas fa-exclamation-triangle"></i> <span x-text="translationError"></span></span>
                <span x-show="!isTranslating і !translationError і selectedLang !== 'uk'" x-text="safeT('story.translationShowing')"></span>
                <span x-show="!isTranslating і !translationError і selectedLang === 'uk'" x-text="safeT('story.translationOriginalShowing')"></span>
              </div>
            </div>
          </template>

          <!-- Контент історії -->
          <div class="story-content">
            <!-- Урізаний контент для не-преміум -->
            <template x-if="story.isPremium і !isPremiumUser">
              <div x-html="story.content.substring(0, Math.min(500, Math.floor(story.content.length * 0.3))) + '...'"></div>
              <div class="story-premium-notice">
                <h3 x-text="safeT('story.premiumContentBlocked')"></h3>
                <p x-text="safeT('story.premiumContentDescription')"></p>
                <a href="premium.html" class="btn btn-primary" x-text="safeT('story.getPremiumButton')"></a>
              </div>
            </template>
            <!-- Повний контент для преміум або не-преміум історій -->
            <template x-if="!story.isPremium або isPremiumUser">
              <!-- Перекладений контент -->
              <div x-show="selectedLang !== 'uk' і translatedContent" x-html="translatedContent"></div>
              <!-- Оригінальний контент -->
              <div x-show="selectedLang === 'uk' або !translatedContent" x-html="story.content"></div>
            </template>
          </div>


          <!-- Теги історії -->
          <div class="story-tags-section" x-show="story.tags і story.tags.length > 0">
            <h3 class="story-tags-title" x-text="safeT('story.tagsLabel')"></h3>
            <div class="story-tags-list">
              <template x-for="tag in story.tags" :key="tag">
                <a href="#" @click.prevent="window.location.href=`categories.html?search=${encodeURIComponent(tag)}`" class="story-tag-link" x-text="tag"></a>
              </template>
            </div>
          </div>

          <!-- Навігація між історіями (заглушка) -->
          <div class="story-navigation">
            <a href="#" class="prev-story" style="opacity: 0.5; pointer-events: none;" aria-hidden="true">
              <div class="prev-story-icon"><i class="fas fa-chevron-left"></i></div>
              <div>
                <span class="nav-direction" x-text="safeT('story.prevStoryLink')"></span>
                <h4 class="nav-title" x-text="safeT('story.noPrevStory')"></h4>
              </div>
            </a>
            <a href="#" class="next-story" style="opacity: 0.5; pointer-events: none;" aria-hidden="true">
              <div>
                <span class="nav-direction" x-text="safeT('story.nextStoryLink')"></span>
                <h4 class="nav-title" x-text="safeT('story.noNextStory')"></h4>
              </div>
              <div class="next-story-icon"><i class="fas fa-chevron-right"></i></div>
            </a>
          </div>

          <!-- Коментарі -->
          <div class="comments-section">
            <h2 class="comments-title"><span x-text="safeT('story.commentsTitle')"></span> (<span x-text="comments.length"></span>)</h2>
            <div class="comment-form" x-show="isLoggedIn">
              <textarea x-model="commentText" class="comment-input" :placeholder="safeT('story.leaveCommentPlaceholder')" :disabled="isSubmittingComment" aria-label="Текст коментаря" x-ref="commentInputRef"></textarea>
              <div x-show="commentError" class="error-message-inline" x-text="commentError"></div>
              <div class="comment-submit">
                <button type="button" @click="submitComment()" class="btn btn-primary" :class="{ 'processing': isSubmittingComment }" :disabled="isSubmittingComment або !commentText.trim()">
                  <span x-show="!isSubmittingComment" x-text="safeT('story.addCommentButton')"></span>
                  <span x-show="isSubmittingComment"><i class="fas fa-spinner fa-spin"></i> <span x-text="safeT('general.adding')"></span></span>
                </button>
              </div>
            </div>
            <div class="comment-form" x-show="!isLoggedIn" style="text-align: center; padding: 1rem; background-color: rgba(255,255,255,0.05); border-radius: var(--border-radius);">
              <p style="margin-bottom: 1rem; color: var(--secondary-text);">
                <span x-text="safeT('story.loginToComment')"></span>
                <a :href="'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search)" style="color: var(--accent-red);" x-text="safeT('general.login')"></a>
                <span x-text="safeT('general.or')"></span>
                <a href="login.html?tab=register" style="color: var(--accent-red);" x-text="safeT('general.register')"></a>.
              </p>
            </div>

            <div class="comments-list">
              <template x-for="comment in comments" :key="comment.id або comment._id">
                <div class="comment">
                  <div class="comment-avatar" :style="`background-image: url('${comment.author?.avatarUrl або 'https://source.unsplash.com/random/100x100/?face'}')`" role="img" :aria-label="`${safeT('story.avatarOf') або 'Аватар'} ${comment.author?.name}`"></div>
                  <div class="comment-body">
                    <div class="comment-author" x-text="comment.author?.name або safeT('general.anonymous')"></div>
                    <div class="comment-date" x-text="comment.date або new Date(comment.createdAt).toLocaleString($store.i18n.selectedLang або 'uk-UA', { dateStyle: 'medium', timeStyle: 'short' })"></div>
                    <div class="comment-text" x-text="comment.text"></div>
                    <div class="comment-actions">
                      <a href="#" @click.prevent="likeComment(comment.id або comment._id, $event)" :aria-label="comment.liked ? safeT('story.unlikeCommentAriaLabel') : safeT('story.likeCommentAriaLabel')">
                        <i :class="comment.liked ? 'fas fa-thumbs-up' : 'far fa-thumbs-up'"></i>
                        <span x-text="safeT('story.likeCommentAction')"></span> (<span x-text="comment.likes або 0"></span>)
                      </a>
                      <a href="#" @click.prevent="alert(safeT('story.replyWIP') або 'Функція відповіді в розробці')"><i class="far fa-comment"></i> <span x-text="safeT('story.replyButton')"></span></a>
                    </div>
                  </div>
                </div>
              </template>
              <div x-show="comments.length === 0 і !isLoading" style="text-align: center; color: var(--secondary-text); padding: 1rem;" x-text="safeT('story.noCommentsYet')">
              </div>
            </div>
          </div>
        </div>

        <!-- Сайдбар -->
        <div class="story-sidebar">
          <!-- Віджет автора -->
          <template x-if="author">
            <div class="sidebar-widget author-widget">
              <a :href="author._id ? `author-profile.html?id=${author._id}` : '#'" style="display: contents;">
                <div class="author-avatar-large" :style="`background-image: url('${author.avatarUrl або 'https://source.unsplash.com/random/200x200/?profile'}')`" role="img" :aria-label="`${safeT('story.avatarOf') або 'Аватар'} ${author.name}`"></div>
              </a>
              <h3 class="author-name-large">
                <a :href="author._id ? `author-profile.html?id=${author._id}` : '#'" style="color: inherit; text-decoration: none;" x-text="author.name або safeT('general.anonymous')"></a>
              </h3>
              <div class="author-stats">
                <div class="author-stat">
                  <div class="stat-value" x-text="author.storyCount або 0"></div>
                  <div class="stat-label" x-text="safeT('profile.storiesWritten')"></div>
                </div>
                <div class="author-stat">
                  <div class="stat-value" x-text="(author.averageRating або 0).toFixed(1)"></div>
                  <div class="stat-label" x-text="safeT('general.ratingLabel')"></div>
                </div>
                <div class="author-stat">
                  <div class="stat-value" x-text="author.followersCount або 0"></div>
                  <div class="stat-label" x-text="safeT('profile.followers')"></div>
                </div>
              </div>
              <template x-if="author._id і isLoggedIn і userId !== author._id">
                <button type="button" @click="toggleFollow($event)" class="btn btn-primary follow-btn" :class="{ 'following': followed }" style="width: 100%;" :disabled="!author">
                  <span x-show="!isProcessingFollow" x-text="followed ? safeT('story.unfollowAuthor') : safeT('story.followAuthor')"></span>
                  <span x-show="isProcessingFollow"><i class="fas fa-spinner fa-spin"></i> <span x-text="safeT('general.processing')"></span></span>
                </button>
              </template>
              <template x-if="author._id і !isLoggedIn">
                <a :href="'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search)" class="btn btn-primary" style="width: 100%;" x-text="safeT('story.followAuthor')"></a>
              </template>
            </div>
          </template>

          <!-- Віджет підписки -->
          <template x-if="!isPremiumUser">
            <div class="sidebar-widget premium-widget">
              <div class="premium-icon"><i class="fas fa-crown"></i></div>
              <h3 class="premium-title" x-text="safeT('premium.sidebarTitle') або 'Преміум доступ'"></h3>
              <p class="premium-description" x-text="safeT('premium.sidebarDescription') або 'Відкрийте найгарячіші моменти історії та ексклюзивний контент'"></p>
              <div class="premium-price" x-text="safeT('premium.sidebarPrice') або '199 ₴'"></div>
              <span class="price-period" x-text="safeT('premium.perMonth')"></span>
              <div class="premium-features">
                <div class="premium-feature"><i class="fas fa-check"></i><div x-text="safeT('premium.benefitAccess')"></div></div>
                <div class="premium-feature"><i class="fas fa-check"></i><div x-text="safeT('premium.benefitExclusive')"></div></div>
                <div class="premium-feature"><i class="fas fa-check"></i><div x-text="safeT('premium.benefitNoAds')"></div></div>
                <div class="premium-feature"><i class="fas fa-check"></i><div x-text="safeT('premium.benefitTranslation')"></div></div>
              </div>
              <a href="premium.html" class="btn btn-primary" style="width: 100%;" x-text="safeT('premium.sidebarButton') або 'Спробувати преміум'"></a>
            </div>
          </template>

          <!-- Віджет схожих історій -->
          <div class="sidebar-widget" x-show="relatedStories.length > 0">
            <h3 class="widget-title" x-text="safeT('story.similarStories')"></h3>
            <div class="related-stories-list">
              <template x-for="related in relatedStories" :key="related.id">
                <a :href="`story-detailed.html?id=${related.id}`" class="related-story">
                  <div class="related-story-image" :style="`background-image: url('${related.imageUrl}')`" role="img" :aria-label="related.title"></div>
                  <div class="related-story-info">
                    <h4 class="related-story-title" x-text="related.title"></h4>
                    <div class="related-story-meta">
                      <div class="related-story-views"><i class="far fa-eye"></i> <span x-text="related.views"></span></div>
                      <div class="related-story-rating"><i class="fas fa-star"></i> <span x-text="(related.rating або 0).toFixed(1)"></span></div>
                    </div>
                  </div>
                </a>
              </template>
            </div>
          </div>

          <!-- Віджет поділитися -->
          <div class="sidebar-widget">
            <h3 class="widget-title" x-text="safeT('story.shareStoryTitle')"></h3>
            <p x-text="safeT('story.shareStoryText')"></p>
            <div class="share-buttons">
              <a href="#" @click.prevent="window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`, '_blank', 'width=600,height=400')" class="share-button share-facebook" :title="safeT('general.shareFacebook')" :aria-label="safeT('general.shareFacebook')"><i class="fab fa-facebook-f"></i></a>
              <a href="#" @click.prevent="window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(story.title)}`, '_blank', 'width=600,height=400')" class="share-button share-twitter" :title="safeT('general.shareTwitter')" :aria-label="safeT('general.shareTwitter')"><i class="fab fa-twitter"></i></a>
              <a href="#" @click.prevent="window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(story.title)}`, '_blank')" class="share-button share-telegram" :title="safeT('general.shareTelegram')" :aria-label="safeT('general.shareTelegram')"><i class="fab fa-telegram-plane"></i></a>
              <a :href="`https://api.whatsapp.com/send?text=${encodeURIComponent(story.title + ' ' + window.location.href)}`" target="_blank" class="share-button share-whatsapp" :title="safeT('general.shareWhatsApp')" :aria-label="safeT('general.shareWhatsApp')"><i class="fab fa-whatsapp"></i></a>
              <button type="button" @click.prevent="copyLink()" class="share-button share-link" :title="safeT('general.copyLink')" :aria-label="safeT('general.copyLink')"><i class="fas fa-link"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
</main>

<!-- Footer -->
<footer>
  <div class="container">
    <!-- Код футера як у index.html -->
    <div class="footer-content">
      <div class="footer-section footer-about">
        <h4 x-text="safeT('general.about')"></h4>
        <p x-text="safeT('general.aboutText')"></p>
        <div class="social-links">
          <a href="#" class="social-link" :title="safeT('general.shareFacebook')"><i class="fab fa-facebook-f"></i></a>
          <a href="#" class="social-link" :title="safeT('general.shareTelegram')"><i class="fab fa-telegram-plane"></i></a>
          <a href="#" class="social-link" title="Instagram"><i class="fab fa-instagram"></i></a>
        </div>
      </div>
      <div class="footer-section">
        <h4 x-text="safeT('general.navigation')"></h4>
        <ul>
          <li><a href="index.html" x-text="safeT('general.home')"></a></li>
          <li><a href="categories.html" x-text="safeT('general.categories')"></a></li>
          <li><a href="new-stories.html" x-text="safeT('general.newStories')"></a></li>
          <li><a href="top-stories.html" x-text="safeT('general.topStories')"></a></li>
          <li><a href="authors.html" x-text="safeT('general.authors')"></a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4 x-text="safeT('general.support')"></h4>
        <ul>
          <li><a href="faq.html" x-text="safeT('faq.title')"></a></li>
          <li><a href="contact.html" x-text="safeT('contact.title')"></a></li>
          <li><a href="terms-page.html" x-text="safeT('general.terms')"></a></li>
          <li><a href="privacy-policy.html" x-text="safeT('general.privacy')"></a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4 x-text="safeT('general.join')"></h4>
        <ul>
          <li><a href="login.html" x-text="safeT('general.login')"></a></li>
          <li><a href="login.html?tab=register" x-text="safeT('general.register')"></a></li>
          <li><a href="premium.html" x-text="safeT('general.premium')"></a></li>
          <li><a href="create_story.html" x-text="safeT('createStory.title')"></a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      © <span x-text="new Date().getFullYear()"></span> <span x-text="safeT('general.copyright')"></span>. <span x-text="safeT('general.allRightsReserved')"></span>. 18+ <br>
      <a href="terms-page.html" x-text="safeT('general.terms')"></a> | <a href="privacy-policy.html" x-text="safeT('general.privacy')"></a>
    </div>
  </div>
</footer>

<!-- Правильний елемент сповіщення з класами для різних типів -->
<div x-show="notificationVisible"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 transform translate-y-2"
     x-transition:enter-end="opacity-100 transform translate-y-0"
     x-transition:leave="transition ease-in duration-300"
     x-transition:leave-start="opacity-100 transform translate-y-0"
     x-transition:leave-end="opacity-0 -translate-y-full"
     class="notification"
     :class="{ 'show': notificationVisible, 'success': notificationType === 'success', 'error': notificationType === 'error' }"
     style="display: none;"
     id="global-notification">
  <span x-text="notificationMessage"></span>
</div>

</body>
</html>